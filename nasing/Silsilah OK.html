<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silsilah Keluarga Puang Guru Nasing</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- 1. VARIABLE & GLOBAL STYLES --- */
		
		
		
		/* --- 1. VARIABLE & GLOBAL STYLES --- */
:root {
    /* Warna Default (Light Mode) */
    --bg-color: #f4f7f6;
    --card-bg: #ffffff;
    --primary: #3498db;
    --primary-dark: #2980b9;
    --text-dark: #2c3e50;
    --text-muted: #95a5a6;
    --border-radius: 8px;
    --shadow: 0 2px 10px rgba(0,0,0,0.05);
    --node-border: #bdc3c7;
    --level-0-bg: #ecf0f1;
    --strong-text: #34495e;
}

/* Konfigurasi Warna Dark Mode */
[data-theme="dark"] {
    --bg-color: #121212;
    --card-bg: #1e1e1e;
    --text-dark: #e0e0e0;
    --text-muted: #a0a0a0;
    --shadow: 0 2px 10px rgba(0,0,0,0.5);
    --node-border: #444;
    --level-0-bg: #2c3e50;
    --strong-text: #bdc3c7;
}

* { box-sizing: border-box; margin: 0; padding: 0; transition: background-color 0.3s, color 0.3s; }

/* ... (kode body dan container tetap sama) ... */

/* GANTI STYLE HEADER AGAR BISA ADA TOMBOL DI SAMPING */
header { margin-bottom: 40px; }

/* Wrapper untuk mensejajarkan Judul dan Tombol */
.title-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px; /* Jarak antara judul dan tombol */
    margin-bottom: 5px;
}

h4 { color: var(--text-dark); font-size: 1.2rem; margin: 0; } /* Judul jadi h4 */
p.subtitle { color: var(--text-muted); font-size: 0.9rem; text-align: center; }

/* Style Tombol Switch */
.theme-toggle {
    background: transparent;
    border: 1px solid var(--text-muted);
    color: var(--text-dark);
    width: 32px; height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 1rem;
}
.theme-toggle:hover { background: var(--primary); color: white; border-color: var(--primary); }

/* Update warna Node Card agar support Dark Mode */
.node-card {
    background: var(--card-bg);
    /* ... kode lainnya tetap ... */
    border-left: 5px solid var(--node-border); /* Gunakan variabel */
}

/* Update warna Level 0 */
.level-0 { border-left-color: var(--text-dark); background: var(--level-0-bg); }

/* Update warna teks strong (agar terbaca di dark mode) */
.parent-label strong { color: var(--strong-text); }
		
		

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-dark);
            padding: 20px;
            line-height: 1.5;
        }

        .container { max-width: 900px; margin: 0 auto; padding-bottom: 80px; }

        header { text-align: center; margin-bottom: 40px; }
h4 { color: var(--text-dark); margin-bottom: 5px; font-size: 1.2rem; } /* Ubah h1 jadi h4 */
p.subtitle { color: var(--text-muted); font-size: 0.9rem; }

        #loader { display: flex; flex-direction: column; align-items: center; margin-top: 60px; }
        .spinner {
            width: 40px; height: 40px; 
            border: 4px solid #ddd; border-top-color: var(--primary); 
            border-radius: 50%; animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .tree-root ul { list-style: none; padding-left: 22px; border-left: 2px dashed #dcdcdc; }
        .tree-root > ul { padding-left: 0; border-left: none; } 

        .node-wrapper { margin: 12px 0; }

        .node-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex; align-items: flex-start;
            border-left: 5px solid #bdc3c7;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .node-card:hover { transform: translateX(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        .level-0 { border-left-color: #2c3e50; background: #ecf0f1; }
        .level-1 { border-left-color: #2980b9; }
        .level-2 { border-left-color: #16a085; }
        .level-3 { border-left-color: #f39c12; }
        .level-4 { border-left-color: #8e44ad; }

        .node-content { flex-grow: 1; cursor: pointer; padding-left: 10px; }
        
        .parent-label {
            display: block; font-size: 0.7rem; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 2px;
        }
        .parent-label strong { color: #34495e; }
        
        .name-text { font-size: 1.1rem; font-weight: 700; display: block; margin-bottom: 5px; }

        .spouse-tags { display: flex; flex-wrap: wrap; gap: 5px; }
        .tag {
            font-size: 0.75rem; padding: 2px 8px; border-radius: 12px;
            background: #fce4ec; color: #c2185b; border: 1px solid #f8bbd0;
            display: inline-flex; align-items: center;
        }
        .tag i { margin-right: 4px; font-size: 0.7rem; }

        .toggle-btn {
            background: none; border: none; width: 20px; margin-top: 5px;
            cursor: pointer; font-size: 1rem; color: #ccc; transition: 0.3s;
        }
        .has-children .toggle-btn { color: var(--text-dark); }
        .expanded .toggle-btn { transform: rotate(90deg); }

        .actions {
            display: flex; gap: 5px; opacity: 0.1; transition: 0.3s; align-self: center; margin-left: 10px;
        }
        .node-card:hover .actions { opacity: 1; }

        .btn-icon {
            width: 30px; height: 30px; border-radius: 50%; border: none;
            background: #f0f2f5; color: #7f8c8d; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .btn-icon:hover { background: var(--primary); color: white; }
        .btn-del:hover { background: #e74c3c; color: white; }

        .children-container { display: none; }
        .children-container.open { display: block; animation: slideDown 0.3s; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(2px);
        }
        
        .modal {
            background: white; width: 90%; max-width: 500px;
            border-radius: 12px; padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: 90vh; overflow-y: auto;
        }

        .modal h3 { margin-top: 0; color: var(--primary-dark); border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; }
        .form-group input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; }
        .form-group input:focus { outline: none; border-color: var(--primary); }
        
        .helper-text { font-size: 0.75rem; color: #999; margin-top: 3px; }

        /* Checkbox Style */
        .checkbox-wrapper {
            display: flex; align-items: center; gap: 10px;
            background: #f9f9f9; padding: 10px; border-radius: 6px;
            border: 1px solid #eee; margin-bottom: 10px;
        }
        .checkbox-wrapper input[type="checkbox"] { transform: scale(1.2); cursor: pointer; }
        .checkbox-wrapper label { margin-bottom: 0; cursor: pointer; }

        .spouse-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .btn-remove {
            background: #ffebee; color: #c0392b; border: 1px solid #ffcdd2;
            width: 40px; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-remove:hover { background: #ffcdd2; }
        
        .btn-add-row {
            width: 100%; padding: 8px; background: #e3f2fd; color: #1976d2;
            border: 1px dashed #64b5f6; border-radius: 6px; cursor: pointer; font-weight: 600;
        }
        .btn-add-row:hover { background: #bbdefb; }

        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; border-top: 1px solid #eee; padding-top: 15px; }
        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; }
        .btn-cancel { background: #ecf0f1; color: #333; }
        .btn-save { background: var(--primary); color: white; }
        .btn-save:hover { background: var(--primary-dark); }

        /* Helper untuk sembunyikan area pasangan */
        .hidden { display: none; }

    </style>
</head>
<body>

<div class="container">
<header>
    <div class="title-wrapper">
        <h4>Silsilah Puang Guru Nasing</h4>
        <button id="theme-btn" class="theme-toggle" title="Ganti Mode Gelap/Terang">
            <i class="fas fa-moon"></i>
        </button>
    </div>
    <p class="subtitle">Aplikasi Silsilah Keluarga Interaktif</p>
</header>

    <div id="loader">
        <div class="spinner"></div>
        <p>Menghubungkan ke Database...</p>
    </div>

    <div id="tree-root" class="tree-root"></div>
</div>

<datalist id="all-members-list"></datalist>

<div id="modal" class="modal-overlay">
    <div class="modal">
        <h3 id="modal-title">Form Data</h3>
        
        <input type="hidden" id="inp-mode">
        <input type="hidden" id="inp-id">
        <input type="hidden" id="inp-parent">

        <div class="form-group">
            <label>Nama Lengkap</label>
            <input type="text" id="inp-name" placeholder="Masukkan Nama" autocomplete="off">
        </div>

        <div class="form-group">
            <label>Pasangan Orang Tua</label>
            <div id="mother-input-wrapper">
                <input type="text" id="inp-mother" list="all-members-list" placeholder="Cari atau ketik nama..." autocomplete="off">
            </div>
            <div class="helper-text">Otomatis disarankan dari pasangan Ayah, atau cari dari seluruh keluarga.</div>
        </div>

        <div class="form-group">
            <label>Status Pernikahan</label>
            <div class="checkbox-wrapper">
                <input type="checkbox" id="chk-married" onchange="toggleSpouseSection()">
                <label for="chk-married">Sudah Menikah</label>
            </div>
            
            <div id="spouse-section" class="hidden">
                <div class="helper-text" style="margin-bottom:8px;">Masukkan nama pasangan (bisa lebih dari satu).</div>
                <div id="spouse-container"></div>
                <button type="button" class="btn-add-row" onclick="addSpouseRow()">+ Tambah Pasangan</button>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-cancel" onclick="closeModal()">Batal</button>
            <button class="btn btn-save" onclick="submitData()">Simpan</button>
        </div>
    </div>
</div>

<script>
    // ==============================================================
    // KONFIGURASI: PASTIKAN URL SCRIPT ANDA BENAR
    // Link ini diambil dari file yang Anda upload sebelumnya
    const API_URL = "https://script.google.com/macros/s/AKfycbxaOo9p7QZHNNBNqt-s7_CPHh_J8672SRAVkSxUv0VljwovwN4zaYx9bkoL_VtB1dTB/exec";
    // ==============================================================

    let allData = [];

    window.onload = function() {
        fetchData();
    };

    async function fetchData() {
        showLoader(true);
        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            allData = data;
            updateAllMembersList();
            renderTree();
            showLoader(false);
        } catch (error) {
            alert("Gagal mengambil data: " + error);
            showLoader(false);
        }
    }

    async function postData(payload) {
        showLoader(true);
        closeModal();
        try {
            const response = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            allData = data; 
            updateAllMembersList();
            renderTree();
            showLoader(false);
        } catch (error) {
            alert("Gagal menyimpan: " + error);
            showLoader(false);
        }
    }

    function showLoader(show) {
        document.getElementById('loader').style.display = show ? 'flex' : 'none';
        document.getElementById('tree-root').style.display = show ? 'none' : 'block';
    }

    function updateAllMembersList() {
        const datalist = document.getElementById('all-members-list');
        datalist.innerHTML = ''; 
        const uniqueNames = new Set();

        allData.forEach(person => {
            if(person.name && person.name.trim()) uniqueNames.add(person.name.trim());
            if(person.spouse && person.spouse.trim()) {
                person.spouse.split(',').forEach(s => {
                    if(s.trim()) uniqueNames.add(s.trim());
                });
            }
        });
        
        Array.from(uniqueNames).sort().forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            datalist.appendChild(option);
        });
    }

    // --- TREE RENDERING ---
    function renderTree() {
        const container = document.getElementById('tree-root');
        container.innerHTML = '';
        const roots = allData.filter(d => !d.parentId || d.parentId === "" || d.id === 'root');
        const ul = document.createElement('ul');
        roots.forEach(root => ul.appendChild(createNode(root, 0)));
        container.appendChild(ul);
    }

    function createNode(person, level) {
        const li = document.createElement('li');
        li.className = 'node-wrapper';


// BARU: Cari anak berdasarkan ID Ayah ATAU Nama Ibu
    const children = allData.filter(d => 
        d.parentId == person.id || 
        (d.motherName && d.motherName.trim() === person.name)
    );
    // -----------------------

        const hasChildren = children.length > 0;

        let parentLabel = `<span class="parent-label" style="color:var(--primary)">â˜… Leluhur Utama</span>`;
        
        // --- BAGIAN LOGIKA BARU: Penentuan Nama Ibu Otomatis ---
        if (person.parentId && person.parentId !== 'root') {
            const father = allData.find(d => d.id === person.parentId);
            const fatherName = father ? father.name : "???";
            
            let motherName = "";
            
            // 1. Jika field motherName di data anak terisi, pakai itu
            if (person.motherName && person.motherName.trim() !== "") {
                motherName = person.motherName;
            } 
            // 2. Jika kosong, otomatis ambil dari Spouse Ayah (jika ada)
            else if (father && father.spouse && father.spouse.trim() !== "") {
                motherName = father.spouse; 
            } 
            // 3. Fallback jika tidak ada data sama sekali
            else {
                motherName = "(pasangan)";
            }

            parentLabel = `<span class="parent-label">Anak dari: <strong>${fatherName}</strong> & <strong>${motherName}</strong></span>`;
        }
        // -------------------------------------------------------

        let spouseHtml = '';
        if (person.spouse) {
            const spouses = person.spouse.split(',').map(s => s.trim()).filter(s => s);
            if(spouses.length > 0) {
                spouseHtml = `<div class="spouse-tags">`;
                spouses.forEach(s => {
                    spouseHtml += `<span class="tag"><i class="fas fa-heart"></i> ${s}</span>`;
                });
                spouseHtml += `</div>`;
            }
        }

        const div = document.createElement('div');
        div.className = `node-card level-${level}`;
        if (hasChildren) div.classList.add('has-children');

        const toggleIcon = hasChildren ? '<i class="fas fa-chevron-right"></i>' : '<i class="fas fa-circle" style="font-size:0.4em; opacity:0.3"></i>';

        div.innerHTML = `
            <button class="toggle-btn" onclick="toggleChild(this)">${toggleIcon}</button>
            <div class="node-content" onclick="toggleChild(this.previousElementSibling)">
                ${parentLabel}
                <span class="name-text">${person.name}</span>
                ${spouseHtml}
            </div>
            <div class="actions">
                <button class="btn-icon" onclick="openModal('edit', '${person.id}')" title="Edit"><i class="fas fa-pen"></i></button>
                <button class="btn-icon" onclick="openModal('add', '${person.id}')" title="Tambah Anak"><i class="fas fa-plus"></i></button>
                ${level > 0 ? `<button class="btn-icon btn-del" onclick="deleteItem('${person.id}')" title="Hapus"><i class="fas fa-trash"></i></button>` : ''}
            </div>
        `;

        li.appendChild(div);

        if (hasChildren || true) {
            const childUl = document.createElement('ul');
            childUl.className = 'children-container';
            if (level === 0) {
                childUl.classList.add('open');
                div.classList.add('expanded');
                div.querySelector('.toggle-btn').innerHTML = '<i class="fas fa-chevron-down"></i>';
            }
            children.forEach(child => childUl.appendChild(createNode(child, level + 1)));
            li.appendChild(childUl);
        }
        return li;
    }

    function toggleChild(btn) {
        const card = btn.parentElement;
        const ul = card.parentElement.querySelector('.children-container');
        if (ul && ul.children.length > 0) {
            ul.classList.toggle('open');
            card.classList.toggle('expanded');
            const isOpen = ul.classList.contains('open');
            btn.innerHTML = isOpen ? '<i class="fas fa-chevron-down"></i>' : '<i class="fas fa-chevron-right"></i>';
        }
    }

    // --- FORM LOGIC BARU DENGAN CHECKBOX ---

    function toggleSpouseSection() {
        const isMarried = document.getElementById('chk-married').checked;
        const section = document.getElementById('spouse-section');
        const container = document.getElementById('spouse-container');

        if (isMarried) {
            section.classList.remove('hidden');
            // Jika dicentang tapi belum ada input field, tambah satu
            if (container.children.length === 0) {
                addSpouseRow();
            }
        } else {
            section.classList.add('hidden');
            // Kita tidak menghapus isi container agar jika user tidak sengaja uncheck, datanya masih ada saat di-check lagi (sebelum disimpan).
        }
    }

    function addSpouseRow(value = "") {
        const container = document.getElementById('spouse-container');
        const div = document.createElement('div');
        div.className = 'spouse-row';
        div.innerHTML = `
            <input type="text" class="inp-spouse-dynamic" list="all-members-list" value="${value}" placeholder="Cari atau ketik Nama Pasangan..." autocomplete="off">
            <button type="button" class="btn-remove" onclick="this.parentElement.remove()" title="Hapus"><i class="fas fa-times"></i></button>
        `;
        container.appendChild(div);
    }

    function openModal(mode, id) {
        const modal = document.getElementById('modal');
        modal.style.display = 'flex';
        
        document.getElementById('inp-mode').value = mode;
        const spouseContainer = document.getElementById('spouse-container');
        spouseContainer.innerHTML = ''; // Reset container pasangan
        
        // Reset fields
        document.getElementById('inp-name').value = '';
        document.getElementById('inp-mother').value = '';
        document.getElementById('inp-parent').value = '';
        
        // Default status pernikahan: Belum (Unchecked)
        document.getElementById('chk-married').checked = false;

        if (mode === 'add') {
            document.getElementById('modal-title').innerText = "Tambah Keturunan";
            document.getElementById('inp-parent').value = id; 
            
            // Cari Data Ayah untuk Auto-fill Ibu
            const father = allData.find(d => d.id == id);
            if (father && father.spouse) {
                const spouses = father.spouse.split(',').filter(s => s.trim());
                if (spouses.length === 1) {
                    document.getElementById('inp-mother').value = spouses[0].trim();
                }
            }
            
            // Saat tambah anak baru, defaultnya belum menikah
            toggleSpouseSection(); 

        } else {
            document.getElementById('modal-title').innerText = "Edit Data";
            const p = allData.find(d => d.id == id);
            
            document.getElementById('inp-id').value = id;
            document.getElementById('inp-name').value = p.name;
            document.getElementById('inp-mother').value = p.motherName || '';

            // Cek apakah sudah ada data pasangan
            if (p.spouse && p.spouse.trim() !== "") {
                document.getElementById('chk-married').checked = true;
                p.spouse.split(',').forEach(s => addSpouseRow(s.trim()));
            } else {
                document.getElementById('chk-married').checked = false;
            }
            
            toggleSpouseSection();
        }
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }

    function submitData() {
        const mode = document.getElementById('inp-mode').value;
        const isMarried = document.getElementById('chk-married').checked;
        
        let spouseString = "";

        // Hanya ambil data pasangan jika checkbox dicentang
        if (isMarried) {
            const spouseInputs = document.querySelectorAll('.inp-spouse-dynamic');
            const spouseList = [];
            spouseInputs.forEach(inp => {
                if (inp.value.trim() !== "") spouseList.push(inp.value.trim());
            });
            spouseString = spouseList.join(', ');
        } else {
            // Jika tidak dicentang (Belum Menikah), kirim string kosong
            spouseString = "";
        }
        
        const payload = {
            action: mode,
            name: document.getElementById('inp-name').value,
            spouse: spouseString,
            motherName: document.getElementById('inp-mother').value
        };

        if (!payload.name) { alert("Nama wajib diisi!"); return; }

        if (mode === 'add') {
            payload.parentId = document.getElementById('inp-parent').value;
        } else {
            payload.id = document.getElementById('inp-id').value;
        }

        postData(payload);
    }

    function deleteItem(id) {
        if(confirm("Hapus data ini? Keturunan di bawahnya juga akan terhapus.")) {
            postData({ action: 'delete', id: id });
        }
    }
	
	
	// --- LOGIKA DARK MODE ---
    const themeBtn = document.getElementById('theme-btn');
    const themeIcon = themeBtn.querySelector('i');

    // Cek penyimpanan lokal saat pertama kali load
    if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        themeIcon.classList.replace('fa-moon', 'fa-sun');
    }

    themeBtn.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        
        if (currentTheme === 'dark') {
            // Pindah ke Light Mode
            document.documentElement.removeAttribute('data-theme');
            localStorage.setItem('theme', 'light');
            themeIcon.classList.replace('fa-sun', 'fa-moon');
        } else {
            // Pindah ke Dark Mode
            document.documentElement.setAttribute('data-theme', 'dark');
            localStorage.setItem('theme', 'dark');
            themeIcon.classList.replace('fa-moon', 'fa-sun');
        }
    });
	
	
	
</script>
</body>
</html>