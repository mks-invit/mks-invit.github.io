<!DOCTYPE html>
<html lang="id" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silsilah Keluarga Puang Guru Nasing</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3498db', 'primary-dark': '#2980b9',
                        'bg-light': '#f4f7f6', 'bg-dark': '#121212', 'card-dark': '#1e1e1e',
                    },
                    fontFamily: { sans: ['Segoe UI', 'Tahoma', 'Geneva', 'Verdana', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-down { animation: slideDown 0.3s ease-out; }
        
        .tree-line { border-left: 2px dashed #d1d5db; }
        .dark .tree-line { border-left: 2px dashed #4b5563; }
        
        @keyframes pulse-highlight {
            0%, 100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.7); transform: scale(1); }
            50% { box-shadow: 0 0 0 10px rgba(250, 204, 21, 0); transform: scale(1.02); }
        }
        .highlight-card { animation: pulse-highlight 1.5s ease-in-out 3; border-color: #facc15 !important; z-index: 10; }

        #custom-search-results::-webkit-scrollbar { width: 6px; }
        #custom-search-results::-webkit-scrollbar-track { background: transparent; }
        #custom-search-results::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .dark #custom-search-results::-webkit-scrollbar-thumb { background-color: #4b5563; }
    </style>
</head>
<body class="bg-bg-light text-slate-700 dark:bg-bg-dark dark:text-gray-200 font-sans transition-colors duration-300 p-5 min-h-screen">

<div class="max-w-4xl mx-auto pb-20">
    
    <header class="text-center mb-10 mt-5">
        <div class="flex justify-center items-center gap-3 mb-1 flex-wrap">
            <button onclick="fetchData()" class="w-8 h-8 rounded-full border border-gray-400 text-gray-500 dark:text-gray-300 dark:border-gray-500 hover:bg-primary hover:text-white hover:border-primary flex items-center justify-center transition-all duration-200" title="Refresh Data">
                <i class="fas fa-sync-alt"></i>
            </button>

            <h4 class="text-xl font-bold text-slate-800 dark:text-gray-100 m-0 px-2">Silsilah Puang Guru Nasing</h4>
            
            <button id="theme-btn" class="w-8 h-8 rounded-full border border-gray-400 text-gray-500 dark:text-gray-300 dark:border-gray-500 hover:bg-primary hover:text-white hover:border-primary flex items-center justify-center transition-all duration-200" title="Ganti Mode">
                <i class="fas fa-moon"></i>
            </button>

            <button id="btn-login-trigger" onclick="openLoginModal()" class="w-8 h-8 rounded-full border border-gray-400 text-gray-500 dark:text-gray-300 dark:border-gray-500 hover:bg-green-600 hover:text-white hover:border-green-600 flex items-center justify-center transition-all duration-200" title="Login Admin">
                <i class="fas fa-lock"></i>
            </button>

            <button id="btn-logout-trigger" onclick="doLogout()" class="hidden w-8 h-8 rounded-full border border-red-400 text-red-500 hover:bg-red-500 hover:text-white flex items-center justify-center transition-all duration-200" title="Logout">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>

        <div class="relative w-full max-w-xs mx-auto mt-4 group z-30">
            <div class="flex items-center bg-white dark:bg-gray-800 rounded-full px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm focus-within:shadow-md focus-within:ring-2 focus-within:ring-primary focus-within:border-primary transition-all">
                <i class="fas fa-search text-gray-400 mr-3 group-focus-within:text-primary"></i>
                <input type="text" id="search-box" class="w-full bg-transparent border-none focus:ring-0 text-sm text-gray-700 dark:text-gray-200 placeholder-gray-400 focus:outline-none" placeholder="Cari nama keluarga..." oninput="handleSearchInput(this.value)" onkeydown="if(event.key === 'Enter') handleSearchExecute(this.value)" onblur="setTimeout(() => hideSearch(), 200)" autocomplete="off">
            </div>
            <ul id="custom-search-results" class="absolute w-full bg-white dark:bg-card-dark mt-2 rounded-lg shadow-xl max-h-60 overflow-y-auto hidden border border-gray-200 dark:border-gray-600 z-50 text-sm text-left"></ul>
        </div>
    </header>

    <div id="loader" class="flex flex-col items-center mt-16">
        <div class="w-10 h-10 border-4 border-gray-200 border-t-primary rounded-full animate-spin mb-3"></div>
        <p class="text-sm text-gray-500 dark:text-gray-400">Menghubungkan ke Database...</p>
    </div>
    <div id="tree-root" class="hidden"></div>
</div>

<div id="login-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] hidden justify-center items-center p-4">
    <div class="bg-white dark:bg-card-dark w-full max-w-sm rounded-xl shadow-2xl p-6 animate-slide-down">
        <h3 class="text-xl font-bold text-center mb-4 dark:text-white">Login Admin</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1 dark:text-gray-300">Username</label>
                <input type="text" id="login-user" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Masukkan username">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1 dark:text-gray-300">Password</label>
                <input type="password" id="login-pass" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Masukkan password">
            </div>
            <div id="login-error" class="text-red-500 text-xs hidden text-center">Username atau Password salah!</div>
            <div class="flex gap-2 pt-2">
                <button onclick="closeLoginModal()" class="w-1/2 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300">Batal</button>
                <button onclick="doLogin()" class="w-1/2 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark">Masuk</button>
            </div>
        </div>
    </div>
</div>

<div id="modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden justify-center items-center p-4">
    <div class="bg-white dark:bg-card-dark w-full max-w-lg rounded-xl shadow-2xl p-6 max-h-[90vh] overflow-y-auto transition-colors duration-300">
        <h3 id="modal-title" class="text-xl font-bold text-primary-dark border-b border-gray-200 dark:border-gray-700 pb-3 mb-5">Form Data</h3>
        
        <input type="hidden" id="inp-mode">
        <input type="hidden" id="inp-id">
        <input type="hidden" id="inp-parent">

        <div class="mb-4">
            <div class="flex justify-between items-end mb-2">
                <label class="text-sm font-semibold dark:text-gray-300">Daftar Anggota Keluarga</label>
            </div>
            <div id="children-inputs-container" class="space-y-3"></div>
            <button type="button" id="btn-add-more-child" class="hidden mt-3 text-sm font-medium text-primary hover:text-primary-dark flex items-center gap-1" onclick="addChildInputRow()">
                <i class="fas fa-plus-circle"></i> Tambah anak lagi
            </button>
        </div>

        <div class="mb-4 pt-2 border-t border-gray-100 dark:border-gray-700">
            <label class="block text-sm font-semibold mb-1 dark:text-gray-300">Pasangan Orang Tua (Ibu/Ayah)</label>
            <input type="text" id="inp-mother" class="w-full p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 text-sm" placeholder="Ibu/Ayah dari anak-anak di atas..." autocomplete="off">
            <p class="text-[10px] text-gray-400 mt-1">*Kosongkan jika tidak perlu</p>
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700 mt-6">
            <button class="px-5 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold transition-colors dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600" onclick="closeModal()">Batal</button>
            <button class="px-5 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark font-semibold shadow-md hover:shadow-lg transition-all" onclick="submitData()">Simpan</button>
        </div>
    </div>
</div>

<script>
    // =======================================================================
    // SETUP CREDENTIALS & API
    // =======================================================================
    // 1. DEPLOY ULANG Code.gs > NEW DEPLOYMENT > Salin URL-nya kesini:
    const API_URL = "https://script.google.com/macros/s/AKfycbxaOo9p7QZHNNBNqt-s7_CPHh_J8672SRAVkSxUv0VljwovwN4zaYx9bkoL_VtB1dTB/exec"; 
    
    const ADMIN_USER = "ihsans";
    const ADMIN_PASS = "ihsans123";
    let isLoggedIn = localStorage.getItem('isLoggedIn') === 'true'; 
    // =======================================================================

    let allData = [];
    let searchableNamesList = []; 
    const htmlEl = document.documentElement;

    // --- THEME LOGIC ---
    if (localStorage.getItem('theme') !== 'light') { 
        htmlEl.classList.add('dark');
        document.querySelector('#theme-btn i').classList.replace('fa-moon', 'fa-sun');
    }

    document.getElementById('theme-btn').addEventListener('click', () => {
        if (htmlEl.classList.contains('dark')) {
            htmlEl.classList.remove('dark');
            localStorage.setItem('theme', 'light');
            document.querySelector('#theme-btn i').classList.replace('fa-sun', 'fa-moon');
        } else {
            htmlEl.classList.add('dark');
            localStorage.setItem('theme', 'dark');
            document.querySelector('#theme-btn i').classList.replace('fa-moon', 'fa-sun');
        }
    });

    window.onload = function() {
        updateLoginUI(); 
        fetchData();
    };

    // ==============================================================
    // LOGIN LOGIC
    // ==============================================================
    function openLoginModal() {
        document.getElementById('login-modal').classList.remove('hidden');
        document.getElementById('login-modal').classList.add('flex');
        document.getElementById('login-user').value = '';
        document.getElementById('login-pass').value = '';
        document.getElementById('login-error').classList.add('hidden');
        document.getElementById('login-user').focus();
    }

    function closeLoginModal() {
        document.getElementById('login-modal').classList.add('hidden');
        document.getElementById('login-modal').classList.remove('flex');
    }

    function doLogin() {
        const user = document.getElementById('login-user').value;
        const pass = document.getElementById('login-pass').value;

        if (user === ADMIN_USER && pass === ADMIN_PASS) {
            isLoggedIn = true;
            localStorage.setItem('isLoggedIn', 'true');
            closeLoginModal();
            updateLoginUI();
            renderTree(); 
            alert("Login Berhasil! Mode Edit Aktif.");
        } else {
            document.getElementById('login-error').classList.remove('hidden');
        }
    }

    function doLogout() {
        isLoggedIn = false;
        localStorage.removeItem('isLoggedIn');
        updateLoginUI();
        renderTree(); 
    }

    function updateLoginUI() {
        const btnLogin = document.getElementById('btn-login-trigger');
        const btnLogout = document.getElementById('btn-logout-trigger');
        
        if (isLoggedIn) {
            btnLogin.classList.add('hidden');
            btnLogout.classList.remove('hidden');
        } else {
            btnLogin.classList.remove('hidden');
            btnLogout.classList.add('hidden');
        }
    }

    // ==============================================================
    // DATA FETCHING
    // ==============================================================
    async function fetchData() {
        showLoader(true);
        try {
            const response = await fetch(API_URL);
            allData = await response.json();
            prepareSearchableNames(); 
            renderTree();
            showLoader(false);
        } catch (error) {
            alert("Gagal mengambil data. Pastikan URL API benar dan Deploy Terbaru.");
            showLoader(false);
        }
    }

    async function postData(payload) {
        showLoader(true);
        closeModal();
        try {
            const response = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
            allData = await response.json(); 
            prepareSearchableNames();
            renderTree();
            showLoader(false);
        } catch (error) {
            alert("Gagal menyimpan: " + error);
            showLoader(false);
        }
    }

    function showLoader(show) {
        document.getElementById('loader').style.display = show ? 'flex' : 'none';
        document.getElementById('tree-root').style.display = show ? 'none' : 'block';
    }

    function prepareSearchableNames() {
        const uniqueNames = new Set();
        allData.forEach(p => {
            if(p.name) uniqueNames.add(p.name.trim());
            if(p.spouse) p.spouse.split(',').forEach(s => { if(s.trim()) uniqueNames.add(s.trim()); });
        });
        searchableNamesList = Array.from(uniqueNames).sort();
    }

    // --- SEARCH ---
    function handleSearchInput(value) {
        const dropdown = document.getElementById('custom-search-results');
        if (!value || value.length < 2) { dropdown.classList.add('hidden'); return; }
        const filtered = searchableNamesList.filter(n => n.toLowerCase().includes(value.toLowerCase()));
        dropdown.innerHTML = '';
        if (filtered.length > 0) {
            dropdown.classList.remove('hidden');
            filtered.slice(0, 20).forEach(name => {
                const li = document.createElement('li');
                li.className = "px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer text-slate-700 dark:text-gray-200 border-b border-gray-100 dark:border-gray-700 last:border-none transition-colors";
                li.textContent = name;
                li.onclick = () => { document.getElementById('search-box').value = name; handleSearchExecute(name); dropdown.classList.add('hidden'); };
                dropdown.appendChild(li);
            });
        } else {
            dropdown.innerHTML = '<li class="px-4 py-2 text-gray-400 italic text-xs">Tidak ditemukan</li>';
            dropdown.classList.remove('hidden');
        }
    }
    function hideSearch() { document.getElementById('custom-search-results').classList.add('hidden'); }
    function handleSearchExecute(name) {
        let target = allData.find(d => d.name.toLowerCase() === name.toLowerCase());
        if(!target) target = allData.find(d => d.spouse && d.spouse.toLowerCase().includes(name.toLowerCase()));
        if(target) {
            document.getElementById('search-box').blur(); hideSearch(); expandAndHighlight(target.id);
        }
    }

    // ==============================================================
    // RENDER TREE (WITH ADMIN CHECK)
    // ==============================================================
    function renderTree() {
        const container = document.getElementById('tree-root');
        container.innerHTML = '';
        const roots = allData.filter(d => !d.parentId || d.parentId === "" || d.id === 'root');
        const ul = document.createElement('ul'); ul.className = 'pl-0 border-none';
        roots.forEach(root => ul.appendChild(createNode(root, 0)));
        container.appendChild(ul);
    }

    function createNode(person, level) {
        const li = document.createElement('li'); li.className = 'my-3';
        const children = allData.filter(d => d.parentId == person.id || (d.motherName && d.motherName.trim() === person.name));
        const hasChildren = children.length > 0;

        let parentLabel = `<span class="block text-[0.7rem] uppercase tracking-wide text-primary mb-0.5">â˜… Leluhur Utama</span>`;
        if (person.parentId && person.parentId !== 'root') {
            const father = allData.find(d => d.id === person.parentId);
            let motherName = person.motherName || (father && father.spouse ? father.spouse : "???");
            parentLabel = `<span class="block text-[0.7rem] uppercase tracking-wide text-gray-500 dark:text-gray-400 mb-0.5">Anak dari: <strong class="text-slate-700 dark:text-gray-200">${father ? father.name : '???'}</strong> & <strong class="text-slate-700 dark:text-gray-200">${motherName}</strong></span>`;
        }

        let spouseHtml = '';
        if (person.spouse) {
            person.spouse.split(',').forEach(s => {
                if(s.trim()) spouseHtml += `<span class="inline-flex items-center text-xs px-2 py-0.5 rounded-full bg-white/60 text-pink-600 border border-pink-200 dark:bg-pink-900/30 dark:text-pink-300 dark:border-pink-800 cursor-default mr-1"><i class="fas fa-heart mr-1 text-[0.6rem]"></i> ${s.trim()}</span>`;
            });
        }

        const colors = ['bg-slate-100 border-slate-400 dark:bg-slate-800 dark:border-slate-500', 'bg-blue-50 border-blue-400 dark:bg-blue-900/20 dark:border-blue-500', 'bg-emerald-50 border-emerald-400 dark:bg-emerald-900/20 dark:border-emerald-500', 'bg-amber-50 border-amber-400 dark:bg-amber-900/20 dark:border-amber-500', 'bg-purple-50 border-purple-400 dark:bg-purple-900/20 dark:border-purple-500', 'bg-rose-50 border-rose-400 dark:bg-rose-900/20 dark:border-rose-500'];
        
        // TOMBOL ADMIN (Hanya muncul jika isLoggedIn == true)
        const adminButtons = isLoggedIn ? `
            <div class="flex gap-1.5 ml-2 opacity-10 group-hover:opacity-100 transition-opacity duration-300 self-center">
                <button class="w-8 h-8 rounded-full bg-white/80 text-gray-500 hover:bg-primary hover:text-white flex items-center justify-center transition-colors dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-primary" onclick="openModal('edit', '${person.id}')"><i class="fas fa-pen text-xs"></i></button>
                <button class="w-8 h-8 rounded-full bg-white/80 text-gray-500 hover:bg-primary hover:text-white flex items-center justify-center transition-colors dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-primary" onclick="openModal('add', '${person.id}')"><i class="fas fa-plus text-xs"></i></button>
                ${level > 0 ? `<button class="w-8 h-8 rounded-full bg-red-100 text-red-500 hover:bg-red-500 hover:text-white flex items-center justify-center transition-colors dark:bg-red-900/40 dark:hover:bg-red-600" onclick="deleteItem('${person.id}')"><i class="fas fa-trash text-xs"></i></button>` : ''}
            </div>
        ` : '';

        const div = document.createElement('div');
        div.id = 'card-' + person.id;
        div.className = `relative flex items-start p-4 rounded-lg shadow-sm hover:shadow-md border-[3px] transition-all duration-200 group ${colors[level % colors.length]} ${level === 0 ? 'shadow-md' : ''}`;
        
        div.innerHTML = `
            <button class="toggle-btn w-5 mt-1 mr-2 text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-transform duration-200 ${hasChildren ? 'cursor-pointer' : 'cursor-default'}" onclick="toggleChild(this)">${hasChildren ? '<i class="fas fa-chevron-right"></i>' : '<i class="fas fa-circle text-[6px] opacity-30"></i>'}</button>
            <div class="flex-grow cursor-pointer" onclick="toggleChild(this.previousElementSibling)">
                ${parentLabel}
                <div class="flex flex-wrap items-center gap-2">
                    <span class="text-lg font-bold text-slate-800 dark:text-gray-100">${person.name}</span>
                    ${spouseHtml}
                </div>
            </div>
            ${adminButtons}
        `;
        li.appendChild(div);

        if (hasChildren || true) {
            const childUl = document.createElement('ul');
            childUl.className = 'children-container hidden pl-[22px] tree-line list-none'; 
            if (level === 0) { childUl.classList.remove('hidden'); childUl.classList.add('block'); div.querySelector('.toggle-btn').innerHTML = '<i class="fas fa-chevron-down"></i>'; }
            children.forEach(child => childUl.appendChild(createNode(child, level + 1)));
            li.appendChild(childUl);
        }
        return li;
    }

    function toggleChild(btn) {
        const ul = btn.parentElement.nextElementSibling; 
        if (ul && ul.tagName === 'UL' && ul.children.length > 0) {
            if (ul.classList.contains('hidden')) {
                ul.classList.remove('hidden'); ul.classList.add('block', 'animate-slide-down'); btn.innerHTML = '<i class="fas fa-chevron-down"></i>';
            } else {
                ul.classList.add('hidden'); ul.classList.remove('block', 'animate-slide-down'); btn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            }
        }
    }

    // --- MODAL INPUTS ---
    function toggleChildSpouseInput(checkbox) {
        const inp = checkbox.closest('.child-input-row').querySelector('.inp-child-spouse');
        if (checkbox.checked) { inp.classList.remove('hidden'); inp.focus(); } 
        else { inp.classList.add('hidden'); inp.value = ''; }
    }

    function addChildInputRow(nameVal = "", spouseVal = "") {
        const container = document.getElementById('children-inputs-container');
        const div = document.createElement('div');
        div.className = 'child-input-row bg-gray-50 dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700 relative animate-slide-down';
        
        const deleteBtn = container.children.length > 0 ? `<button type="button" class="absolute top-2 right-2 text-gray-400 hover:text-red-500" onclick="this.closest('.child-input-row').remove()"><i class="fas fa-times"></i></button>` : ``;
        const hasSpouse = spouseVal && spouseVal.trim() !== "";
        
        div.innerHTML = `
            ${deleteBtn}
            <div class="mb-2 pr-5">
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">Nama Lengkap</label>
                <input type="text" class="inp-child-name w-full p-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Nama anak..." value="${nameVal}" autocomplete="off">
            </div>
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <input type="checkbox" class="w-3.5 h-3.5 text-primary rounded focus:ring-primary" onchange="toggleChildSpouseInput(this)" ${hasSpouse ? "checked" : ""}>
                    <label class="text-xs text-gray-500 dark:text-gray-400 cursor-pointer select-none" onclick="this.previousElementSibling.click()">Sudah Menikah?</label>
                </div>
                <input type="text" class="inp-child-spouse ${hasSpouse ? "" : "hidden"} w-full p-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Nama Pasangan..." value="${spouseVal}" autocomplete="off">
            </div>
        `;
        container.appendChild(div);
    }

    function openModal(mode, id) {
        document.getElementById('modal').classList.remove('hidden'); document.getElementById('modal').classList.add('flex');
        document.getElementById('inp-mode').value = mode;
        document.getElementById('children-inputs-container').innerHTML = ''; 
        document.getElementById('inp-mother').value = ''; document.getElementById('inp-parent').value = '';

        if (mode === 'add') {
            document.getElementById('modal-title').innerText = "Tambah Keturunan";
            document.getElementById('inp-parent').value = id; 
            document.getElementById('btn-add-more-child').classList.remove('hidden'); 
            addChildInputRow(); 
            const father = allData.find(d => d.id == id);
            if (father && father.spouse && father.spouse.split(',').length === 1) document.getElementById('inp-mother').value = father.spouse.trim();
        } else {
            document.getElementById('modal-title').innerText = "Edit Data";
            document.getElementById('btn-add-more-child').classList.add('hidden'); 
            const p = allData.find(d => d.id == id);
            document.getElementById('inp-id').value = id;
            addChildInputRow(p.name, p.spouse); 
            document.getElementById('inp-mother').value = p.motherName || '';
        }
    }

    function closeModal() {
        document.getElementById('modal').classList.add('hidden'); document.getElementById('modal').classList.remove('flex');
    }

    function submitData() {
        const mode = document.getElementById('inp-mode').value;
        const rows = document.querySelectorAll('.child-input-row');
        const childrenData = [];

        rows.forEach(row => {
            const name = row.querySelector('.inp-child-name').value.trim();
            const spouseInp = row.querySelector('.inp-child-spouse');
            let spouse = "";
            // Hanya ambil nilai pasangan jika input terlihat (hidden class tidak ada)
            if (!spouseInp.classList.contains('hidden')) {
                spouse = spouseInp.value.trim();
            }
            
            if (name) childrenData.push({ name, spouse });
        });

        if (childrenData.length === 0) { alert("Wajib isi minimal satu nama!"); return; }

        const payload = { action: mode, motherName: document.getElementById('inp-mother').value };
        if (mode === 'add') {
            payload.parentId = document.getElementById('inp-parent').value;
            payload.children = childrenData; // KIRIM DATA ARRAY ANAK (PERBAIKAN UTAMA)
        } else {
            payload.id = document.getElementById('inp-id').value;
            payload.name = childrenData[0].name;
            payload.spouse = childrenData[0].spouse;
        }
        postData(payload);
    }

    function deleteItem(id) {
        if(confirm("Hapus data ini beserta keturunannya?")) postData({ action: 'delete', id: id });
    }

    function expandAndHighlight(targetId) {
        document.querySelectorAll('.highlight-card').forEach(el => el.classList.remove('highlight-card'));
        let curr = allData.find(d => d.id === targetId);
        while (curr && curr.parentId && curr.parentId !== 'root') {
            const pCard = document.getElementById('card-' + curr.parentId);
            if (pCard) {
                const ul = pCard.nextElementSibling; 
                if (ul && ul.classList.contains('hidden')) {
                    ul.classList.remove('hidden'); ul.classList.add('block', 'animate-slide-down');
                    pCard.querySelector('.toggle-btn').innerHTML = '<i class="fas fa-chevron-down"></i>';
                }
            }
            curr = allData.find(d => d.id === curr.parentId);
        }
        setTimeout(() => {
            const tCard = document.getElementById('card-' + targetId);
            if (tCard) {
                tCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                tCard.classList.add('highlight-card');
                setTimeout(() => tCard.classList.remove('highlight-card'), 4500);
            }
        }, 300); 
    }
</script>
</body>
</html>
