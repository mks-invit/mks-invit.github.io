<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silsilah Keluarga - Intermarriage Support</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- CSS SAMA SEPERTI SEBELUMNYA --- */
        :root { --bg: #f0f2f5; --card: #ffffff; --primary: #2980b9; --text-dark: #2c3e50; --border-radius: 10px; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text-dark); padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; padding-bottom: 100px; }
        header { text-align: center; margin-bottom: 40px; }
        
        .node-card { background: var(--card); padding: 15px 20px; border-radius: var(--border-radius); margin-bottom: 10px; display: flex; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .node-card:hover { transform: translateX(5px); }
        
        .level-0 { border-left-color: #2c3e50; background: #ebf5fb; }
        .level-1 { border-left-color: #2980b9; }
        .level-2 { border-left-color: #16a085; }
        .level-3 { border-left-color: #f39c12; }
        .level-4 { border-left-color: #8e44ad; }
        
        .node-content { flex-grow: 1; cursor: pointer; }
        .name-text { font-size: 1.1rem; font-weight: 700; display: block; margin-bottom: 5px; }
        .parent-label { font-size: 0.75rem; color: #95a5a6; text-transform: uppercase; display: block; margin-bottom: 4px; }
        
        /* Badge khusus jika anak muncul dari link ID (Intermarriage) */
        .link-badge { font-size: 0.7em; background: #e8f5e9; color: #2e7d32; padding: 2px 6px; border-radius: 4px; border: 1px solid #c8e6c9; margin-left: 5px; }

        .spouse-tags { display: flex; flex-wrap: wrap; gap: 5px; }
        .tag { font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; background: #fce4ec; color: #c2185b; border: 1px solid #f8bbd0; display: inline-flex; align-items: center; }
        
        .actions { display: flex; gap: 5px; opacity: 0.2; align-self: center; transition: 0.3s; margin-left: 10px; }
        .node-card:hover .actions { opacity: 1; }
        .btn-icon { width: 30px; height: 30px; border-radius: 50%; border: none; background: #f0f2f5; color: #7f8c8d; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background: var(--primary); color: white; }
        
        .toggle-btn { background: none; border: none; width: 20px; margin-top: 5px; cursor: pointer; font-size: 1rem; color: #ccc; }
        .has-children .toggle-btn { color: var(--text-dark); }
        .expanded .toggle-btn { transform: rotate(90deg); }

        .children-container { display: none; padding-left: 25px; border-left: 2px dashed #ddd; }
        .children-container.open { display: block; animation: slideDown 0.3s; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .tree-root ul { list-style: none; padding: 0; }
        
        /* MODAL */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:1000; }
        .modal { background: white; width: 90%; max-width: 500px; border-radius: 12px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; }
        .btn-save { background: var(--primary); color: white; }
        .btn-cancel { background: #ecf0f1; color: #333; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

        #loader { text-align: center; margin-top: 60px; }
        .spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid #ccc; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Silsilah Puang Guru Nasing</h1>
        <p>Mendukung Pernikahan Sesama Keluarga (Tampil di Dua Cabang)</p>
    </header>

    <div id="loader"><div class="spinner"></div><p>Memuat Data...</p></div>
    <div id="tree-root" class="tree-root"></div>
</div>

<div id="modal" class="modal-overlay">
    <div class="modal">
        <h3 id="modal-title" style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">Form Data</h3>
        <input type="hidden" id="inp-mode">
        <input type="hidden" id="inp-id">
        <input type="hidden" id="inp-parent">

        <div class="form-group">
            <label>Nama Anak</label>
            <input type="text" id="inp-name" placeholder="Nama Lengkap" autocomplete="off">
        </div>

        <div class="form-group">
            <label>Orang Tua Kedua (Ibu/Pasangan Ayah)</label>
            
            <input type="text" id="inp-mother-search" list="all-members" placeholder="Cari nama dari keluarga (jika ada)..." autocomplete="off">
            <datalist id="all-members">
                </datalist>
            
            <input type="hidden" id="inp-mother-id-val">

            <small style="color:#888; display:block; margin-top:5px;">
                <i class="fas fa-info-circle"></i> Jika pasangan adalah keluarga (sepupu dsb), pilih namanya dari list. Anak akan otomatis muncul di bawah kedua orang tua. Jika orang luar, ketik manual saja.
            </small>
        </div>

        <div class="form-group">
            <label>Pasangan (Suami/Istri Anak Ini)</label>
            <input type="text" id="inp-spouse" placeholder="Nama pasangan (pisahkan koma jika banyak)">
        </div>

        <div class="modal-footer">
            <button class="btn btn-cancel" onclick="closeModal()">Batal</button>
            <button class="btn btn-save" onclick="submitData()">Simpan</button>
        </div>
    </div>
</div>

<script>
    // ========================================================
    // GANTI URL INI DENGAN URL GOOGLE APPS SCRIPT ANDA
    const API_URL = "https://script.google.com/macros/s/AKfycbxQwkD3cKOaZwy7hhm1HoA1JLknO4eena3Jv5unujltJ_MM9mvlQsjKqYBekgWN77sA/exec"; 
    // ========================================================

    let allData = [];

    window.onload = function() { fetchData(); };

    async function fetchData() {
        showLoader(true);
        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            allData = data;
            populateDataList(); // Isi daftar pencarian
            renderTree();
            showLoader(false);
        } catch (error) { alert("Error: " + error); showLoader(false); }
    }

    async function postData(payload) {
        showLoader(true); closeModal();
        try {
            const response = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
            const data = await response.json();
            allData = data;
            populateDataList();
            renderTree();
            showLoader(false);
        } catch (error) { alert("Error: " + error); showLoader(false); }
    }

    function showLoader(show) {
        document.getElementById('loader').style.display = show ? 'block' : 'none';
        document.getElementById('tree-root').style.display = show ? 'none' : 'block';
    }

    // --- ISI DATALIST UNTUK PENCARIAN KELUARGA ---
    function populateDataList() {
        const list = document.getElementById('all-members');
        list.innerHTML = '';
        allData.forEach(p => {
            // Jangan masukkan root ke list pasangan
            if(p.id !== 'root') {
                const option = document.createElement('option');
                option.value = p.name; // Yang tampil saat diketik
                option.setAttribute('data-id', p.id); // ID tersimpan
                // Tambahkan info pasangan untuk memudahkan identifikasi
                option.label = p.spouse ? `(Pasangan: ${p.spouse})` : '(Belum ada pasangan)';
                list.appendChild(option);
            }
        });
    }

    // --- RENDER LOGIC (MODIFIED FOR DUAL PARENTS) ---
    function renderTree() {
        const container = document.getElementById('tree-root');
        container.innerHTML = '';
        // Root adalah yang parentId kosong
        const roots = allData.filter(d => !d.parentId || d.id === 'root');
        const ul = document.createElement('ul');
        roots.forEach(root => ul.appendChild(createNode(root, 0)));
        container.appendChild(ul);
    }

    function createNode(person, level) {
        const li = document.createElement('li');
        
        // --- LOGIKA KUNCI: CARI ANAK DI KEDUA KOLOM (ParentID ATAU MotherName) ---
        // Ini membuat anak muncul di bawah Bapak DAN di bawah Ibu (jika Ibu ada di tree)
        const children = allData.filter(d => 
            d.parentId == person.id || (d.motherName == person.id)
        );
        
        const hasChildren = children.length > 0;

        // Helper: Cari Nama Ayah & Ibu
        let parentLabel = `<span class="parent-label" style="color:var(--primary)">â˜… Leluhur</span>`;
        
        // Cek apakah ini anak "Link" (Bukan anak langsung dari parentId, tapi dari motherName)
        let isLinkedChild = false;

        if (person.parentId && person.parentId !== 'root') {
            // Cari Ayah (berdasarkan parentId)
            const father = allData.find(d => d.id === person.parentId);
            const fatherName = father ? father.name : "???";
            
            // Cari Ibu (Cek apakah motherName adalah ID atau Teks)
            let motherNameText = "(Belum data)";
            const motherObj = allData.find(d => d.id === person.motherName);
            
            if (motherObj) {
                motherNameText = motherObj.name; // Jika ID, ambil namanya
                // Cek apakah kita sedang merender di bawah Ibu?
                // Logic rendering recursive standar tidak tahu context parent, 
                // tapi kita biarkan tampil apa adanya.
            } else if (person.motherName) {
                motherNameText = person.motherName; // Jika teks biasa
            }

            parentLabel = `<span class="parent-label">Anak dari: <strong>${fatherName}</strong> & <strong>${motherNameText}</strong></span>`;
        }

        // Tags Pasangan
        let spouseHtml = '';
        if (person.spouse) {
            person.spouse.split(',').forEach(s => {
                if(s.trim()) spouseHtml += `<span class="tag"><i class="fas fa-heart"></i> ${s.trim()}</span>`;
            });
        }

        // HTML Node
        const div = document.createElement('div');
        div.className = `node-card level-${level}`;
        if(hasChildren) div.classList.add('has-children');

        const toggleIcon = hasChildren ? '<i class="fas fa-chevron-right"></i>' : '<i class="fas fa-circle" style="font-size:0.4em; opacity:0.3"></i>';

        div.innerHTML = `
            <button class="toggle-btn" onclick="toggleChild(this)">${toggleIcon}</button>
            <div class="node-content" onclick="toggleChild(this.previousElementSibling)">
                ${parentLabel}
                <span class="name-text">${person.name}</span>
                <div class="spouse-tags">${spouseHtml}</div>
            </div>
            <div class="actions">
                <button class="btn-icon" onclick="openModal('edit', '${person.id}')"><i class="fas fa-pen"></i></button>
                <button class="btn-icon" onclick="openModal('add', '${person.id}')"><i class="fas fa-plus"></i></button>
                ${level > 0 ? `<button class="btn-icon" onclick="deleteItem('${person.id}')" style="color:#e74c3c"><i class="fas fa-trash"></i></button>` : ''}
            </div>
        `;

        li.appendChild(div);

        if (hasChildren || true) {
            const childUl = document.createElement('ul');
            childUl.className = 'children-container';
            
            // Auto expand root
            if(level === 0) {
                childUl.classList.add('open');
                div.classList.add('expanded');
                div.querySelector('.toggle-btn').innerHTML = '<i class="fas fa-chevron-down"></i>';
            }

            children.forEach(child => {
                // PENCEGAHAN INFINITE LOOP VISUAL (JIKA ADA SALAH STRUKTUR)
                // Kita hanya merender anak di level berikutnya.
                // Jika A menikah dengan B. A punya anak C. B punya anak C (via link).
                // Tree A -> C. Tree B -> C. Ini aman.
                // Masalah muncul jika C entah bagaimana menjadi parent dari A (Cycle). 
                // Logika filter 'parentId' mencegah ini selama data tidak cycle.
                
                childUl.appendChild(createNode(child, level + 1));
            });
            li.appendChild(childUl);
        }
        return li;
    }

    function toggleChild(btn) {
        const card = btn.parentElement;
        const ul = card.parentElement.querySelector('.children-container');
        if(ul && ul.children.length > 0) {
            ul.classList.toggle('open');
            card.classList.toggle('expanded');
            btn.innerHTML = ul.classList.contains('open') ? '<i class="fas fa-chevron-down"></i>' : '<i class="fas fa-chevron-right"></i>';
        }
    }

    // --- MODAL LOGIC ---
    function openModal(mode, id) {
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('inp-mode').value = mode;
        
        const inpMotherSearch = document.getElementById('inp-mother-search');
        const inpMotherIdVal = document.getElementById('inp-mother-id-val');

        if (mode === 'add') {
            document.getElementById('modal-title').innerText = "Tambah Anak";
            document.getElementById('inp-parent').value = id; // ID Ayah Utama
            document.getElementById('inp-name').value = '';
            document.getElementById('inp-spouse').value = '';
            
            // Reset Ibu
            inpMotherSearch.value = '';
            inpMotherIdVal.value = '';
            
            // Coba pre-fill jika Ayah punya pasangan teks
            const father = allData.find(d => d.id == id);
            if(father && father.spouse) {
                // Kita isi placeholder saja, user harus pilih jika ingin link ID
                inpMotherSearch.placeholder = `Saran: ${father.spouse} (Atau cari nama lain)`;
            }

        } else {
            document.getElementById('modal-title').innerText = "Edit Data";
            const p = allData.find(d => d.id == id);
            document.getElementById('inp-id').value = id;
            document.getElementById('inp-name').value = p.name;
            document.getElementById('inp-spouse').value = p.spouse;

            // Load data Ibu (Bisa ID, Bisa Text)
            const motherRaw = p.motherName || '';
            
            // Cek apakah motherRaw adalah ID yang valid di database
            const linkedMother = allData.find(m => m.id === motherRaw);
            
            if (linkedMother) {
                // Jika ID valid, tampilkan Namanya di input text, simpan ID di hidden
                inpMotherSearch.value = linkedMother.name;
                inpMotherIdVal.value = linkedMother.id;
            } else {
                // Jika teks biasa
                inpMotherSearch.value = motherRaw;
                inpMotherIdVal.value = ''; 
            }
        }
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    function submitData() {
        const mode = document.getElementById('inp-mode').value;
        const name = document.getElementById('inp-name').value;
        const spouse = document.getElementById('inp-spouse').value;
        
        // Logika Pengambilan Data Ibu
        const motherSearchVal = document.getElementById('inp-mother-search').value; // Nama Teks
        let motherFinalVal = motherSearchVal;

        // Cek apakah user memilih dari datalist (Validasi Nama -> ID)
        // Kita cari di allData apakah ada orang dengan nama persis seperti input user
        const matchedPerson = allData.find(p => p.name === motherSearchVal && p.id !== 'root');
        
        if (matchedPerson) {
            // JIKA NAMA DITEMUKAN DI DATABASE -> SIMPAN ID NYA
            motherFinalVal = matchedPerson.id;
            console.log("Link created to ID:", matchedPerson.id);
        }
        // JIKA TIDAK DITEMUKAN -> SIMPAN TEKS BIASA (Input manual orang luar)
        
        const payload = {
            action: mode,
            name: name,
            spouse: spouse,
            motherName: motherFinalVal
        };

        if (!name) { alert("Nama wajib diisi!"); return; }

        if (mode === 'add') payload.parentId = document.getElementById('inp-parent').value;
        else payload.id = document.getElementById('inp-id').value;
        
        postData(payload);
    }

    function deleteItem(id) {
        if(confirm("Hapus data ini?")) postData({ action: 'delete', id: id });
    }
</script>

</body>
</html>