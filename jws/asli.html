<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>aic | jws</title>

    <meta name="theme-color" content="#10b981">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Menggunakan font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Amiri&display=swap'); 

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; 
            color: #1f2937;
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        body.dark {
            background-color: #111827; 
            color: #f3f4f6;
        }
        body.dark #app-container {
            background-color: #1f2937; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.7), 0 4px 6px -2px rgba(0, 0, 0, 0.3); 
        }
        
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .is-next-prayer {
            background-color: #fffbeb; 
            border-left: 5px solid #f59e0b; 
            font-weight: 700;
            transform: scale(1.02);
            transition: all 0.3s ease;
        }
        .is-next-prayer .prayer-name, .is-next-prayer .prayer-time { color: #1f2937 !important; }
        body.dark .is-next-prayer { background-color: #fbbf2430; border-left: 5px solid #fbbf24; }
        body.dark .is-next-prayer .prayer-name, body.dark .is-next-prayer .prayer-time { color: #fef3c7 !important; }
        
        .prayer-list-item { transition: all 0.3s ease; }
        .prayer-list-item:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        body.dark .prayer-list-item:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }

        #darkModeToggle { transition: transform 0.15s; }
        
        .next-prayer-highlight {
            background-color: #f59e0b; color: #fff; 
            box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.5);
        }

        .ayah-arabic {
            font-family: 'Traditional Arabic', 'Amiri', serif;
            font-size: 1.5rem; line-height: 2.5rem; text-align: right;
        }

        .surah-button {
            transition: background-color 0.2s;
            border-radius: 0.5rem; padding: 0.75rem 1rem; margin-bottom: 0.5rem;
            text-align: left; display: flex; justify-content: space-between; align-items: center;
        }
        .surah-button:hover { background-color: #f9fafb; }
        body.dark .surah-button:hover { background-color: #374151; }
        
        .translation-text { transition: opacity 0.3s ease; max-height: 1000px; }
        .translation-text.hidden { opacity: 0; max-height: 0; padding: 0 !important; }

        .highlight-playing {
            background-color: #d1fae5 !important; 
            border-left-width: 4px; border-left-color: #10b981; 
        }
        body.dark .highlight-playing {
            background-color: #064e3b !important; border-left-color: #34d399; 
        }

        /* --- [PERBAIKAN UTAMA: CSS UNTUK LANDSCAPE VISIBILITY] --- */
        /* Memaksa elemen sembunyi meskipun ada landscape:grid */
        #surah-list.hidden, #juz-list.hidden {
            display: none !important;
        }

        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        .tab-active { border-bottom: 2px solid #10b981; color: #10b981; font-weight: bold; }
        .tab-inactive { color: #6b7280; border-bottom: 2px solid transparent; }
        body.dark .tab-inactive { color: #9ca3af; }

        .font-serif-display { font-family: 'Playfair Display', serif; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-down { animation: slideDown 0.8s ease-out forwards; }
        #fullscreen-overlay { background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%2310b981' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

<div id="fullscreen-overlay" onclick="enterFullScreenApp()" class="fixed inset-0 z-[9999] bg-slate-900 flex flex-col justify-between items-center text-white cursor-pointer transition-opacity duration-700 select-none overflow-hidden py-12 md:py-16">
    <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-emerald-900/40 to-transparent pointer-events-none"></div>
    <div class="absolute bottom-0 left-0 w-full h-1/2 bg-gradient-to-t from-slate-950/90 to-transparent pointer-events-none"></div>
    <div class="text-center relative z-20 w-full px-4 animate-slide-down flex-shrink-0">
        <p class="text-xs md:text-sm text-emerald-400 mb-2 uppercase tracking-[0.3em] font-semibold opacity-80">Menuju Bulan Suci</p>
        <h1 class="text-4xl md:text-6xl font-black font-serif-display text-transparent bg-clip-text bg-gradient-to-r from-white via-emerald-100 to-white mb-2 drop-shadow-xl">RAMADHAN 1447 H</h1>
        <p class="text-[10px] md:text-xs text-slate-300 mb-6 font-mono tracking-widest opacity-60">Estimasi: 18 Februari 2026</p>
        <div id="ramadhan-timer" class="flex flex-wrap justify-center items-center gap-3 md:gap-6">
            <div class="animate-pulse text-gray-400 text-sm font-mono">Memuat waktu...</div>
        </div>
    </div>
    <div class="flex-grow flex flex-col items-center justify-center w-full z-20 group my-4">
        <div class="mb-6 relative inline-flex items-center justify-center animate-bounce">
             <div class="absolute -inset-8 bg-emerald-500/20 rounded-full blur-2xl opacity-70 group-hover:opacity-100 transition-opacity duration-500"></div>
             <i class="fas fa-fingerprint text-7xl md:text-8xl text-emerald-400 relative z-10 drop-shadow-[0_0_25px_rgba(52,211,153,0.6)]"></i>
        </div>
        <h2 class="text-2xl md:text-4xl font-black text-white uppercase tracking-[0.15em] mb-2 drop-shadow-lg leading-none">KETUK LAYAR</h2>
        <p class="text-xs md:text-sm text-emerald-200/80 font-medium tracking-wider uppercase">untuk masuk aplikasi</p>
    </div>
    <div class="relative z-30 w-full px-6 flex justify-center max-w-lg mx-auto flex-shrink-0">
        <div class="w-full group relative">
            <div class="absolute -inset-0.5 bg-gradient-to-r from-emerald-600 to-teal-900 rounded-xl blur opacity-20 transition duration-200"></div>
            <div class="relative bg-slate-900/80 backdrop-blur-md border-t border-emerald-500/30 p-4 text-center rounded-xl">
                <div class="flex items-center justify-center gap-2 mb-2">
                    <i class="fas fa-history text-emerald-400 text-xs"></i>
                    <span class="text-[10px] font-bold tracking-widest uppercase text-emerald-400">Wawasan Islam Hari Ini</span>
                    <span class="text-gray-600 text-[10px]">|</span>
                    <span id="hijri-date-display" class="text-emerald-200 text-[10px] font-mono tracking-wider font-bold">-</span>
                </div>
                <p id="islamic-history-text" class="text-xs md:text-sm text-gray-200 font-serif italic leading-relaxed">"Memuat wawasan sejarah..."</p>
            </div>
        </div>
    </div>
</div>

<div id="tafsir-modal" class="fixed inset-0 z-[100] hidden modal-overlay flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 w-full max-w-lg rounded-2xl shadow-2xl flex flex-col max-h-[80vh] animate-slide-down">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white" id="tafsir-title">Tafsir Ayat</h3>
            <button onclick="closeTafsir()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div class="p-6 overflow-y-auto">
            <div id="tafsir-loading" class="text-center py-4 text-emerald-600">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p class="mt-2 text-sm">Mengambil data tafsir Kemenag...</p>
            </div>
            <div id="tafsir-content" class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed hidden"></div>
        </div>
        <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50 rounded-b-2xl">
            <button onclick="closeTafsir()" class="w-full py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-semibold transition">Tutup</button>
        </div>
    </div>
</div>

<div id="app-container" class="w-full max-w-md landscape:max-w-5xl mx-auto bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-xl transition-colors duration-300 flex flex-col">
        
        <header class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-700 pb-4">
            <div class="flex items-center" style="min-width: 56px;"> 
                <button id="checklist-icon-button" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                </button>
                <button id="back-to-prayer-icon" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150 hidden">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                </button>
            </div>
            
            <div class="flex-grow flex flex-col justify-center items-center sm:flex-row sm:justify-center sm:space-x-3">
                <h1 class="text-xl sm:text-2xl font-extrabold text-gray-900 dark:text-white mb-1 sm:mb-0">aic | JWS</h1>
                <span id="header-surah-title" class="hidden text-base sm:text-lg font-semibold text-emerald-600 dark:text-emerald-400"></span>
            </div>
            
            <div class="flex space-x-2" style="min-width: 56px;"> 
                <button id="bookmark-button" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150 hidden">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>
                </button>
                <button id="toggle-translation-button" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150 hidden" onclick="toggleTranslation()">
                    <svg id="translation-eye-open" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542 7z"></path></svg>
                    <svg id="translation-eye-closed" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7 1.274 4.057 5.065 7 9.542 7 1.05 0 2.083.178 3.064.51M12 16a4 4 0 00-4-4m-2.828 2.828l1.414 1.414M17.657 6.343l-1.414 1.414m-1.414 4.242l1.414 1.414m-4.242-8.484l1.414 1.414"></path></svg>
                </button>
                <button id="darkModeToggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150">
                    <svg id="sunIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="moonIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
        </header>

        <div id="prayer-view" class="transition-opacity duration-300 flex flex-col flex-grow overflow-hidden">
            <div class="prayer-card bg-gray-50 dark:bg-gray-700/50 p-6 landscape:p-4 rounded-2xl mb-6 landscape:mb-3 text-center border border-gray-200 dark:border-gray-700 shadow-inner flex-shrink-0">
                <div id="current-date" class="text-lg text-gray-600 dark:text-gray-300 mb-2"></div>
                <div id="current-time" class="text-6xl font-extrabold text-emerald-600 dark:text-emerald-400 leading-tight"></div>
                <div id="next-prayer-display" class="mt-4 p-3 rounded-xl text-sm font-semibold shadow-md next-prayer-highlight">Waktu sholat berikutnya...</div>
            </div>
            <div class="grid grid-cols-2 landscape:grid-cols-4 gap-3 mb-6 flex-grow overflow-y-auto pr-2" id="prayer-times-list">
                <div id="loading" class="col-span-2 text-center p-6 text-gray-500 dark:text-gray-400">Memuat aplikasi...</div>
            </div>
            <p class="text-center text-sm text-gray-500 dark:text-gray-400 pt-4 border-t border-gray-200 dark:border-gray-700 flex-shrink-0">Lokasi: <span id="location-display">Makassar</span></p>
            <div class="mt-4 flex space-x-2 flex-shrink-0">
                <input type="text" id="location-input" placeholder="Ganti Lokasi (e.g., Jakarta)" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-emerald-500 focus:border-emerald-500 transition duration-150">
                <button id="location-change-button" class="py-2 px-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl shadow-lg transition duration-200">Ubah</button>
            </div>
            <div class="flex justify-center mt-6 landscape:mt-3 flex-shrink-0"> 
                <button id="toggle-view-button" class="w-full py-3 px-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl shadow-lg transition duration-200">Baca Qur'an</button>
            </div>
        </div>

        <div id="quran-view" class="hidden transition-opacity duration-300 flex flex-col flex-grow overflow-hidden">
            <div id="load-bookmark-container" class="hidden relative mb-4 flex-shrink-0">
                <button id="load-bookmark-button" class="w-full text-left p-3 pr-10 border border-emerald-500 dark:border-emerald-700 rounded-xl bg-emerald-50 dark:bg-emerald-900/50 text-emerald-700 dark:text-emerald-300 hover:bg-emerald-100 dark:hover:bg-emerald-900 font-semibold transition duration-150"></button>
                <button id="clear-bookmark-button" onclick="clearBookmark(event)" class="absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            
            <div id="list-nav-tabs" class="flex justify-center space-x-8 mb-4 border-b border-gray-200 dark:border-gray-700">
                <button id="tab-surah" class="pb-2 px-4 tab-active transition-all" onclick="switchListTab('surah')">Daftar Surah</button>
                <button id="tab-juz" class="pb-2 px-4 tab-inactive transition-all" onclick="switchListTab('juz')">Daftar Juz</button>
            </div>

            <div id="search-container" class="relative mb-4 flex-shrink-0">
                <input type="text" id="surah-search" placeholder="Cari Surah..." class="w-full p-3 pl-10 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-emerald-500 focus:border-emerald-500 transition duration-150" oninput="searchSurah(this.value)">
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>

            <div id="surah-list" class="space-y-2 landscape:space-y-0 landscape:grid landscape:grid-cols-2 landscape:gap-3 flex-grow overflow-y-auto pr-2">
                <div id="quran-loading" class="text-center p-6 text-gray-500 dark:text-gray-400">Memuat daftar surah...</div>
            </div>

            <div id="juz-list" class="hidden grid grid-cols-3 landscape:grid-cols-6 gap-3 flex-grow overflow-y-auto pr-2 pb-2">
                </div>
            
            <div id="search-no-results" class="hidden text-center p-6 text-gray-500 dark:text-gray-400">Tidak ada hasil.</div>

            <div id="ayah-details" class="hidden mt-0 flex flex-col flex-grow overflow-hidden">
                <div id="scrollable-ayah-container" class="flex-grow overflow-y-auto pr-2">
                    <div id="ayah-content" class="space-y-6"></div>
                </div>
                <div id="ayah-pagination" class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 flex-shrink-0">
                    <button id="prev-ayah-button" onclick="changePage(-1)" disabled class="py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-xl font-bold transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-300 dark:hover:bg-gray-600">&larr; Sebelumnya</button>
                    <span id="page-info" class="text-sm font-medium text-gray-600 dark:text-gray-400">Halaman 1/1</span>
                    <button id="next-ayah-button" onclick="changePage(1)" disabled class="py-2 px-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">Selanjutnya &rarr;</button>
                </div>
            </div>
        </div>
        
        <div id="checklist-view" class="hidden transition-opacity duration-300 flex flex-col flex-grow overflow-hidden">
            <h2 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-4 text-center">Checklist Shalat Harian</h2>
            <p id="checklist-date" class="text-center text-sm text-gray-500 dark:text-gray-400 mb-6"></p>
            
            <div id="checklist-container" class="flex-grow overflow-y-auto pr-2 landscape:grid landscape:grid-cols-2 landscape:gap-4">
                <div>
                    <h3 class="text-base font-semibold text-emerald-600 dark:text-emerald-400 mb-3 sticky top-0 bg-white dark:bg-gray-800 py-1">Shalat Fardu</h3>
                    <div id="fardu-checklist" class="space-y-3"><div class="text-center p-6 text-gray-500 dark:text-gray-400">Memuat...</div></div>
                </div>
                <div>
                    <hr class="my-6 border-gray-200 dark:border-gray-600 landscape:hidden">
                    <h3 class="text-base font-semibold text-blue-600 dark:text-blue-400 mb-3 sticky top-0 bg-white dark:bg-gray-800 py-1">Shalat Sunnah</h3>
                    <div id="sunnah-checklist" class="space-y-3"></div>
                </div>
            </div>
            <button id="reset-checklist-button" class="mt-6 w-full py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow-lg transition duration-200 flex-shrink-0">Reset Checklist Hari Ini</button>
        </div>
        <div id="error-message" class="hidden text-center p-6 bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 border border-red-300 dark:border-red-600 rounded-lg mt-4">Terjadi kesalahan.</div>
        
        <footer class="mt-4 text-center text-xs text-gray-500 dark:text-gray-400 flex-shrink-0">
            &copy; 2024 Original Design by <a href="https://wa.me/6282395223314" target="_blank" class="text-emerald-600 dark:text-emerald-400 hover:underline font-semibold">aL-Ihsan Computer</a>
        </footer>
    </div>
    
    <div id="mini-player" class="fixed bottom-4 sm:bottom-6 left-1/2 -translate-x-1/2 w-[calc(100%-2rem)] max-w-md landscape:max-w-5xl mx-auto bg-gray-900 dark:bg-gray-200 text-white dark:text-gray-900 p-3 pr-2 rounded-xl shadow-2xl flex items-center justify-between space-x-3 transition-all duration-300 ease-out transform translate-y-24 opacity-0 z-50" role="dialog" aria-label="Pemutar Audio" style="display: none;">
        <button id="mini-player-toggle" class="p-2 rounded-full bg-emerald-500 text-white hover:bg-emerald-600 transition-all flex-shrink-0" aria-label="Putar/Jeda"></button>
        <div class="flex-grow min-w-0">
            <p class="text-sm font-medium truncate" id="mini-player-title">Sedang memutar...</p>
            <p class="text-xs text-gray-400 dark:text-gray-600" id="mini-player-subtitle">Audio</p>
        </div>
        <button id="mini-player-close" class="p-2 rounded-full text-gray-500 dark:text-gray-700 hover:bg-gray-700 dark:hover:bg-gray-300 transition-all flex-shrink-0" aria-label="Tutup Pemutar"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db, userId = null;
        
        const translationToggleButton = document.getElementById('toggle-translation-button');
        const bookmarkButton = document.getElementById('bookmark-button');

        let globalAudioPlayer = new Audio();
        let currentPlayingButton = null; 
        let miniPlayer = null, miniPlayerTitle = null, miniPlayerSubtitle = null, miniPlayerToggle = null, miniPlayerClose = null;
        let restoredAudioSrc = null, restoredAudioTime = 0;
        let currentPlayingAyahContainer = null;

        window.addEventListener('beforeunload', () => {
            if (globalAudioPlayer && !globalAudioPlayer.paused && globalAudioPlayer.currentTime > 0) {
                sessionStorage.setItem('lastAudioSrc', globalAudioPlayer.src);
                sessionStorage.setItem('lastAudioTime', globalAudioPlayer.currentTime);
            }
        });

        const playIconSvg = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>`;
        const pauseIconSvg = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 00-1 1v2a1 1 0 001 1h1a1 1 0 001-1V9a1 1 0 00-1-1H7zm5 0a1 1 0 00-1 1v2a1 1 0 001 1h1a1 1 0 001-1V9a1 1 0 00-1-1h-1z" clip-rule="evenodd"></path></svg>`;
        const loadingIconSvg = `<svg class="w-5 h-5 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
        
        async function initializeFirebaseAndAuth() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    onAuthStateChanged(auth, async (user) => {
                        if (user) userId = user.uid;
                        else if (!initialAuthToken) {
                            try { const u = await signInAnonymously(auth); userId = u.user.uid; } catch(e) {}
                        }
                        startApp(); 
                    });
                    if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                } else { startApp(); }
            } catch (error) { document.getElementById('loading').textContent = 'Error Init Firebase'; }
        }
        
        let PRAYER_TIMES = [], LOKASI_KOTA = "Makassar", prayerInterval; 

        async function fetchPrayerTimes(loadingEl) {
            try {
                const now = new Date(), thn = now.getFullYear(), bln = (now.getMonth()+1).toString().padStart(2,'0'), tgl = now.getDate().toString().padStart(2,'0');
                const crRes = await fetch(`https://api.myquran.com/v2/sholat/kota/cari/${LOKASI_KOTA}`);
                const crDat = await crRes.json();
                if (!crDat.data?.length) throw new Error("Kota tidak ditemukan");
                const idKota = crDat.data[0].id; LOKASI_KOTA = crDat.data[0].lokasi;
                document.getElementById('location-display').textContent = LOKASI_KOTA;
                
                const scRes = await fetch(`https://api.myquran.com/v2/sholat/jadwal/${idKota}/${thn}/${bln}/${tgl}`);
                const scDat = await scRes.json();
                const j = scDat.data.jadwal;
                PRAYER_TIMES = [{name:"Imsak",time:j.imsak},{name:"Subuh",time:j.subuh},{name:"Syuruk",time:j.terbit},{name:"Dhuha",time:j.dhuha},{name:"Dzuhur",time:j.dzuhur},{name:"Ashar",time:j.ashar},{name:"Maghrib",time:j.maghrib},{name:"Isya",time:j.isya}];
                return true; 
            } catch (e) { 
                if(loadingEl) loadingEl.textContent = `Gagal: ${e.message}`; 
                return false; 
            }
        }
        
        async function loadPrayerTimesForLocation() {
            const listContainer = document.getElementById('prayer-times-list');
            listContainer.innerHTML = `<div id="loading" class="col-span-2 text-center p-6 text-gray-500"></div>`;
            document.getElementById('loading').textContent = `Memuat jadwal ${LOKASI_KOTA}...`;
            if (await fetchPrayerTimes(document.getElementById('loading'))) updateUI(); 
        }

        async function handleChangeLocation() {
            const val = document.getElementById('location-input').value.trim();
            if (val && val.toLowerCase() !== LOKASI_KOTA.toLowerCase()) {
                LOKASI_KOTA = val; document.getElementById('location-input').value = '';
                stopAudioPlayback(); if (prayerInterval) clearInterval(prayerInterval);
                await loadPrayerTimesForLocation(); prayerInterval = setInterval(updateUI, 1000);
            }
        }
        
        function getNextPrayerTime(now) {
            if (!PRAYER_TIMES.length) return { nextPrayer: null, timeRemainingMs: 0 };
            const curMin = now.getHours()*60 + now.getMinutes();
            let next = null, minDiff = Infinity;
            for (const p of PRAYER_TIMES) {
                const [h,m] = p.time.split(':').map(Number);
                let diff = (h*60+m) - curMin;
                if (diff <= 0) diff += 1440;
                if (diff < minDiff) { minDiff = diff; next = p; }
            }
            if (!next && PRAYER_TIMES.length) { next = PRAYER_TIMES[0]; minDiff = ((parseInt(next.time.split(':')[0])*60 + parseInt(next.time.split(':')[1])) - curMin + 1440) % 1440; }
            return { nextPrayer: next, timeRemainingMs: (minDiff*60 - now.getSeconds())*1000 };
        }

        function formatCountdown(ms) {
            const t = Math.max(0, Math.floor(ms/1000));
            return [Math.floor(t/3600), Math.floor((t%3600)/60), t%60].map(v=>v.toString().padStart(2,'0')).join(':');
        }

        function updatePrayerListUI(nextName) {
            const list = document.getElementById('prayer-times-list');
            if(!list || !PRAYER_TIMES.length) return;
            if(document.getElementById('loading')) list.innerHTML = '';
            
            PRAYER_TIMES.forEach(p => {
                let el = document.getElementById(`prayer-${p.name}`);
                const isNext = (p.name === nextName);
                const cls = `prayer-list-item p-2 rounded-xl shadow-md flex flex-col items-center justify-center text-center ${isNext ? 'is-next-prayer' : 'bg-white dark:bg-gray-700 border border-gray-100 dark:border-gray-700'}`;
                if (!el) {
                    list.insertAdjacentHTML('beforeend', `<div id="prayer-${p.name}" class="${cls}"><span class="prayer-name text-sm font-medium text-gray-900 dark:text-gray-200">${p.name}</span><span class="prayer-time text-lg font-bold text-emerald-600 dark:text-emerald-400">${p.time}</span></div>`);
                } else el.className = cls;
            });
        }

        function updateUI() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString('id-ID', {hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
            document.getElementById('current-date').textContent = now.toLocaleDateString('id-ID', {weekday:'long',year:'numeric',month:'long',day:'numeric'});
            if (PRAYER_TIMES.length) {
                const { nextPrayer, timeRemainingMs } = getNextPrayerTime(now);
                if (nextPrayer) {
                    document.getElementById('next-prayer-display').innerHTML = `<span class="font-bold">${nextPrayer.name}</span> dalam <span class="font-mono">${formatCountdown(timeRemainingMs)}</span>`;
                    updatePrayerListUI(nextPrayer.name);
                }
            }
        }
        
        const BASE_QURAN_API = 'https://api.quran.com/api/v4';
        let surahListCache = []; 
        let juzListCache = [];
        
        let currentSurahId = null, currentPage = 1, totalPages = 1, allVerses = [], surahPages = [];
        let isTranslationVisible = true; 

        function playAudio(audioUrl, buttonElement) {
            let trackTitle = "Audio", trackSubtitle = "Sedang memutar...";
            
            if (currentPlayingAyahContainer) {
                currentPlayingAyahContainer.classList.remove('highlight-playing');
                currentPlayingAyahContainer = null;
            }

            if (buttonElement && buttonElement.ariaLabel) {
                 trackSubtitle = buttonElement.ariaLabel.startsWith("Putar Surah") ? "Surah" : "Ayat";
                 trackTitle = buttonElement.ariaLabel.replace("Putar Surah ", "").replace("Putar Ayat ", "Ayat ");
            }

            if (restoredAudioSrc === audioUrl && globalAudioPlayer.src === restoredAudioSrc) {
                restoredAudioSrc = null; restoredAudioTime = 0;
                if (currentPlayingButton && currentPlayingButton !== buttonElement) {
                    currentPlayingButton.innerHTML = playIconSvg; currentPlayingButton.disabled = false;
                }
                buttonElement.innerHTML = loadingIconSvg; buttonElement.disabled = true;
                showMiniPlayer(trackTitle, trackSubtitle);
                if (miniPlayerToggle) miniPlayerToggle.innerHTML = loadingIconSvg;
                
                globalAudioPlayer.play().then(() => {
                    buttonElement.innerHTML = pauseIconSvg; buttonElement.disabled = false;
                    if (miniPlayerToggle) miniPlayerToggle.innerHTML = pauseIconSvg;
                    const parent = buttonElement.closest('div.p-4');
                    if(parent) {
                        parent.classList.add('highlight-playing');
                        currentPlayingAyahContainer = parent;
                        parent.scrollIntoView({behavior: "smooth", block: "center"});
                    }
                });
                currentPlayingButton = buttonElement;
                return;
            }

            if (globalAudioPlayer.src === audioUrl && !globalAudioPlayer.paused) {
                globalAudioPlayer.pause();
                buttonElement.innerHTML = playIconSvg; currentPlayingButton = null;
                if (miniPlayerToggle) miniPlayerToggle.innerHTML = playIconSvg;
                if (globalAudioPlayer.currentTime > 0 && !globalAudioPlayer.ended) {
                     sessionStorage.setItem('lastAudioSrc', globalAudioPlayer.src);
                     sessionStorage.setItem('lastAudioTime', globalAudioPlayer.currentTime);
                }
            } else {
                if (currentPlayingButton) { currentPlayingButton.innerHTML = playIconSvg; currentPlayingButton.disabled = false; }
                globalAudioPlayer.pause();
                if (globalAudioPlayer.src !== audioUrl) { globalAudioPlayer.src = audioUrl; globalAudioPlayer.currentTime = 0; }
                
                buttonElement.innerHTML = loadingIconSvg; buttonElement.disabled = true;
                showMiniPlayer(trackTitle, trackSubtitle);
                if (miniPlayerToggle) miniPlayerToggle.innerHTML = loadingIconSvg;

                globalAudioPlayer.play().then(() => {
                    buttonElement.innerHTML = pauseIconSvg; buttonElement.disabled = false;
                    if (miniPlayerToggle) miniPlayerToggle.innerHTML = pauseIconSvg;
                    const parent = buttonElement.closest('div.p-4');
                    if(parent) {
                        parent.classList.add('highlight-playing');
                        currentPlayingAyahContainer = parent;
                        parent.scrollIntoView({behavior: "smooth", block: "center"});
                    }
                }).catch(e => {
                    console.error("Audio error:", e);
                    buttonElement.innerHTML = playIconSvg; buttonElement.disabled = false;
                    hideMiniPlayer();
                });
                currentPlayingButton = buttonElement;
            }
        }
        
        function setupAudioPlayerListeners() {
            miniPlayer = document.getElementById('mini-player');
            miniPlayerTitle = document.getElementById('mini-player-title');
            miniPlayerSubtitle = document.getElementById('mini-player-subtitle');
            miniPlayerToggle = document.getElementById('mini-player-toggle');
            miniPlayerClose = document.getElementById('mini-player-close');

            if (!miniPlayer) return;

            miniPlayerToggle.addEventListener('click', () => {
                if (globalAudioPlayer.paused) globalAudioPlayer.play(); else globalAudioPlayer.pause();
            });
            miniPlayerClose.addEventListener('click', stopAudioPlayback);

            globalAudioPlayer.onended = () => {
                if (currentPlayingButton) { currentPlayingButton.innerHTML = playIconSvg; currentPlayingButton.disabled = false; currentPlayingButton = null; }
                if (currentPlayingAyahContainer) { currentPlayingAyahContainer.classList.remove('highlight-playing'); currentPlayingAyahContainer = null; }
                hideMiniPlayer(); sessionStorage.removeItem('lastAudioSrc');
            };
            globalAudioPlayer.onpause = () => { if(miniPlayerToggle) miniPlayerToggle.innerHTML = playIconSvg; };
            globalAudioPlayer.onplay = () => { if(miniPlayerToggle) miniPlayerToggle.innerHTML = pauseIconSvg; if(currentPlayingButton) currentPlayingButton.innerHTML = pauseIconSvg; };
        }
        
        function showMiniPlayer(t, s) {
            if(!miniPlayer) return;
            miniPlayerTitle.textContent = t; miniPlayerSubtitle.textContent = s;
            miniPlayer.style.display = 'flex'; 
            setTimeout(() => miniPlayer.classList.remove('translate-y-24', 'opacity-0'), 10);
        }
        function hideMiniPlayer() { if(miniPlayer) { miniPlayer.classList.add('translate-y-24', 'opacity-0'); setTimeout(()=>miniPlayer.style.display='none',300); } }
        function stopAudioPlayback() {
            if (!globalAudioPlayer.paused) {
                globalAudioPlayer.pause();
                if (globalAudioPlayer.currentTime>0) { sessionStorage.setItem('lastAudioSrc', globalAudioPlayer.src); sessionStorage.setItem('lastAudioTime', globalAudioPlayer.currentTime); }
            }
            if (currentPlayingButton) { currentPlayingButton.innerHTML = playIconSvg; currentPlayingButton.disabled = false; currentPlayingButton = null; }
            if (currentPlayingAyahContainer) { currentPlayingAyahContainer.classList.remove('highlight-playing'); currentPlayingAyahContainer = null; }
            hideMiniPlayer();
        }

        async function fetchSurahList() {
            const l = document.getElementById('quran-loading'); const el = document.getElementById('surah-list');
            l.classList.remove('hidden'); el.innerHTML = '';
            try {
                const r = await fetch(`${BASE_QURAN_API}/chapters?language=id`);
                const d = await r.json(); surahListCache = d.chapters;
                l.classList.add('hidden'); renderSurahList(surahListCache);
            } catch (e) { l.textContent = `Gagal: ${e.message}`; }
        }

        async function fetchJuzList() {
            const el = document.getElementById('juz-list');
            if(juzListCache.length > 0) { renderJuzList(); return; }
            try {
                const r = await fetch(`${BASE_QURAN_API}/juzs`);
                const d = await r.json();
                juzListCache = d.juzs;
                renderJuzList();
            } catch(e) { console.error("Gagal fetch Juz", e); }
        }

        function renderJuzList() {
            const el = document.getElementById('juz-list');
            el.innerHTML = '';
            juzListCache.forEach(juz => {
                const btn = document.createElement('button');
                btn.className = "p-3 bg-gray-100 dark:bg-gray-700 hover:bg-emerald-100 dark:hover:bg-emerald-900 rounded-lg text-sm font-bold text-gray-700 dark:text-gray-200 shadow-sm transition";
                btn.textContent = `Juz ${juz.juz_number}`;
                btn.onclick = () => openJuz(juz);
                el.appendChild(btn);
            });
        }

        async function openJuz(juzData) {
            const mapping = juzData.verse_mapping;
            const startSurahId = Object.keys(mapping)[0];
            const startVerseRange = mapping[startSurahId];
            const startVerseNum = startVerseRange.split('-')[0];
            renderSurahDetails(parseInt(startSurahId), "Memuat Juz...", "", 1, true, parseInt(startVerseNum));
        }
        
        function renderSurahList(list) {
            const el = document.getElementById('surah-list'); document.getElementById('search-no-results').classList.add('hidden');
            el.innerHTML = '';
            if (!list.length) { document.getElementById('search-no-results').classList.remove('hidden'); return; }
            
            list.forEach(s => {
                const b = document.createElement('button');
                b.className = 'surah-button w-full bg-gray-100 dark:bg-gray-700 dark:text-gray-200 shadow-sm hover:bg-emerald-50 dark:hover:bg-gray-600 transition duration-150';
                const audio = `https://cdn.islamic.network/quran/audio-surah/128/ar.alafasy/${s.id}.mp3`;
                let playCls = "surah-play-button p-2 rounded-full text-emerald-600 dark:text-emerald-400 hover:bg-emerald-100 dark:hover:bg-gray-600 transition";
                if(restoredAudioSrc === audio) playCls += " animate-pulse";
                
                b.innerHTML = `
                    <div class="flex flex-col items-start"><span class="font-bold text-base text-emerald-700 dark:text-emerald-300">${s.id}. ${s.name_simple}</span><p class="text-xs text-gray-500 dark:text-gray-400">${s.translated_name.name} - ${s.revelation_place==='makkah'?'Makkiyah':'Madaniyah'}</p><p class="text-xs text-gray-400 dark:text-gray-500">${s.verses_count} Ayat</p></div>
                    <div class="flex items-center space-x-3"><span class="ayah-arabic text-xl text-emerald-600 dark:text-emerald-400">${s.name_arabic}</span><button type="button" class="${playCls}" data-audio-url="${audio}" aria-label="Putar Surah ${s.name_simple}">${playIconSvg}</button></div>`;
                b.addEventListener('click', () => { stopAudioPlayback(); renderSurahDetails(s.id, s.name_simple, s.name_arabic); });
                b.querySelector('.surah-play-button').addEventListener('click', (e) => { e.stopPropagation(); playAudio(audio, e.currentTarget); });
                el.appendChild(b);
            });
            el.scrollTop = 0;
        }

        window.searchSurah = (q) => {
            const v = q.toLowerCase().trim();
            if (v==="") { renderSurahList(surahListCache); return; }
            renderSurahList(surahListCache.filter(s => s.name_simple.toLowerCase().includes(v) || s.translated_name.name.toLowerCase().includes(v) || s.id.toString()===v));
        }

        async function renderSurahDetails(surahId, simpleName, arabicName, page = 1, pushState = true, jumpToVerseNumber = null) {
            document.getElementById('list-nav-tabs').classList.add('hidden'); 
            document.getElementById('surah-list').classList.add('hidden');
            document.getElementById('juz-list').classList.add('hidden');
            document.getElementById('search-container').classList.add('hidden');
            document.getElementById('load-bookmark-container')?.classList.add('hidden');
            
            const detailsEl = document.getElementById('ayah-details');
            const contentEl = document.getElementById('ayah-content');
            const titleEl = document.getElementById('header-surah-title');

            detailsEl.classList.remove('hidden');
            contentEl.innerHTML = `<p class="text-center p-6 text-gray-500 dark:text-gray-400">Memuat ayat-ayat...</p>`;
            titleEl.textContent = simpleName ? `${simpleName} (${arabicName})` : `Surah ${surahId}`;
            titleEl.classList.remove('hidden');

            document.getElementById('back-to-prayer-icon').classList.remove('hidden');
            document.getElementById('checklist-icon-button').classList.add('hidden'); 
            translationToggleButton.classList.remove('hidden'); bookmarkButton.classList.remove('hidden'); updateTranslationButtonUI();
            
            currentSurahId = surahId; currentPage = page;

            if (pushState) history.pushState({ view: 'ayahDetail', surahId, simpleName, arabicName, page }, `${simpleName}`, `#surah/${surahId}/page/${page}`);

            try {
                if (!allVerses.length || !allVerses[0].verse_key.startsWith(surahId + ':')) {
                    const r = await fetch(`${BASE_QURAN_API}/verses/by_chapter/${surahId}?language=id&words=false&translations=33&fields=text_uthmani,verse_key,verse_number,page_number&per_page=300`);
                    const d = await r.json();
                    if (!d.verses?.length) { contentEl.innerHTML = `<p class="text-center text-red-500">Ayat tidak ditemukan.</p>`; return; }
                    allVerses = d.verses;
                    surahPages = [...new Set(allVerses.map(v => v.page_number))];
                    totalPages = surahPages.length;
                    
                    if(simpleName === "Memuat Juz...") {
                        const sInfo = surahListCache.find(s => s.id === surahId);
                        if(sInfo) {
                            titleEl.textContent = `${sInfo.name_simple} (${sInfo.name_arabic})`;
                             history.replaceState({ view: 'ayahDetail', surahId, simpleName: sInfo.name_simple, arabicName: sInfo.name_arabic, page }, `${sInfo.name_simple}`, `#surah/${surahId}/page/${page}`);
                        }
                    }
                }
                
                if (jumpToVerseNumber) {
                    const targetVerse = allVerses.find(v => v.verse_number === jumpToVerseNumber);
                    if (targetVerse) {
                        const targetPage = targetVerse.page_number;
                        const pageIndex = surahPages.indexOf(targetPage);
                        if(pageIndex !== -1) currentPage = pageIndex + 1;
                    }
                }

                renderAyahPage();
                document.getElementById('scrollable-ayah-container').scrollTo({ top: 0, behavior: 'instant' });

            } catch (e) { console.error(e); contentEl.innerHTML = `<p class="text-center text-red-500">Gagal memuat ayat.</p>`; }
        }

        function renderAyahPage() {
            const el = document.getElementById('ayah-content'); el.innerHTML = '';
            const curPageNum = surahPages[currentPage - 1];
            const verses = allVerses.filter(v => v.page_number === curPageNum);

            if (currentPage === 1 && currentSurahId !== 1 && currentSurahId !== 9) 
                 el.innerHTML += `<p class="ayah-arabic text-center mb-4 text-2xl font-light text-gray-900 dark:text-gray-100">بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ</p>`;

            verses.forEach(v => {
                const sPad = currentSurahId.toString().padStart(3,'0'), vPad = v.verse_number.toString().padStart(3,'0');
                const audio = `https://everyayah.com/data/Alafasy_128kbps/${sPad}${vPad}.mp3`;
                let playCls = "ayah-play-button p-1 rounded-full text-emerald-600 dark:text-emerald-400 hover:bg-emerald-100 dark:hover:bg-gray-600 transition";
                if(restoredAudioSrc === audio) playCls += " animate-pulse";

                const div = document.createElement('div');
                div.className = 'p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl shadow-md border-b border-gray-200 dark:border-gray-700 transition-all duration-300';
                
                if (globalAudioPlayer.src === audio && !globalAudioPlayer.paused) {
                    div.classList.add('highlight-playing');
                    currentPlayingAyahContainer = div;
                }

                div.innerHTML = `
                    <div class="flex justify-between items-center mb-3 pb-3 border-b border-gray-200 dark:border-gray-600">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-bold text-emerald-600 dark:text-emerald-400">QS ${currentSurahId}:${v.verse_number}</span>
                            <button class="text-xs text-gray-400 hover:text-emerald-600 transition" onclick="showTafsir('${v.verse_key}', ${currentSurahId}, ${v.verse_number})" aria-label="Lihat Tafsir"><i class="fas fa-book-open"></i></button>
                        </div>
                        <button type="button" class="${playCls}" data-audio-url="${audio}" aria-label="Putar Ayat ${v.verse_number}">${playIconSvg}</button>
                    </div>
                    <p class="ayah-arabic mb-4 text-gray-900 dark:text-gray-100 text-right" style="direction: rtl;">${v.text_uthmani}</p>
                    <p class="${isTranslationVisible?'':'hidden'} translation-text text-sm text-gray-700 dark:text-gray-300 italic pt-3 border-t border-gray-200 dark:border-gray-600">${v.translations?v.translations[0].text:''}</p>
                `;
                div.querySelector('.ayah-play-button').addEventListener('click', (e) => { e.stopPropagation(); playAudio(audio, e.currentTarget); });
                el.appendChild(div);
            });
            updatePaginationUI();
        }

        window.showTafsir = async (verseKey, surahId, verseNum) => {
            const modal = document.getElementById('tafsir-modal');
            const title = document.getElementById('tafsir-title');
            const content = document.getElementById('tafsir-content');
            const loading = document.getElementById('tafsir-loading');
            
            modal.classList.remove('hidden');
            title.textContent = `Tafsir QS ${surahId}:${verseNum}`;
            content.innerHTML = '';
            content.classList.add('hidden');
            loading.classList.remove('hidden');

            try {
                const res = await fetch(`${BASE_QURAN_API}/quran/tafsirs/158?verse_key=${verseKey}`);
                const data = await res.json();
                
                if (data.tafsirs && data.tafsirs.length > 0) {
                    content.innerHTML = data.tafsirs[0].text;
                } else {
                    content.innerHTML = "Tafsir tidak ditemukan untuk ayat ini.";
                }
            } catch (e) {
                content.innerHTML = "Gagal memuat tafsir. Periksa koneksi internet.";
            } finally {
                loading.classList.add('hidden');
                content.classList.remove('hidden');
            }
        };

        window.closeTafsir = () => { document.getElementById('tafsir-modal').classList.add('hidden'); };

        window.switchListTab = (tab) => {
            const surahBtn = document.getElementById('tab-surah');
            const juzBtn = document.getElementById('tab-juz');
            const surahList = document.getElementById('surah-list');
            const juzList = document.getElementById('juz-list');
            const searchContainer = document.getElementById('search-container');

            if (tab === 'surah') {
                surahBtn.className = "pb-2 px-4 tab-active transition-all";
                juzBtn.className = "pb-2 px-4 tab-inactive transition-all";
                surahList.classList.remove('hidden');
                juzList.classList.add('hidden');
                searchContainer.classList.remove('hidden'); 
            } else {
                surahBtn.className = "pb-2 px-4 tab-inactive transition-all";
                juzBtn.className = "pb-2 px-4 tab-active transition-all";
                surahList.classList.add('hidden');
                juzList.classList.remove('hidden');
                searchContainer.classList.add('hidden'); 
                fetchJuzList();
            }
        };

        window.changePage = (d) => {
            const np = currentPage + d;
            if (np < 1 || np > totalPages) return;
            currentPage = np;
             const sInfo = surahListCache.find(s => s.id === currentSurahId);
             const sName = sInfo ? sInfo.name_simple : `Surah ${currentSurahId}`;
             const sArab = sInfo ? sInfo.name_arabic : '';
             history.pushState({ view: 'ayahDetail', surahId: currentSurahId, simpleName: sName, arabicName: sArab, page: currentPage }, sName, `#surah/${currentSurahId}/page/${currentPage}`);
            
            stopAudioPlayback(); renderAyahPage();
            document.getElementById('scrollable-ayah-container').scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function updatePaginationUI() {
            document.getElementById('prev-ayah-button').disabled = (currentPage === 1);
            document.getElementById('next-ayah-button').disabled = (currentPage === totalPages);
            document.getElementById('page-info').innerHTML = `Hal. Quran: <b>${surahPages[currentPage-1]}</b> <span class="text-xs ml-1 opacity-70">(${currentPage}/${totalPages})</span>`;
        }
        
        window.toggleTranslation = () => {
            isTranslationVisible = !isTranslationVisible;
            if(currentSurahId) document.querySelectorAll('.translation-text').forEach(e => e.classList.toggle('hidden', !isTranslationVisible));
            updateTranslationButtonUI();
        }

        function updateTranslationButtonUI() {
            const o = document.getElementById('translation-eye-open'), c = document.getElementById('translation-eye-closed');
            if(isTranslationVisible) { o.classList.remove('hidden'); c.classList.add('hidden'); } else { o.classList.add('hidden'); c.classList.remove('hidden'); }
        }

        function saveBookmark() {
            if(!currentSurahId) return;
            const t = document.getElementById('header-surah-title').textContent, m = t.match(/(.*) \((.*)\)/);
            if(!m) return;
            localStorage.setItem('quranBookmark', JSON.stringify({ surahId: currentSurahId, simpleName: m[1].trim(), arabicName: m[2].trim(), page: currentPage }));
            bookmarkButton.style.color = '#10b981'; setTimeout(() => bookmarkButton.style.color = '', 1000);
            checkAndDisplayBookmarkButton();
        }

        function checkAndDisplayBookmarkButton() {
            const c = document.getElementById('load-bookmark-container'), b = document.getElementById('load-bookmark-button'), d = localStorage.getItem('quranBookmark');
            if(d && c && b) { try { const j=JSON.parse(d); b.textContent = `Lanjutkan: ${j.simpleName}`; c.classList.remove('hidden'); } catch(e){ localStorage.removeItem('quranBookmark'); } } else if(c) c.classList.add('hidden');
        }
        document.getElementById('load-bookmark-button').addEventListener('click', () => {
            const d = JSON.parse(localStorage.getItem('quranBookmark'));
            if(d) renderSurahDetails(d.surahId, d.simpleName, d.arabicName, d.page);
        });
        window.clearBookmark = (e) => { e.stopPropagation(); localStorage.removeItem('quranBookmark'); document.getElementById('load-bookmark-container').classList.add('hidden'); }

        function setupDarkMode() {
            const s=document.getElementById('sunIcon'), m=document.getElementById('moonIcon');
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.body.classList.add('dark'); m.classList.add('hidden'); s.classList.remove('hidden'); } else { document.body.classList.remove('dark'); s.classList.add('hidden'); m.classList.remove('hidden'); }
            document.getElementById('darkModeToggle').addEventListener('click', () => {
                document.body.classList.toggle('dark');
                if(document.body.classList.contains('dark')) { m.classList.add('hidden'); s.classList.remove('hidden'); localStorage.setItem('theme','dark'); } else { s.classList.add('hidden'); m.classList.remove('hidden'); localStorage.setItem('theme','light'); }
            });
        }
        
        const CHECKLIST_KEY = 'dailyChecklist', OBLIGATORY_PRAYERS = ['Subuh', 'Dzuhur', 'Ashar', 'Maghrib', 'Isya'], SUNNAH_PRAYERS = ['Tahajud', 'Witir', 'Qobliyah Subuh', 'Dhuha', 'Qobliyah Dzuhur', 'Badiyah Dzuhur', 'Qobliyah Ashar', 'Qobliyah Maghrib', 'Badiyah Maghrib', 'Qobliyah Isya', 'Badiyah Isya'];

        function getChecklistState() {
            const t = new Date().toLocaleDateString('id-ID'); let d; try { d=JSON.parse(localStorage.getItem(CHECKLIST_KEY)); } catch(e){ d=null; }
            if (d && d.date === t) return d;
            const n = { date: t, fardu: {}, sunnah: {} };
            OBLIGATORY_PRAYERS.forEach(p => n.fardu[p]=false); SUNNAH_PRAYERS.forEach(p => n.sunnah[p]=false);
            localStorage.setItem(CHECKLIST_KEY, JSON.stringify(n)); return n;
        }

        function renderChecklist() {
            const f = document.getElementById('fardu-checklist'), s = document.getElementById('sunnah-checklist'), st = getChecklistState();
            document.getElementById('checklist-date').textContent = `Untuk Hari: ${st.date}`;
            f.innerHTML=''; s.innerHTML='';
            const gen = (p, c, t) => `
                <label class="flex items-center justify-between w-full p-4 rounded-lg shadow-md cursor-pointer transition-all duration-200 ${c?'bg-emerald-50 dark:bg-emerald-900/50 border-l-4 border-emerald-500':'bg-white dark:bg-gray-700'}">
                    <span class="text-lg font-semibold text-gray-800 dark:text-gray-100">${p}</span>
                    <input type="checkbox" data-prayer="${p}" data-type="${t}" class="checklist-item w-6 h-6 text-emerald-600 rounded focus:ring-emerald-500" ${c?'checked':''}>
                </label>`;
            OBLIGATORY_PRAYERS.forEach(p => f.insertAdjacentHTML('beforeend', gen(p, st.fardu[p], 'fardu')));
            SUNNAH_PRAYERS.forEach(p => s.insertAdjacentHTML('beforeend', gen(p, st.sunnah[p], 'sunnah')));
        }
        
        document.getElementById('checklist-container').addEventListener('change', (e) => {
            if(e.target.classList.contains('checklist-item')) {
                const s = getChecklistState(), p = e.target.dataset.prayer, t = e.target.dataset.type, c = e.target.checked;
                s[t][p] = c; localStorage.setItem(CHECKLIST_KEY, JSON.stringify(s));
                const l = e.target.closest('label');
                if(c) { l.classList.add('bg-emerald-50','dark:bg-emerald-900/50','border-l-4','border-emerald-500'); l.classList.remove('bg-white','dark:bg-gray-700'); }
                else { l.classList.remove('bg-emerald-50','dark:bg-emerald-900/50','border-l-4','border-emerald-500'); l.classList.add('bg-white','dark:bg-gray-700'); }
            }
        });
        document.getElementById('reset-checklist-button').addEventListener('click', () => {
            if(confirm('Reset checklist hari ini?')) { localStorage.removeItem(CHECKLIST_KEY); renderChecklist(); }
        });

        function toggleView() {
            stopAudioPlayback();
            const pv=document.getElementById('prayer-view'), qv=document.getElementById('quran-view'), cv=document.getElementById('checklist-view');
            if(qv.classList.contains('hidden')) {
                pv.classList.add('hidden'); qv.classList.remove('hidden'); cv.classList.add('hidden');
                document.getElementById('toggle-view-button').classList.add('hidden');
                document.getElementById('back-to-prayer-icon').classList.remove('hidden');
                document.getElementById('checklist-icon-button').classList.add('hidden');
                document.getElementById('list-nav-tabs').classList.remove('hidden'); 
                
                if(!surahListCache.length) fetchSurahList(); 
                else {
                    document.getElementById('surah-list').classList.remove('hidden');
                    document.getElementById('ayah-details').classList.add('hidden');
                    document.getElementById('search-container').classList.remove('hidden');
                    document.getElementById('header-surah-title').classList.add('hidden');
                    translationToggleButton.classList.add('hidden'); bookmarkButton.classList.add('hidden');
                    switchListTab('surah');
                }
                checkAndDisplayBookmarkButton();
                history.pushState({ view: 'quranList' }, 'Daftar Surah', '#quran');
            } else {
                qv.classList.add('hidden'); pv.classList.remove('hidden'); cv.classList.add('hidden');
                document.getElementById('toggle-view-button').classList.remove('hidden');
                document.getElementById('back-to-prayer-icon').classList.add('hidden');
                document.getElementById('checklist-icon-button').classList.remove('hidden');
            }
        }
        
        function showChecklistView() {
            stopAudioPlayback();
            document.getElementById('prayer-view').classList.add('hidden'); document.getElementById('quran-view').classList.add('hidden'); document.getElementById('checklist-view').classList.remove('hidden');
            document.getElementById('checklist-icon-button').classList.add('hidden'); document.getElementById('back-to-prayer-icon').classList.remove('hidden');
            document.getElementById('toggle-view-button').classList.add('hidden'); document.getElementById('header-surah-title').classList.add('hidden');
            translationToggleButton.classList.add('hidden'); bookmarkButton.classList.add('hidden');
            renderChecklist(); history.pushState({ view: 'checklist' }, 'Checklist', '#checklist');
        }

        document.getElementById('toggle-view-button').addEventListener('click', toggleView);
        document.getElementById('back-to-prayer-icon').addEventListener('click', () => history.back());
        document.getElementById('checklist-icon-button').addEventListener('click', showChecklistView);
        
        window.onpopstate = (e) => {
            stopAudioPlayback();
            const s = e.state || { view: 'prayer' };
            const views = ['prayer-view', 'quran-view', 'checklist-view'];
            views.forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById('toggle-view-button').classList.add('hidden');
            document.getElementById('back-to-prayer-icon').classList.add('hidden');
            document.getElementById('checklist-icon-button').classList.add('hidden');
            document.getElementById('header-surah-title').classList.add('hidden');
            translationToggleButton.classList.add('hidden'); bookmarkButton.classList.add('hidden');
            document.getElementById('list-nav-tabs').classList.add('hidden');

            if (s.view === 'ayahDetail') {
                document.getElementById('quran-view').classList.remove('hidden');
                document.getElementById('surah-list').classList.add('hidden');
                document.getElementById('juz-list').classList.add('hidden');
                document.getElementById('ayah-details').classList.remove('hidden');
                document.getElementById('back-to-prayer-icon').classList.remove('hidden');
                document.getElementById('header-surah-title').classList.remove('hidden');
                translationToggleButton.classList.remove('hidden'); bookmarkButton.classList.remove('hidden');
                if (currentSurahId !== s.surahId || currentPage !== s.page) renderSurahDetails(s.surahId, s.simpleName, s.arabicName, s.page, false);
            } else if (s.view === 'quranList') {
                document.getElementById('quran-view').classList.remove('hidden');
                document.getElementById('surah-list').classList.remove('hidden');
                document.getElementById('list-nav-tabs').classList.remove('hidden');
                document.getElementById('back-to-prayer-icon').classList.remove('hidden');
                document.getElementById('search-container').classList.remove('hidden');
                document.getElementById('ayah-details').classList.add('hidden');
                switchListTab('surah');
                checkAndDisplayBookmarkButton();
            } else if (s.view === 'checklist') {
                document.getElementById('checklist-view').classList.remove('hidden');
                document.getElementById('back-to-prayer-icon').classList.remove('hidden');
                renderChecklist();
            } else {
                document.getElementById('prayer-view').classList.remove('hidden');
                document.getElementById('toggle-view-button').classList.remove('hidden');
                document.getElementById('checklist-icon-button').classList.remove('hidden');
            }
        };

        async function startApp() {
            await loadPrayerTimesForLocation(); prayerInterval = setInterval(updateUI, 1000);
            
            document.getElementById('location-change-button').addEventListener('click', handleChangeLocation);
            document.getElementById('location-input').addEventListener('keyup', (e) => { if (e.key === 'Enter') handleChangeLocation(); });
            document.getElementById('bookmark-button').addEventListener('click', saveBookmark);
            
            setupAudioPlayerListeners();
            if (restoredAudioSrc) {
                const btn = document.querySelector(`[data-audio-url="${restoredAudioSrc}"]`);
                if (btn) playAudio(restoredAudioSrc, btn); else { globalAudioPlayer.src = restoredAudioSrc; globalAudioPlayer.currentTime = restoredAudioTime; }
            }

            const hash = window.location.hash;
            if (hash.startsWith('#surah/')) {
                const parts = hash.split('/');
                const sid = parseInt(parts[1]);
                let p = 1; if(parts[2]==='page') p = parseInt(parts[3]);
                if(!surahListCache.length) await fetchSurahList();
                const s = surahListCache.find(x => x.id === sid);
                if(s) renderSurahDetails(sid, s.name_simple, s.name_arabic, p, true);
            } else if (hash === '#quran') toggleView();
            else if (hash === '#checklist') showChecklistView();
        }

        window.onload = () => {
            const sSrc = sessionStorage.getItem('lastAudioSrc'), sTime = sessionStorage.getItem('lastAudioTime');
            if (sSrc && sTime) { restoredAudioSrc = sSrc; restoredAudioTime = parseFloat(sTime); sessionStorage.removeItem('lastAudioSrc'); sessionStorage.removeItem('lastAudioTime'); }
            setupDarkMode(); initializeFirebaseAndAuth();
        };

        const ISLAMIC_BACKUP_FACTS = ["Masjid Quba adalah masjid pertama.", "Al-Khawarizmi penemu Aljabar.", "Air Zamzam tak pernah kering."];
        async function loadIslamicHistory() {
             try {
                const t=new Date(), dd=String(t.getDate()).padStart(2,'0'), mm=String(t.getMonth()+1).padStart(2,'0'), yy=t.getFullYear();
                const r = await fetch(`https://api.aladhan.com/v1/gToH/${dd}-${mm}-${yy}`);
                const d = await r.json();
                document.getElementById('hijri-date-display').textContent = ` ${d.data.hijri.day} ${d.data.hijri.month.en} ${d.data.hijri.year} H`;
                document.getElementById('islamic-history-text').innerHTML = `<span class="text-emerald-300 font-bold text-xs uppercase tracking-wider mb-1 block">Tahukah Anda?</span><span class="italic text-white">"${ISLAMIC_BACKUP_FACTS[t.getDate()%ISLAMIC_BACKUP_FACTS.length]}"</span>`;
             } catch(e) {}
        }
        (function() {
            const tgt = new Date("Feb 18, 2026").getTime();
            setInterval(()=>{
                const n=new Date().getTime(), dis=tgt-n, d=Math.floor(dis/86400000), h=Math.floor((dis%86400000)/3600000), m=Math.floor((dis%3600000)/60000), s=Math.floor((dis%60000)/1000);
                document.getElementById("ramadhan-timer").innerHTML = `<span class="text-white font-mono">${d}H ${h}J ${m}M ${s}D</span>`;
            }, 1000);
            loadIslamicHistory();
        })();
        window.enterFullScreenApp = function() {
            const el = document.documentElement, o = document.getElementById('fullscreen-overlay');
            if (el.requestFullscreen) el.requestFullscreen().catch(()=>{});
            o.style.opacity = '0'; o.style.pointerEvents = 'none'; setTimeout(()=> { o.remove(); document.body.classList.remove('overflow-hidden'); }, 700);
        };
    </script>
    <script>if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(()=>{});</script>
</body>
</html>
