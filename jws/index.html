<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>aic | jws</title>

    <meta name="theme-color" content="#10b981">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Menggunakan font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap');
        
        /* === [TAMBAHAN DARI KODE 1: FONT UNTUK SPLASH SCREEN] === */
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Amiri&display=swap'); 

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; 
            color: #1f2937;
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Dark Mode Styles */
        body.dark {
            background-color: #111827; 
            color: #f3f4f6;
        }
        body.dark #app-container {
            background-color: #1f2937; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.7), 0 4px 6px -2px rgba(0, 0, 0, 0.3); 
        }
        
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .is-next-prayer {
            background-color: #fffbeb; 
            border-left: 5px solid #f59e0b; 
            font-weight: 700;
            transform: scale(1.02);
            transition: all 0.3s ease;
        }

        .is-next-prayer .prayer-name,
        .is-next-prayer .prayer-time {
            color: #1f2937 !important; 
        }

        body.dark .is-next-prayer {
            background-color: #fbbf2430; 
            border-left: 5px solid #fbbf24; 
        }
        body.dark .is-next-prayer .prayer-name,
        body.dark .is-next-prayer .prayer-time {
            color: #fef3c7 !important; 
        }
        
        .prayer-list-item {
            transition: all 0.3s ease;
        }
        .prayer-list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        body.dark .prayer-list-item:hover {
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        #darkModeToggle {
             transition: background-color 0.15s, color 0.15s, transform 0.15s;
        }
        
        .next-prayer-highlight {
            background-color: #f59e0b; 
            color: #fff; 
            box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.5), 0 2px 4px -2px rgba(245, 158, 11, 0.3);
        }

        .ayah-arabic {
            font-family: 'Traditional Arabic', 'Amiri', serif;
            font-size: 1.5rem; 
            line-height: 2.5rem; 
            text-align: right;
        }

        .surah-button {
            transition: background-color 0.2s;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .surah-button:hover {
            background-color: #f9fafb; 
        }
        body.dark .surah-button:hover {
            background-color: #374151; 
        }
        
        .translation-text {
            transition: opacity 0.3s ease;
            max-height: 1000px; 
        }
        .translation-text.hidden {
            opacity: 0;
            max-height: 0; 
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }

        /* === [TAMBAHAN DARI KODE 1: CSS UNTUK SPLASH SCREEN] === */
        .font-serif-display { font-family: 'Playfair Display', serif; }
        
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-down { animation: slideDown 0.8s ease-out forwards; }

        #fullscreen-overlay {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%2310b981' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

<div id="fullscreen-overlay" onclick="enterFullScreenApp()" class="fixed inset-0 z-[9999] bg-slate-900 flex flex-col justify-between items-center text-white cursor-pointer transition-opacity duration-700 select-none overflow-hidden py-12 md:py-16">
    
    <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-emerald-900/40 to-transparent pointer-events-none"></div>
    <div class="absolute bottom-0 left-0 w-full h-1/2 bg-gradient-to-t from-slate-950/90 to-transparent pointer-events-none"></div>

    <div class="text-center relative z-20 w-full px-4 animate-slide-down flex-shrink-0">
        <p class="text-xs md:text-sm text-emerald-400 mb-2 uppercase tracking-[0.3em] font-semibold opacity-80">Menuju Bulan Suci</p>
        <h1 class="text-4xl md:text-6xl font-black font-serif-display text-transparent bg-clip-text bg-gradient-to-r from-white via-emerald-100 to-white mb-2 drop-shadow-xl">RAMADHAN 1447 H</h1>
        <p class="text-[10px] md:text-xs text-slate-300 mb-6 font-mono tracking-widest opacity-60">Estimasi: 18 Februari 2026</p>
        <div id="ramadhan-timer" class="flex flex-wrap justify-center items-center gap-3 md:gap-6">
            <div class="animate-pulse text-gray-400 text-sm font-mono">Memuat waktu...</div>
        </div>
    </div>

    <div class="flex-grow flex flex-col items-center justify-center w-full z-20 group my-4">
        
        <div class="mb-6 relative inline-flex items-center justify-center animate-bounce">
             <div class="absolute -inset-8 bg-emerald-500/20 rounded-full blur-2xl opacity-70 group-hover:opacity-100 transition-opacity duration-500"></div>
             <i class="fas fa-fingerprint text-7xl md:text-8xl text-emerald-400 relative z-10 drop-shadow-[0_0_25px_rgba(52,211,153,0.6)]"></i>
        </div>

        <h2 class="text-2xl md:text-4xl font-black text-white uppercase tracking-[0.15em] mb-2 drop-shadow-lg leading-none">KETUK LAYAR</h2>
        <p class="text-xs md:text-sm text-emerald-200/80 font-medium tracking-wider uppercase">untuk masuk aplikasi</p>
    </div>

    <div class="relative z-30 w-full px-6 flex justify-center max-w-lg mx-auto flex-shrink-0">
        <div class="w-full group relative">
            <div class="absolute -inset-0.5 bg-gradient-to-r from-emerald-600 to-teal-900 rounded-xl blur opacity-20 transition duration-200"></div>
            <div class="relative bg-slate-900/80 backdrop-blur-md border-t border-emerald-500/30 p-4 text-center rounded-xl">
                <div class="flex items-center justify-center gap-2 mb-2">
                    <i class="fas fa-history text-emerald-400 text-xs"></i>
                    <span class="text-[10px] font-bold tracking-widest uppercase text-emerald-400">Wawasan Islam Hari Ini</span>
                    <span class="text-gray-600 text-[10px]">|</span>
                    <span id="hijri-date-display" class="text-emerald-200 text-[10px] font-mono tracking-wider font-bold">-</span>
                </div>
                <p id="islamic-history-text" class="text-xs md:text-sm text-gray-200 font-serif italic leading-relaxed">"Memuat wawasan sejarah..."</p>
            </div>
        </div>
    </div>
</div>
<div id="app-container" class="w-full max-w-md mx-auto bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-xl transition-colors duration-300 flex flex-col">
        
        <header class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-700 pb-4">
            
            <div class="flex items-center" style="min-width: 56px;"> <button id="checklist-icon-button" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150" aria-label="Buka Checklist Shalat">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                </button>
                
                <button id="back-to-prayer-icon" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150 hidden" aria-label="Kembali ke Waktu Sholat/Daftar Surah">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                </button>
            </div>
            
            <div class="flex-grow flex flex-col justify-center items-center sm:flex-row sm:justify-center sm:space-x-3">
                <h1 class="text-xl sm:text-2xl font-extrabold text-gray-900 dark:text-white mb-1 sm:mb-0">
                    aic | JWS
                </h1>
                <span id="header-surah-title" class="hidden text-base sm:text-lg font-semibold text-emerald-600 dark:text-emerald-400">
                    </span>
            </div>
            
            <div class="flex space-x-2" style="min-width: 56px;"> <button id="bookmark-button" 
                        class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150 hidden" 
                        aria-label="Simpan Bookmark Halaman Ini">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>
                </button>
                
                <button id="toggle-translation-button" 
                        class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150 hidden" 
                        aria-label="Toggle Terjemahan"
                        onclick="toggleTranslation()">
                    <svg id="translation-eye-open" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542 7z"></path></svg>
                    <svg id="translation-eye-closed" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7 1.274 4.057 5.065 7 9.542 7 1.05 0 2.083.178 3.064.51M12 16a4 4 0 00-4-4m-2.828 2.828l1.414 1.414M17.657 6.343l-1.414 1.414m-1.414 4.242l1.414 1.414m-4.242-8.484l1.414 1.414"></path></svg>
                </button>
                
                <button id="darkModeToggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150" aria-label="Toggle Dark Mode">
                    <svg id="sunIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="moonIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
            
        </header>

        <div id="prayer-view" class="transition-opacity duration-300 flex flex-col flex-grow overflow-hidden">
            
            <div class="prayer-card bg-gray-50 dark:bg-gray-700/50 p-6 rounded-2xl mb-6 text-center border border-gray-200 dark:border-gray-700 shadow-inner flex-shrink-0">
                <div id="current-date" class="text-lg text-gray-600 dark:text-gray-300 mb-2"></div>
                <div id="current-time" class="text-6xl font-extrabold text-emerald-600 dark:text-emerald-400 leading-tight"></div>
                
                <div id="next-prayer-display" class="mt-4 p-3 rounded-xl text-sm font-semibold shadow-md next-prayer-highlight">
                    Waktu sholat berikutnya akan ditampilkan di sini...
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-6 flex-grow overflow-y-auto pr-2" id="prayer-times-list">
                <div id="loading" class="col-span-2 text-center p-6 text-gray-500 dark:text-gray-400">Memuat aplikasi...</div>
            </div>

            <p class="text-center text-sm text-gray-500 dark:text-gray-400 pt-4 border-t border-gray-200 dark:border-gray-700 flex-shrink-0">Lokasi: <span id="location-display">Makassar</span></p>
            
            <div class="mt-4 flex space-x-2 flex-shrink-0">
                <input type="text" id="location-input" placeholder="Ganti Lokasi (e.g., Jakarta)"
                       class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-emerald-500 focus:border-emerald-500 transition duration-150">
                <button id="location-change-button"
                        class="py-2 px-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl shadow-lg transition duration-200">
                    Ubah
                </button>
            </div>
            
            <div class="flex justify-center mt-6 flex-shrink-0"> 
                <button id="toggle-view-button" 
                        class="w-full py-3 px-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl shadow-lg transition duration-200">
                    Baca Qur'an
                </button>
            </div>
        </div>

        <div id="quran-view" class="hidden transition-opacity duration-300 flex flex-col flex-grow overflow-hidden">
            
            <div id="load-bookmark-container" class="hidden relative mb-4 flex-shrink-0">
                <button id="load-bookmark-button" 
                        class="w-full text-left p-3 pr-10 border border-emerald-500 dark:border-emerald-700 rounded-xl bg-emerald-50 dark:bg-emerald-900/50 text-emerald-700 dark:text-emerald-300 hover:bg-emerald-100 dark:hover:bg-emerald-900 font-semibold transition duration-150">
                    </button>
                <button id="clear-bookmark-button" 
                        onclick="clearBookmark(event)" 
                        class="absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700" 
                        aria-label="Hapus Bookmark">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div id="search-container" class="relative mb-4 flex-shrink-0">
                <input type="text" id="surah-search" placeholder="Cari Surah (e.g., Al-Baqarah)"
                       class="w-full p-3 pl-10 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-emerald-500 focus:border-emerald-500 transition duration-150"
                       oninput="searchSurah(this.value)">
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>

            <div id="surah-list" class="space-y-2 flex-grow overflow-y-auto pr-2">
                <div id="quran-loading" class="text-center p-6 text-gray-500 dark:text-gray-400">Memuat daftar surah...</div>
            </div>
            
            <div id="search-no-results" class="hidden text-center p-6 text-gray-500 dark:text-gray-400">
                Tidak ada hasil yang ditemukan.
            </div>

            <div id="ayah-details" class="hidden mt-0 flex flex-col flex-grow overflow-hidden">
                
                <div id="scrollable-ayah-container" class="flex-grow overflow-y-auto pr-2">
                    <div id="ayah-content" class="space-y-6"> 
                        </div>
                </div>
                <div id="ayah-pagination" class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 flex-shrink-0">
                    <button id="prev-ayah-button" onclick="changePage(-1)" disabled
                            class="py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-xl font-bold transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-300 dark:hover:bg-gray-600">
                        &larr; Sebelumnya
                    </button>
                    <span id="page-info" class="text-sm font-medium text-gray-600 dark:text-gray-400">Halaman 1/1</span>
                    <button id="next-ayah-button" onclick="changePage(1)" disabled
                            class="py-2 px-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                        Selanjutnya &rarr;
                    </button>
                </div>
            </div>
        </div>
        
        <div id="checklist-view" class="hidden transition-opacity duration-300 flex flex-col flex-grow overflow-hidden">
            
            <h2 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-4 text-center">
                Checklist Shalat Harian
            </h2>
            
            <p id="checklist-date" class="text-center text-sm text-gray-500 dark:text-gray-400 mb-6"></p>

            <div id="checklist-container" class="flex-grow overflow-y-auto pr-2">
                
                <h3 class="text-base font-semibold text-emerald-600 dark:text-emerald-400 mb-3 sticky top-0 bg-white dark:bg-gray-800 py-1">
                    Shalat Fardu
                </h3>
                <div id="fardu-checklist" class="space-y-3">
                    <div class="text-center p-6 text-gray-500 dark:text-gray-400">Memuat...</div>
                </div>

                <hr class="my-6 border-gray-200 dark:border-gray-600">

                <h3 class="text-base font-semibold text-blue-600 dark:text-blue-400 mb-3 sticky top-0 bg-white dark:bg-gray-800 py-1">
                    Shalat Sunnah
                </h3>
                <div id="sunnah-checklist" class="space-y-3">
                    </div>

            </div>
            
            <button id="reset-checklist-button" 
                    class="mt-6 w-full py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow-lg transition duration-200 flex-shrink-0">
                Reset Checklist Hari Ini
            </button>
        </div>
        <div id="error-message" class="hidden text-center p-6 bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 border border-red-300 dark:border-red-600 rounded-lg mt-4">
            Terjadi kesalahan dalam inisialisasi atau pemanggilan API.
        </div>
        
        <footer class="mt-4 text-center text-xs text-gray-500 dark:text-gray-400 flex-shrink-0">
            &copy; 2024 Original Design by 
            <a href="https://wa.me/6282395223314" target="_blank" class="text-emerald-600 dark:text-emerald-400 hover:underline font-semibold">
                aL-Ihsan Computer
            </a>
        </footer>
    </div>
    
    <div id="mini-player" 
         class="fixed bottom-4 sm:bottom-6 left-1/2 -translate-x-1/2 w-[calc(100%-2rem)] max-w-md mx-auto bg-gray-900 dark:bg-gray-200 text-white dark:text-gray-900 p-3 pr-2 rounded-xl shadow-2xl flex items-center justify-between space-x-3 transition-all duration-300 ease-out transform translate-y-24 opacity-0 z-50"
         role="dialog" aria-label="Pemutar Audio" style="display: none;">
        
        <button id="mini-player-toggle" class="p-2 rounded-full bg-emerald-500 text-white hover:bg-emerald-600 transition-all flex-shrink-0" aria-label="Putar/Jeda">
            </button>
        
        <div class="flex-grow min-w-0">
            <p class="text-sm font-medium truncate" id="mini-player-title">Sedang memutar...</p>
            <p class="text-xs text-gray-400 dark:text-gray-600" id="mini-player-subtitle">Audio</p>
        </div>
        
        <button id="mini-player-close" class="p-2 rounded-full text-gray-500 dark:text-gray-700 hover:bg-gray-700 dark:hover:bg-gray-300 transition-all flex-shrink-0" aria-label="Tutup Pemutar">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>
        <script type="module">
        // Import modul Firebase (Biarkan seperti semula)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Konfigurasi Firebase (Biarkan) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db, userId = null;
        
        // Element References
        const translationToggleButton = document.getElementById('toggle-translation-button');
        const bookmarkButton = document.getElementById('bookmark-button');

        // Audio State
        let globalAudioPlayer = new Audio();
        let currentPlayingButton = null; 
        let miniPlayer = null;
        let miniPlayerTitle = null;
        let miniPlayerSubtitle = null;
        let miniPlayerToggle = null;
        let miniPlayerClose = null;
        let restoredAudioSrc = null;
        let restoredAudioTime = 0;

        window.addEventListener('beforeunload', () => {
            if (globalAudioPlayer && !globalAudioPlayer.paused && globalAudioPlayer.currentTime > 0) {
                sessionStorage.setItem('lastAudioSrc', globalAudioPlayer.src);
                sessionStorage.setItem('lastAudioTime', globalAudioPlayer.currentTime);
            }
        });

        // Icons
        const playIconSvg = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>`;
        const pauseIconSvg = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 00-1 1v2a1 1 0 001 1h1a1 1 0 001-1V9a1 1 0 00-1-1H7zm5 0a1 1 0 00-1 1v2a1 1 0 001 1h1a1 1 0 001-1V9a1 1 0 00-1-1h-1z" clip-rule="evenodd"></path></svg>`;
        const loadingIconSvg = `<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
        
        // --- Firebase Init ---
        async function initializeFirebaseAndAuth() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    onAuthStateChanged(auth, async (user) => {
                        if (user) userId = user.uid;
                        else if (!initialAuthToken) {
                            try { const anonymousUser = await signInAnonymously(auth); userId = anonymousUser.user.uid; } 
                            catch(e) { console.error("Gagal masuk secara anonim:", e); }
                        }
                        startApp(); 
                    });
                    if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    console.error("Firebase config tidak ditemukan.");
                    startApp();
                }
            } catch (error) {
                console.error("Error Init:", error);
                document.getElementById('error-message')?.classList.remove('hidden');
            }
        }
        
        // --- Logic Sholat ---
        let PRAYER_TIMES = []; 
        let LOKASI_KOTA = "Makassar"; 
        let prayerInterval; 

        async function fetchPrayerTimes(loadingEl) {
            try {
                const now = new Date();
                const tahun = now.getFullYear();
                const bulan = (now.getMonth() + 1).toString().padStart(2, '0');
                const tanggal = now.getDate().toString().padStart(2, '0');

                // Cari ID Kota
                const cityResponse = await fetch(`https://api.myquran.com/v2/sholat/kota/cari/${LOKASI_KOTA}`);
                if (!cityResponse.ok) throw new Error('Gagal cari kota');
                const cityData = await cityResponse.json();
                if (!cityData.data || cityData.data.length === 0) throw new Error('Kota tidak ditemukan');
                const idKota = cityData.data[0].id;
                LOKASI_KOTA = cityData.data[0].lokasi; 
                document.getElementById('location-display').textContent = LOKASI_KOTA;

                // Ambil Jadwal
                const scheduleResponse = await fetch(`https://api.myquran.com/v2/sholat/jadwal/${idKota}/${tahun}/${bulan}/${tanggal}`);
                const scheduleData = await scheduleResponse.json();
                const jadwal = scheduleData.data.jadwal;
                
                PRAYER_TIMES = [
                    { name: "Imsak", time: jadwal.imsak }, { name: "Subuh", time: jadwal.subuh },
                    { name: "Syuruk", time: jadwal.terbit }, { name: "Dhuha", time: jadwal.dhuha },
                    { name: "Dzuhur", time: jadwal.dzuhur }, { name: "Ashar", time: jadwal.ashar },
                    { name: "Maghrib", time: jadwal.maghrib }, { name: "Isya", time: jadwal.isya }
                ];
                if (loadingEl) loadingEl.textContent = 'Memuat jadwal...'; 
                return true; 
            } catch (error) {
                console.error("API Error:", error);
                if (loadingEl) loadingEl.textContent = `Gagal: ${error.message}`;
                return false; 
            }
        }
        
        async function loadPrayerTimesForLocation() {
            const listContainer = document.getElementById('prayer-times-list');
            listContainer.innerHTML = `<div id="loading" class="col-span-2 text-center p-6 text-gray-500 dark:text-gray-400"></div>`;
            const loadingEl = document.getElementById('loading');
            loadingEl.textContent = `Memuat untuk ${LOKASI_KOTA}...`;
            const success = await fetchPrayerTimes(loadingEl);
            if (success) updateUI(); 
        }

        async function handleChangeLocation() {
            const inputEl = document.getElementById('location-input');
            const newLocation = inputEl.value.trim();
            if (newLocation && newLocation.toLowerCase() !== LOKASI_KOTA.toLowerCase()) {
                LOKASI_KOTA = newLocation; inputEl.value = ''; stopAudioPlayback(); 
                if (prayerInterval) clearInterval(prayerInterval);
                await loadPrayerTimesForLocation(); 
                prayerInterval = setInterval(updateUI, 1000);
            }
        }
        
        function getNextPrayerTime(now) {
            if (PRAYER_TIMES.length === 0) return { nextPrayer: null, timeRemainingMs: 0 };
            const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();
            let nextPrayer = null;
            let minTimeDiff = Infinity;

            for (const prayer of PRAYER_TIMES) {
                const [h, m] = prayer.time.split(':').map(Number);
                const prayerTimeInMinutes = h * 60 + m;
                let timeDiff = prayerTimeInMinutes - currentTimeInMinutes;
                if (timeDiff <= 0) timeDiff += 1440; 
                if (timeDiff < minTimeDiff) { minTimeDiff = timeDiff; nextPrayer = prayer; }
            }
            if (nextPrayer === null && PRAYER_TIMES.length > 0) {
                 nextPrayer = PRAYER_TIMES[0];
                 const [h, m] = nextPrayer.time.split(':').map(Number);
                 minTimeDiff = (h * 60 + m - currentTimeInMinutes + 1440) % 1440;
            }
            return { nextPrayer, timeRemainingMs: (minTimeDiff * 60 - now.getSeconds()) * 1000 };
        }

        function formatCountdown(ms) {
            const totalSeconds = Math.max(0, Math.floor(ms / 1000));
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;
            return [h, m, s].map(v => v.toString().padStart(2, '0')).join(':');
        }

        function updatePrayerListUI(nextPrayerName) {
            const listContainer = document.getElementById('prayer-times-list');
            if (!listContainer || PRAYER_TIMES.length === 0) return;
            if (document.getElementById('loading')) listContainer.innerHTML = '';
            if (!document.getElementById(`prayer-${PRAYER_TIMES[0].name}`)) listContainer.innerHTML = ''; 
            
            PRAYER_TIMES.forEach(prayer => {
                const isNext = (prayer.name === nextPrayerName);
                const nextClass = isNext ? 'is-next-prayer' : 'bg-white dark:bg-gray-700 border border-gray-100 dark:border-gray-700';
                let itemEl = document.getElementById(`prayer-${prayer.name}`);
                if (!itemEl) {
                    const itemHtml = `<div id="prayer-${prayer.name}" class="prayer-list-item p-2 rounded-xl shadow-md flex flex-col items-center justify-center text-center"><span class="prayer-name text-sm font-medium text-gray-900 dark:text-gray-200">${prayer.name}</span><span class="prayer-time text-lg font-bold text-emerald-600 dark:text-emerald-400">${prayer.time}</span></div>`;
                    listContainer.insertAdjacentHTML('beforeend', itemHtml);
                    itemEl = document.getElementById(`prayer-${prayer.name}`); 
                }
                itemEl.className = `prayer-list-item p-2 rounded-xl shadow-md flex flex-col items-center justify-center text-center ${nextClass}`;
            });
        }

        function updateUI() {
            const now = new Date();
            const timeEl = document.getElementById('current-time');
            const dateEl = document.getElementById('current-date');
            
            if (timeEl) timeEl.textContent = now.toLocaleTimeString('id-ID', { hour12: false });
            if (dateEl) dateEl.textContent = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            if (PRAYER_TIMES.length > 0) {
                const { nextPrayer, timeRemainingMs } = getNextPrayerTime(now);
                const displayEl = document.getElementById('next-prayer-display');
                if (nextPrayer && displayEl) {
                    displayEl.innerHTML = `<span class="font-bold">${nextPrayer.name}</span> dalam <span class="font-mono">${formatCountdown(timeRemainingMs)}</span>`;
                    updatePrayerListUI(nextPrayer.name);
                }
            }
        }
        
        // --- Logic Quran ---
        const BASE_QURAN_API = 'https://api.quran.com/api/v4';
        let surahListCache = [], currentSurahId = null, currentPage = 1, totalPages = 1, allVerses = [], isTranslationVisible = true; 
        const VERSES_PER_PAGE = 10;

        function playAudio(audioUrl, buttonElement) {
            let trackTitle = "Audio", trackSubtitle = "Memutar...";
            if (buttonElement?.ariaLabel) {
                if (buttonElement.ariaLabel.startsWith("Putar Surah")) { trackTitle = buttonElement.ariaLabel.replace("Putar Surah ", ""); trackSubtitle = "Surah"; } 
                else if (buttonElement.ariaLabel.startsWith("Putar Ayat")) { trackTitle = document.getElementById('header-surah-title')?.textContent.split('(')[0].trim() || "Ayat"; trackSubtitle = "Ayat"; }
            }

            if (restoredAudioSrc === audioUrl && globalAudioPlayer.src === restoredAudioSrc) {
                restoredAudioSrc = null; restoredAudioTime = 0;
                if (currentPlayingButton && currentPlayingButton !== buttonElement) { currentPlayingButton.innerHTML = playIconSvg; currentPlayingButton.disabled = false; }
                buttonElement.innerHTML = loadingIconSvg; buttonElement.disabled = true;
                showMiniPlayer(trackTitle, trackSubtitle);
                if (miniPlayerToggle) miniPlayerToggle.innerHTML = loadingIconSvg;
                globalAudioPlayer.play().then(() => { buttonElement.innerHTML = pauseIconSvg; buttonElement.disabled = false; if (miniPlayerToggle) miniPlayerToggle.innerHTML = pauseIconSvg; })
                .catch(e => { console.error(e); buttonElement.innerHTML = playIconSvg; buttonElement.disabled = false; });
                currentPlayingButton = buttonElement;
                return;
            }

            if (globalAudioPlayer.src === audioUrl && !globalAudioPlayer.paused) {
                globalAudioPlayer.pause();
                buttonElement.innerHTML = playIconSvg;
                currentPlayingButton = null;
                if (miniPlayerToggle) miniPlayerToggle.innerHTML = playIconSvg; 
                if (globalAudioPlayer.currentTime > 0) { sessionStorage.setItem('lastAudioSrc', globalAudioPlayer.src); sessionStorage.setItem('lastAudioTime', globalAudioPlayer.currentTime); }
            } else {
                if (currentPlayingButton) { currentPlayingButton.innerHTML = playIconSvg; currentPlayingButton.disabled = false; }
                globalAudioPlayer.pause();
                if (globalAudioPlayer.src !== audioUrl) { globalAudioPlayer.src = audioUrl; globalAudioPlayer.currentTime = 0; }
                buttonElement.innerHTML = loadingIconSvg; buttonElement.disabled = true;
                showMiniPlayer(trackTitle, trackSubtitle);
                if (miniPlayerToggle) miniPlayerToggle.innerHTML = loadingIconSvg;
                globalAudioPlayer.play().then(() => { buttonElement.innerHTML = pauseIconSvg; buttonElement.disabled = false; if (miniPlayerToggle) miniPlayerToggle.innerHTML = pauseIconSvg; })
                .catch(e => { console.error(e); buttonElement.innerHTML = playIconSvg; buttonElement.disabled = false; hideMiniPlayer(); });
                currentPlayingButton = buttonElement;
            }
        }
        
        function setupAudioPlayerListeners() {
            miniPlayer = document.getElementById('mini-player');
            miniPlayerTitle = document.getElementById('mini-player-title');
            miniPlayerSubtitle = document.getElementById('mini-player-subtitle');
            miniPlayerToggle = document.getElementById('mini-player-toggle');
            miniPlayerClose = document.getElementById('mini-player-close');
            if (!miniPlayer) return;

            miniPlayerToggle.addEventListener('click', () => { if (globalAudioPlayer.paused) globalAudioPlayer.play(); else globalAudioPlayer.pause(); });
            miniPlayerClose.addEventListener('click', stopAudioPlayback);
            globalAudioPlayer.onended = () => { if (currentPlayingButton) { currentPlayingButton.innerHTML = playIconSvg; currentPlayingButton.disabled = false; currentPlayingButton = null; } hideMiniPlayer(); sessionStorage.removeItem('lastAudioSrc'); };
            globalAudioPlayer.onpause = () => { if (miniPlayerToggle) miniPlayerToggle.innerHTML = playIconSvg; };
            globalAudioPlayer.onplay = () => { if (miniPlayerToggle) miniPlayerToggle.innerHTML = pauseIconSvg; if (currentPlayingButton) currentPlayingButton.innerHTML = pauseIconSvg; };
            globalAudioPlayer.onwaiting = () => { if (miniPlayerToggle) miniPlayerToggle.innerHTML = loadingIconSvg; };
            globalAudioPlayer.oncanplay = () => { if (!globalAudioPlayer.paused && miniPlayerToggle) miniPlayerToggle.innerHTML = pauseIconSvg; };
        }
        
        function showMiniPlayer(title, subtitle) { if(miniPlayer) { miniPlayerTitle.textContent = title; miniPlayerSubtitle.textContent = subtitle; miniPlayer.style.display = 'flex'; setTimeout(() => miniPlayer.classList.remove('translate-y-24', 'opacity-0'), 10); } }
        function hideMiniPlayer() { if(miniPlayer) { miniPlayer.classList.add('translate-y-24', 'opacity-0'); setTimeout(() => miniPlayer.style.display = 'none', 300); } }
        function stopAudioPlayback() { if (!globalAudioPlayer.paused) { globalAudioPlayer.pause(); sessionStorage.setItem('lastAudioSrc', globalAudioPlayer.src); sessionStorage.setItem('lastAudioTime', globalAudioPlayer.currentTime); } if (currentPlayingButton) { currentPlayingButton.innerHTML = playIconSvg; currentPlayingButton.disabled = false; currentPlayingButton = null; } hideMiniPlayer(); }

        async function fetchSurahList() {
            const loading = document.getElementById('quran-loading'); const list = document.getElementById('surah-list');
            if(!loading) return; loading.classList.remove('hidden'); list.innerHTML = '';
            try {
                const res = await fetch(`${BASE_QURAN_API}/chapters?language=id`);
                if(!res.ok) throw new Error('API Error');
                const data = await res.json(); surahListCache = data.chapters;
                loading.classList.add('hidden'); renderSurahList(surahListCache);
            } catch(e) { loading.textContent = 'Gagal memuat.'; }
        }
        
        function renderSurahList(data) {
            const list = document.getElementById('surah-list'); const none = document.getElementById('search-no-results');
            list.innerHTML = ''; none.classList.add('hidden');
            if(data.length === 0) { none.classList.remove('hidden'); return; }
            data.forEach(s => {
                const btn = document.createElement('button');
                const audio = `https://cdn.islamic.network/quran/audio-surah/128/ar.alafasy/${s.id}.mp3`;
                let playCls = "surah-play-button p-2 rounded-full text-emerald-600 dark:text-emerald-400 hover:bg-emerald-100 dark:hover:bg-gray-600 transition";
                if(restoredAudioSrc === audio) playCls += " animate-pulse";
                
                btn.className = 'surah-button w-full bg-gray-100 dark:bg-gray-700 dark:text-gray-200 shadow-sm hover:bg-emerald-50 dark:hover:bg-gray-600 transition duration-150';
                btn.innerHTML = `<div class="flex flex-col items-start"><span class="font-bold text-base text-emerald-700 dark:text-emerald-300">${s.id}. ${s.name_simple}</span><p class="text-xs text-gray-500 dark:text-gray-400">${s.translated_name.name}</p></div><div class="flex items-center space-x-3"><span class="ayah-arabic text-xl text-emerald-600 dark:text-emerald-400">${s.name_arabic}</span><button class="${playCls}" data-audio-url="${audio}" aria-label="Putar Surah ${s.name_simple}">${playIconSvg}</button></div>`;
                btn.onclick = () => { stopAudioPlayback(); renderSurahDetails(s.id, s.name_simple, s.name_arabic); };
                btn.querySelector('.surah-play-button').onclick = (e) => { e.stopPropagation(); playAudio(audio, e.currentTarget); };
                list.appendChild(btn);
            });
        }

        window.searchSurah = (q) => {
            q = q.toLowerCase().trim();
            if(q === "") renderSurahList(surahListCache);
            else renderSurahList(surahListCache.filter(s => s.name_simple.toLowerCase().includes(q) || s.translated_name.name.toLowerCase().includes(q) || s.id.toString() === q));
        }

        async function renderSurahDetails(id, name, arab, page = 1, push = true) {
            document.getElementById('surah-list').classList.add('hidden'); document.getElementById('search-container').classList.add('hidden'); document.getElementById('load-bookmark-container').classList.add('hidden');
            const details = document.getElementById('ayah-details'); const content = document.getElementById('ayah-content'); const header = document.getElementById('header-surah-title');
            details.classList.remove('hidden'); content.innerHTML = '<p class="text-center p-6 text-gray-500">Memuat...</p>';
            header.textContent = `${name} (${arab})`; header.classList.remove('hidden');
            document.getElementById('back-to-prayer-icon').classList.remove('hidden'); document.getElementById('checklist-icon-button').classList.add('hidden');
            translationToggleButton.classList.remove('hidden'); bookmarkButton.classList.remove('hidden'); updateTranslationButtonUI();
            currentSurahId = id; currentPage = page;
            if(push) history.pushState({ view: 'ayahDetail', surahId: id, simpleName: name, arabicName: arab, page: page }, '', `#surah/${id}/page/${page}`);

            try {
                if(allVerses.length === 0 || !allVerses[0].verse_key.startsWith(id + ':')) {
                    const res = await fetch(`${BASE_QURAN_API}/verses/by_chapter/${id}?language=id&words=false&translations=33&fields=text_uthmani,verse_key,verse_number`);
                    const d = await res.json(); allVerses = d.verses; totalPages = Math.ceil(allVerses.length / VERSES_PER_PAGE);
                }
                renderAyahPage();
                document.getElementById('scrollable-ayah-container').scrollTo({ top: 0 });
            } catch(e) { content.innerHTML = '<p class="text-center text-red-500">Gagal memuat ayat.</p>'; }
        }

        function renderAyahPage() {
            const content = document.getElementById('ayah-content'); content.innerHTML = '';
            const start = (currentPage - 1) * VERSES_PER_PAGE;
            const verses = allVerses.slice(start, start + VERSES_PER_PAGE);

            if (currentPage === 1 && currentSurahId !== 1 && currentSurahId !== 9) {
                 content.innerHTML += `<div class="flex justify-center mb-6"><img src="https://upload.wikimedia.org/wikipedia/commons/2/27/Bismillah-1.png" alt="Bismillah" class="w-48 md:w-64 dark:invert opacity-80" /></div>`;
            }

            verses.forEach(v => {
                const aud = `https://everyayah.com/data/Alafasy_128kbps/${currentSurahId.toString().padStart(3,'0')}${v.verse_number.toString().padStart(3,'0')}.mp3`;
                let pCls = "ayah-play-button p-1 rounded-full text-emerald-600 dark:text-emerald-400 hover:bg-emerald-100 dark:hover:bg-gray-600 transition";
                if(restoredAudioSrc === aud) pCls += " animate-pulse";
                const div = document.createElement('div');
                div.className = 'p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl shadow-md border-b border-gray-200 dark:border-gray-700';
                div.innerHTML = `<div class="flex justify-between items-center mb-3 pb-3 border-b border-gray-200 dark:border-gray-600"><span class="text-sm font-bold text-emerald-600 dark:text-emerald-400">QS ${currentSurahId}:${v.verse_number}</span><button class="${pCls}" data-audio-url="${aud}">${playIconSvg}</button></div><p class="ayah-arabic mb-4 text-gray-900 dark:text-gray-100">${v.text_uthmani}</p><p class="translation-text ${isTranslationVisible?'':'hidden'} text-sm text-gray-700 dark:text-gray-300 italic pt-3 border-t border-gray-200 dark:border-gray-600">${v.translations[0].text}</p>`;
                div.querySelector('.ayah-play-button').onclick = (e) => { e.stopPropagation(); playAudio(aud, e.currentTarget); };
                content.appendChild(div);
            });
            updatePaginationUI();
        }

        window.changePage = (d) => {
            const n = currentPage + d; if(n < 1 || n > totalPages) return;
            currentPage = n; renderAyahPage(); stopAudioPlayback();
            document.getElementById('scrollable-ayah-container').scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function updatePaginationUI() {
            document.getElementById('prev-ayah-button').disabled = (currentPage === 1);
            document.getElementById('next-ayah-button').disabled = (currentPage === totalPages);
            document.getElementById('page-info').textContent = `Halaman ${currentPage}/${totalPages}`;
        }
        
        window.toggleTranslation = () => { isTranslationVisible = !isTranslationVisible; document.querySelectorAll('.translation-text').forEach(e => e.classList.toggle('hidden')); updateTranslationButtonUI(); }
        function updateTranslationButtonUI() {
            const open = document.getElementById('translation-eye-open'); const closed = document.getElementById('translation-eye-closed');
            if(isTranslationVisible) { open.classList.remove('hidden'); closed.classList.add('hidden'); } else { open.classList.add('hidden'); closed.classList.remove('hidden'); }
        }

        function saveBookmark() {
            if(!currentSurahId) return;
            const title = document.getElementById('header-surah-title').textContent.match(/(.*) \((.*)\)/);
            if(!title) return;
            localStorage.setItem('quranBookmark', JSON.stringify({ surahId: currentSurahId, simpleName: title[1].trim(), arabicName: title[2].trim(), page: currentPage }));
            bookmarkButton.style.color = '#10b981'; setTimeout(() => bookmarkButton.style.color = '', 1000);
            checkAndDisplayBookmarkButton();
        }

        function checkAndDisplayBookmarkButton() {
            const c = document.getElementById('load-bookmark-container'); const b = document.getElementById('load-bookmark-button'); const d = localStorage.getItem('quranBookmark');
            if(d && c && b) { const j = JSON.parse(d); b.textContent = `Lanjut: ${j.simpleName}, Hal. ${j.page}`; c.classList.remove('hidden'); } else if(c) c.classList.add('hidden');
        }

        document.getElementById('load-bookmark-button')?.addEventListener('click', () => {
            const d = JSON.parse(localStorage.getItem('quranBookmark')); if(d) renderSurahDetails(d.surahId, d.simpleName, d.arabicName, d.page);
        });
        window.clearBookmark = (e) => { e.stopPropagation(); localStorage.removeItem('quranBookmark'); document.getElementById('load-bookmark-container').classList.add('hidden'); }

        function setupDarkMode() {
            const t = document.getElementById('darkModeToggle'); const s = document.getElementById('sunIcon'); const m = document.getElementById('moonIcon');
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.body.classList.add('dark'); m.classList.add('hidden'); s.classList.remove('hidden'); }
            else { document.body.classList.remove('dark'); s.classList.add('hidden'); m.classList.remove('hidden'); }
            t.addEventListener('click', () => {
                document.body.classList.toggle('dark');
                if(document.body.classList.contains('dark')) { m.classList.add('hidden'); s.classList.remove('hidden'); localStorage.setItem('theme','dark'); }
                else { s.classList.add('hidden'); m.classList.remove('hidden'); localStorage.setItem('theme','light'); }
            });
        }
        
        // --- Checklist Logic ---
        const CHECKLIST_KEY = 'dailyChecklist';
        const OBLIGATORY_PRAYERS = ['Subuh', 'Dzuhur', 'Ashar', 'Maghrib', 'Isya'];
        const SUNNAH_PRAYERS = ['Tahajud', 'Witir', 'Qobliyah Subuh', 'Dhuha', 'Qobliyah Dzuhur', 'Badiyah Dzuhur', 'Qobliyah Ashar', 'Qobliyah Maghrib', 'Badiyah Maghrib', 'Qobliyah Isya', 'Badiyah Isya'];

        function getChecklistState() {
            const today = new Date().toLocaleDateString('id-ID');
            let data = JSON.parse(localStorage.getItem(CHECKLIST_KEY)) || {};
            if (data.date !== today || !data.fardu) {
                data = { date: today, fardu: {}, sunnah: {} };
                OBLIGATORY_PRAYERS.forEach(p => data.fardu[p] = false); SUNNAH_PRAYERS.forEach(p => data.sunnah[p] = false);
                localStorage.setItem(CHECKLIST_KEY, JSON.stringify(data));
            }
            return data;
        }

        function renderChecklist() {
            const fC = document.getElementById('fardu-checklist'); const sC = document.getElementById('sunnah-checklist');
            const state = getChecklistState(); document.getElementById('checklist-date').textContent = `Untuk: ${state.date}`;
            fC.innerHTML = ''; sC.innerHTML = '';
            
            const makeItem = (p, c, t) => {
                const pid = p.replace(/\s+/g, '-');
                return `<label for="check-${pid}" class="flex items-center justify-between w-full p-4 rounded-lg shadow-md cursor-pointer transition-all duration-200 ${c ? 'bg-emerald-50 dark:bg-emerald-900/50 border-l-4 border-emerald-500' : 'bg-white dark:bg-gray-700'}"><span class="text-lg font-semibold text-gray-800 dark:text-gray-100">${p}</span><input type="checkbox" id="check-${pid}" data-prayer="${p}" data-type="${t}" class="checklist-item w-6 h-6 text-emerald-600 rounded focus:ring-emerald-500" ${c ? 'checked' : ''}></label>`;
            };
            OBLIGATORY_PRAYERS.forEach(p => fC.insertAdjacentHTML('beforeend', makeItem(p, state.fardu[p], 'fardu')));
            SUNNAH_PRAYERS.forEach(p => sC.insertAdjacentHTML('beforeend', makeItem(p, state.sunnah[p], 'sunnah')));
        }

        document.getElementById('checklist-container')?.addEventListener('change', (e) => {
            if(e.target.classList.contains('checklist-item')) {
                const s = getChecklistState(); s[e.target.dataset.type][e.target.dataset.prayer] = e.target.checked;
                localStorage.setItem(CHECKLIST_KEY, JSON.stringify(s)); renderChecklist();
            }
        });
        document.getElementById('reset-checklist-button')?.addEventListener('click', () => { if(confirm('Reset checklist hari ini?')) { localStorage.removeItem(CHECKLIST_KEY); renderChecklist(); } });

        // --- Navigation ---
        function toggleView() { stopAudioPlayback();
            const pV = document.getElementById('prayer-view'); const qV = document.getElementById('quran-view'); const bIcon = document.getElementById('back-to-prayer-icon');
            if(qV.classList.contains('hidden')) {
                pV.classList.add('hidden'); qV.classList.remove('hidden'); document.getElementById('checklist-view').classList.add('hidden');
                document.getElementById('toggle-view-button').classList.add('hidden'); bIcon.classList.remove('hidden'); document.getElementById('checklist-icon-button').classList.add('hidden');
                if(surahListCache.length === 0) fetchSurahList(); else { document.getElementById('surah-list').classList.remove('hidden'); document.getElementById('ayah-details').classList.add('hidden'); document.getElementById('search-container').classList.remove('hidden'); renderSurahList(surahListCache); }
                checkAndDisplayBookmarkButton(); history.pushState({ view: 'quranList' }, '', '#quran');
            } else { history.back(); }
        }

        document.getElementById('toggle-view-button')?.addEventListener('click', toggleView);
        document.getElementById('back-to-prayer-icon')?.addEventListener('click', () => history.back());
        document.getElementById('checklist-icon-button')?.addEventListener('click', () => {
            stopAudioPlayback();
            document.getElementById('prayer-view').classList.add('hidden'); document.getElementById('quran-view').classList.add('hidden'); document.getElementById('checklist-view').classList.remove('hidden');
            document.getElementById('checklist-icon-button').classList.add('hidden'); document.getElementById('back-to-prayer-icon').classList.remove('hidden'); document.getElementById('toggle-view-button').classList.add('hidden');
            renderChecklist(); history.pushState({ view: 'checklist' }, '', '#checklist');
        });

        window.addEventListener('popstate', (e) => {
            stopAudioPlayback();
            const view = e.state ? e.state.view : 'prayer';
            const pV = document.getElementById('prayer-view'), qV = document.getElementById('quran-view'), cV = document.getElementById('checklist-view');
            const bIcon = document.getElementById('back-to-prayer-icon'), cBtn = document.getElementById('checklist-icon-button'), tBtn = document.getElementById('toggle-view-button');
            const head = document.getElementById('header-surah-title'), trans = document.getElementById('toggle-translation-button'), book = document.getElementById('bookmark-button');

            [head, trans, book, bIcon, cBtn, pV, qV, cV, tBtn].forEach(el => el?.classList.add('hidden'));

            if(view === 'ayahDetail') {
                qV.classList.remove('hidden'); document.getElementById('ayah-details').classList.remove('hidden'); document.getElementById('surah-list').classList.add('hidden'); document.getElementById('search-container').classList.add('hidden'); document.getElementById('load-bookmark-container').classList.add('hidden');
                [bIcon, head, trans, book].forEach(el => el?.classList.remove('hidden'));
                if(e.state.surahId && (currentSurahId !== e.state.surahId || currentPage !== e.state.page)) renderSurahDetails(e.state.surahId, e.state.simpleName, e.state.arabicName, e.state.page, false);
            } else if(view === 'quranList') {
                qV.classList.remove('hidden'); document.getElementById('surah-list').classList.remove('hidden'); document.getElementById('ayah-details').classList.add('hidden'); document.getElementById('search-container').classList.remove('hidden');
                bIcon.classList.remove('hidden'); checkAndDisplayBookmarkButton();
                if(surahListCache.length === 0) fetchSurahList(); else renderSurahList(surahListCache);
            } else if(view === 'checklist') {
                cV.classList.remove('hidden'); bIcon.classList.remove('hidden'); renderChecklist();
            } else {
                pV.classList.remove('hidden'); tBtn.classList.remove('hidden'); cBtn.classList.remove('hidden');
                document.getElementById('surah-list').classList.remove('hidden'); document.getElementById('ayah-details').classList.add('hidden');
                checkAndDisplayBookmarkButton();
            }
        });

        async function startApp() {
            const hash = window.location.hash;
            let init = { view: 'prayer' };
            if(hash.startsWith('#surah/')) {
                const p = hash.split('/'); 
                init = { view: 'quranList' };
                if(surahListCache.length === 0) await fetchSurahList();
                const s = surahListCache.find(x => x.id == p[1]);
                if(s) { renderSurahDetails(s.id, s.name_simple, s.name_arabic, p[3]?parseInt(p[3]):1, true); return; }
            } else if(hash === '#quran') init = { view: 'quranList' };
            else if(hash === '#checklist') init = { view: 'checklist' };

            history.replaceState(init, '', window.location.pathname + window.location.search + hash);
            // Trigger manual popstate logic without firing event
            window.dispatchEvent(new PopStateEvent('popstate', { state: init }));
            
            await loadPrayerTimesForLocation();
            prayerInterval = setInterval(updateUI, 1000);
            
            document.getElementById('bookmark-button')?.addEventListener('click', saveBookmark);
            setupAudioPlayerListeners();
            if(restoredAudioSrc) {
                const btn = document.querySelector(`[data-audio-url="${restoredAudioSrc}"]`);
                if(btn) playAudio(restoredAudioSrc, btn); else { globalAudioPlayer.play().catch(()=>{}); showMiniPlayer("Audio Dipulihkan", " "); if(miniPlayerToggle) miniPlayerToggle.innerHTML = pauseIconSvg; }
            }
        }

        window.onload = () => {
            const s = sessionStorage.getItem('lastAudioSrc'); const t = sessionStorage.getItem('lastAudioTime');
            if(s && t) { restoredAudioSrc = s; restoredAudioTime = parseFloat(t); globalAudioPlayer.src = s; globalAudioPlayer.currentTime = restoredAudioTime; }
            setupDarkMode(); initializeFirebaseAndAuth();
        }

    // ======================================================
    // === 100 WAWASAN ISLAM (DATABASE LOKAL) ===
    // ======================================================
    const ISLAMIC_FACTS_DB = [
        "Masjid Quba adalah masjid pertama yang dibangun Rasulullah SAW.",
        "Al-Khawarizmi adalah bapak penemu Aljabar dan angka nol.",
        "Universitas Al-Qarawiyyin (Maroko) adalah universitas tertua di dunia (859 M).",
        "Ibnu Sina (Avicenna) menulis 'Al-Qanun fi al-Tibb', rujukan medis dunia selama berabad-abad.",
        "Kata 'Kamera' berasal dari bahasa Arab 'Qamara' (ruang gelap) penemuan Ibnu al-Haytham.",
        "Surah Al-Baqarah adalah surah terpanjang dalam Al-Qur'an dengan 286 ayat.",
        "Air Zamzam tidak pernah kering sejak zaman Nabi Ismail AS hingga sekarang.",
        "Nabi Muhammad SAW menerima wahyu pertama di Gua Hira pada usia 40 tahun.",
        "Khalifah Umar bin Khattab adalah yang pertama kali menetapkan kalender Hijriah.",
        "Zakat adalah rukun Islam ketiga, berfungsi membersihkan harta dan jiwa.",
        "Shalat Jenazah tidak memiliki gerakan ruku' dan sujud.",
        "Ka'bah pernah dibangun ulang oleh Nabi Ibrahim AS dan Nabi Ismail AS.",
        "Al-Jazari adalah penemu sistem engkol dan robotika awal pada masa kejayaan Islam.",
        "Kata 'Coffee' (Kopi) berasal dari bahasa Arab 'Qahwa'.",
        "Wanita pertama yang syahid dalam Islam adalah Sumayyah binti Khayyat.",
        "Bilal bin Rabah adalah muadzin pertama dalam sejarah Islam.",
        "Al-Qur'an diturunkan secara bertahap selama kurang lebih 23 tahun.",
        "Perang Badar terjadi pada bulan Ramadhan tahun ke-2 Hijriah.",
        "Masjid Al-Aqsa di Palestina adalah kiblat pertama umat Islam.",
        "Nama 'Muhammad' adalah nama yang paling banyak digunakan di dunia.",
        "Surah Al-Kautsar adalah surah terpendek dalam Al-Qur'an (3 ayat).",
        "Idul Fitri dirayakan pada tanggal 1 Syawal.",
        "Puasa Arafah dapat menghapus dosa setahun yang lalu dan setahun yang akan datang.",
        "Imam Bukhari mengumpulkan ribuan hadits shahih setelah menyeleksi ratusan ribu riwayat.",
        "Kata 'Alcohol' berasal dari bahasa Arab 'Al-Kuhl'.",
        "Jabir bin Hayyan dikenal sebagai bapak Kimia modern.",
        "Sultan Mehmed II (Al-Fatih) menaklukkan Konstantinopel pada usia 21 tahun.",
        "Maryam (Ibu Nabi Isa) adalah satu-satunya wanita yang namanya disebut sebagai nama Surah.",
        "Nabi Idris AS adalah nabi pertama yang pandai menulis dan menjahit.",
        "Malaikat Jibril bertugas menyampaikan wahyu kepada para nabi.",
        "Al-Zahrawi adalah bapak ilmu bedah modern yang menemukan banyak alat bedah.",
        "Hajar Aswad dipercaya berasal dari surga.",
        "Shalat lima waktu diwajibkan pada peristiwa Isra Mi'raj.",
        "Nabi Sulaiman AS memiliki kemampuan berbicara dengan hewan dan mengendalikan angin.",
        "Kota Madinah dulunya bernama Yatsrib sebelum hijrah Nabi.",
        "Sahabat Abu Bakar As-Siddiq adalah khalifah pertama setelah wafatnya Rasulullah.",
        "Surah Al-Fatihah disebut juga Ummul Kitab (Induk Al-Qur'an).",
        "Thawaf dilakukan dengan mengelilingi Ka'bah sebanyak 7 kali putaran.",
        "Sa'i adalah lari-lari kecil antara bukit Shafa dan Marwah.",
        "Nabi Yunus AS pernah ditelan oleh ikan paus (Nun) dan selamat.",
        "Abbas ibn Firnas adalah orang pertama yang mencoba terbang dengan alat buatan sendiri (parasut).",
        "Rumah sakit jiwa pertama di dunia didirikan di Baghdad pada abad ke-8.",
        "Perpustakaan 'Bayt al-Hikmah' di Baghdad adalah pusat ilmu pengetahuan dunia pada masanya.",
        "Ibnu Batutah adalah penjelajah muslim yang berkeliling dunia lebih jauh dari Marco Polo.",
        "Shalat Tahajud adalah shalat sunnah yang paling utama setelah shalat fardu.",
        "Asmaul Husna berjumlah 99 nama baik Allah SWT.",
        "Nabi Yusuf AS memiliki ketampanan separuh dari ketampanan seluruh manusia.",
        "Surah Yasin sering disebut sebagai jantungnya Al-Qur'an.",
        "Ayat Kursi terdapat dalam Surah Al-Baqarah ayat 255.",
        "Utsman bin Affan adalah sahabat yang menikahi dua putri Rasulullah (Dzun Nurain).",
        "Ali bin Abi Thalib adalah sepupu sekaligus menantu Rasulullah SAW.",
        "Nabi Daud AS memiliki suara yang sangat merdu dan mukjizat melunakkan besi.",
        "Masjid Nabawi di Madinah memiliki makam Rasulullah SAW.",
        "Ar-Razi (Rhazes) adalah dokter muslim pertama yang membedakan cacar dan campak.",
        "Laksamana Cheng Ho adalah penjelajah muslim China yang menyebarkan Islam di Nusantara.",
        "Islam masuk ke Indonesia diperkirakan sejak abad ke-7 Masehi.",
        "Wali Songo berperan besar dalam penyebaran Islam di tanah Jawa.",
        "Shalat Dhuha adalah sedekah bagi setiap persendian tubuh manusia.",
        "Malam Lailatul Qadar lebih baik dari seribu bulan.",
        "Puasa Senin-Kamis adalah kebiasaan Rasulullah SAW.",
        "Nabi Nuh AS berdakwah selama 950 tahun namun hanya sedikit yang beriman.",
        "Firaun tenggelam di Laut Merah saat mengejar Nabi Musa AS.",
        "Gunung Uhud adalah gunung yang ada di surga, menurut sabda Nabi.",
        "Sumur Utsman (Bi'ru Rumah) di Madinah masih ada dan diwakafkan hingga hari ini.",
        "Imam Syafi'i hafal Al-Qur'an pada usia 7 tahun.",
        "Salahuddin Al-Ayyubi dikenal karena kemuliaan hatinya bahkan terhadap musuh Perang Salib.",
        "Ibnu Khaldun dianggap sebagai bapak Sosiologi dan Historiografi.",
        "Pencipta peta dunia globe pertama yang akurat adalah Al-Idrisi.",
        "Sikat gigi modern berevolusi dari konsep Siwak (Miswak) yang digunakan Nabi.",
        "Nabi Ayyub AS diuji dengan penyakit kulit parah dan kehilangan harta namun tetap sabar.",
        "Khadijah binti Khuwailid adalah orang pertama yang masuk Islam.",
        "Aisyah binti Abu Bakar adalah perawi hadits wanita terbanyak.",
        "Nabi Isa AS akan turun kembali ke bumi menjelang hari kiamat.",
        "Dajjal akan muncul dari arah timur (Khurasan/Isfahan).",
        "Yajuj dan Majuj terkurung oleh tembok yang dibangun Zulkarnain.",
        "Malaikat Israfil bertugas meniup sangkakala pada hari kiamat.",
        "Neraka paling ringan siksanya diperuntukkan bagi paman Nabi, Abu Thalib.",
        "Surga memiliki 8 pintu, salah satunya pintu Ar-Rayyan khusus orang yang berpuasa.",
        "Air wudhu dapat menggugurkan dosa-dosa kecil dari anggota tubuh yang dibasuh.",
        "Senyum kepada saudara sesama muslim adalah sedekah.",
        "Kebersihan adalah sebagian dari iman.",
        "Nabi Ibrahim AS disebut Khalilullah (Kekasih Allah).",
        "Nabi Musa AS disebut Kalimullah (Orang yang diajak bicara Allah).",
        "Al-Fatihah wajib dibaca dalam setiap rakaat shalat.",
        "Gerakan shalat diakhiri dengan salam ke kanan dan ke kiri.",
        "Masjidil Haram di Mekkah adalah masjid terbesar di dunia.",
        "Hukum menuntut ilmu adalah wajib bagi setiap muslim laki-laki dan perempuan.",
        "Riba sangat dilarang keras dalam Islam karena merugikan.",
        "Daging babi dan darah haram dikonsumsi umat Islam.",
        "Hewan yang disembelih harus menyebut nama Allah (Bismillah).",
        "Jumat adalah hari raya pekanan bagi umat Islam.",
        "Adzan adalah panggilan shalat yang dikumandangkan 5 kali sehari.",
        "Iqamah adalah tanda shalat akan segera dimulai.",
        "Imam adalah pemimpin dalam shalat berjamaah.",
        "Makmum Masbuq adalah makmum yang tertinggal rakaat shalat.",
        "Sujud Tilawah dilakukan saat mendengar atau membaca ayat Sajdah.",
        "Zakat Fitrah wajib dikeluarkan sebelum shalat Idul Fitri.",
        "Ibadah Haji wajib bagi yang mampu sekali seumur hidup.",
        "Padang Mahsyar adalah tempat berkumpulnya manusia setelah dibangkitkan.",
        "Syafaat terbesar di hari kiamat adalah milik Nabi Muhammad SAW."
    ];
    
    const INDONESIAN_MONTHS = ["Muharram", "Shafar", "Rabiul Awal", "Rabiul Akhir", "Jumadil Awal", "Jumadil Akhir", "Rajab", "Sya'ban", "Ramadhan", "Syawal", "Dzulqa'dah", "Dzulhijjah"];

    async function loadIslamicHistory() {
        const displayEl = document.getElementById('islamic-history-text');
        const dateEl = document.getElementById('hijri-date-display');
        
        displayEl.innerHTML = `<span class="animate-pulse text-gray-300 italic">Memuat wawasan...</span>`;

        try {
            // 1. Get Hijri Date
            const today = new Date();
            const dd = String(today.getDate()).padStart(2, '0');
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const yyyy = today.getFullYear();
            
            const hijriRes = await fetch(`https://api.aladhan.com/v1/gToH/${dd}-${mm}-${yyyy}`);
            if (!hijriRes.ok) throw new Error("Hijri API Fail");
            const hijriData = await hijriRes.json();
            
            const hDay = hijriData.data.hijri.day;
            const hMonthIndex = parseInt(hijriData.data.hijri.month.number) - 1; 
            const hYear = hijriData.data.hijri.year;
            const hMonthName = INDONESIAN_MONTHS[hMonthIndex] || hijriData.data.hijri.month.en;

            dateEl.textContent = `${hDay} ${hMonthName} ${hYear} H`;

            // 2. [PERUBAHAN] Get Random Fact from Local DB (No Wikipedia Fetch)
            const randomIndex = Math.floor(Math.random() * ISLAMIC_FACTS_DB.length);
            const selectedFact = ISLAMIC_FACTS_DB[randomIndex];

            displayEl.innerHTML = `<span class="text-emerald-300 font-bold text-xs uppercase tracking-wider mb-1 block">Tahukah Anda?</span><span class="italic text-white">"${selectedFact}"</span>`;

        } catch(e) {
            // Fallback total
            const randomIndex = Math.floor(Math.random() * ISLAMIC_FACTS_DB.length);
            displayEl.innerHTML = `<span class="text-emerald-300 font-bold text-xs uppercase tracking-wider mb-1 block">Wawasan Islam</span><span class="italic text-white">"${ISLAMIC_FACTS_DB[randomIndex]}"</span>`;
            if(dateEl.textContent === '-') dateEl.textContent = "Kalender Hijriah";
        }
    }

    // --- FUNGSI COUNTDOWN & LOAD ---
    (function() {
        const targetDate = new Date("Feb 18, 2026 00:00:00").getTime();
        const timerEl = document.getElementById("ramadhan-timer");
        const boxStyle = "flex flex-col items-center justify-center bg-slate-800/60 backdrop-blur-md border border-slate-700/50 rounded-2xl p-2 w-16 md:w-20 shadow-xl transform transition hover:scale-105";
        const numStyle = "text-xl md:text-3xl font-bold font-mono text-white leading-none mb-1 drop-shadow-md";
        const labelStyle = "text-[8px] md:text-xs text-emerald-400 uppercase font-bold tracking-wider";

        setInterval(function() {
            const now = new Date().getTime();
            const distance = targetDate - now;
            if (distance < 0) { timerEl.innerHTML = `<div class="text-2xl font-bold text-emerald-500 animate-pulse">MARHABAN YA RAMADHAN</div>`; return; }
            const d = Math.floor(distance / (1000 * 60 * 60 * 24));
            const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((distance % (1000 * 60)) / 1000);
            timerEl.innerHTML = `
                <div class="${boxStyle} border-b-2 border-emerald-600"><span class="${numStyle}">${d}</span><span class="${labelStyle}">Hari</span></div>
                <div class="${boxStyle} border-b-2 border-emerald-500"><span class="${numStyle}">${String(h).padStart(2, '0')}</span><span class="${labelStyle}">Jam</span></div>
                <div class="${boxStyle} border-b-2 border-emerald-400"><span class="${numStyle}">${String(m).padStart(2, '0')}</span><span class="${labelStyle}">Menit</span></div>
                <div class="${boxStyle} border-b-2 border-yellow-500 bg-slate-700/40"><span class="${numStyle} text-yellow-400">${String(s).padStart(2, '0')}</span><span class="${labelStyle} text-yellow-200">Detik</span></div>`;
        }, 1000);
        
        loadIslamicHistory();
    })();

    window.enterFullScreenApp = function() {
        const elem = document.documentElement;
        const overlay = document.getElementById('fullscreen-overlay');
        if (elem.requestFullscreen) { elem.requestFullscreen().catch(e => console.log(e)); } 
        else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); }
        overlay.style.opacity = '0';
        overlay.style.pointerEvents = 'none';
        setTimeout(() => { overlay.remove(); document.body.classList.remove('overflow-hidden'); }, 700);
    };
    </script>

    </body>
</html>


