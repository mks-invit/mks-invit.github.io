<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengingat Waktu Sholat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Menggunakan font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Warna latar terang */
            color: #1f2937;
            transition: background-color 0.3s, color 0.3s;
            
            /* [PERUBAHAN] Tambahkan tinggi penuh layar dan tata letak fleksibel */
            height: 100vh; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Dark Mode Styles: Kontras Ditingkatkan */
        body.dark {
            background-color: #111827; /* Gray 900 - Latar gelap lebih dalam */
            color: #f3f4f6;
        }
        body.dark #app-container {
            background-color: #1f2937; /* Gray 800 - Kartu utama lebih terang sedikit untuk kontras*/
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.7), 0 4px 6px -2px rgba(0, 0, 0, 0.3); /* Bayangan lebih gelap */
        }
        
        /* [PERUBAHAN] Kontainer utama dapat tumbuh untuk mengisi ruang yang tersedia */
        #app-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1; 
            /* Maksimum tinggi layar dikurangi padding body atas/bawah */
            max-height: calc(100vh - (4rem + 1rem)); /* 4rem untuk padding body (p-4) dan 1rem untuk footer margin (mt-4) */
        }
        
        /* Style untuk waktu sholat yang sedang berlangsung/berikutnya di daftar 2 kolom */
        .is-next-prayer {
            /* Warna Amber/Emas Muda untuk Light Mode */
            background-color: #fffbeb; /* Amber 50 */
            border-left: 5px solid #f59e0b; /* Amber 500 */
            font-weight: 700;
            transform: scale(1.02);
            transition: all 0.3s ease;
        }

        /* PERBAIKAN FONT UNTUK KETERBACAAN DI MODE TERANG */
        .is-next-prayer .prayer-name,
        .is-next-prayer .prayer-time {
            color: #1f2937 !important; /* Warna teks gelap (hampir hitam) untuk kontras di latar Amber 50 */
        }

        body.dark .is-next-prayer {
            /* Warna Amber Transparan untuk Dark Mode */
            background-color: #fbbf2430; /* Amber 400 dengan transparansi */
            border-left: 5px solid #fbbf24; /* Amber 400 */
        }
        /* Memastikan teks tetap terlihat dengan warna light di Dark Mode saat disorot */
        body.dark .is-next-prayer .prayer-name,
        body.dark .is-next-prayer .prayer-time {
            color: #fef3c7 !important; /* Teks kuning sangat muda/putih untuk kontras di latar gelap */
        }
        
        /* Hover pada item daftar */
        .prayer-list-item {
            transition: all 0.3s ease;
        }
        .prayer-list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        body.dark .prayer-list-item:hover {
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        /* Style untuk tombol Toggle */
        #darkModeToggle {
             transition: background-color 0.15s, color 0.15s, transform 0.15s;
        }
        
        /* Warna Khusus untuk Display Waktu Sholat Berikutnya (Maghrib/Senja - Kuning Keemasan) */
        .next-prayer-highlight {
            background-color: #f59e0b; /* Amber 500 */
            color: #fff; /* Teks putih untuk kontras maksimal di kartu utama */
            box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.5), 0 2px 4px -2px rgba(245, 158, 11, 0.3);
        }

        /* Gaya Khusus untuk Teks Arab */
        .ayah-arabic {
            font-family: 'Traditional Arabic', 'Amiri', serif;
            font-size: 1.5rem; 
            line-height: 2.5rem; 
            text-align: right;
        }

        /* Styling Tombol Surah */
        .surah-button {
            transition: background-color 0.2s;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .surah-button:hover {
            background-color: #f9fafb; /* Gray 50 */
        }
        body.dark .surah-button:hover {
            background-color: #374151; /* Gray 700 */
        }
        
        /* Gaya untuk elemen terjemahan */
        .translation-text {
            transition: opacity 0.3s ease;
            max-height: 1000px; /* Nilai besar agar terlihat transisi */
        }
        .translation-text.hidden {
            opacity: 0;
            max-height: 0; 
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex flex-col items-center">

    <div id="app-container" class="w-full max-w-md mx-auto bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-xl transition-colors duration-300 flex flex-col">
        
        <header class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-700 pb-4">
            <button id="back-to-prayer-icon" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150 invisible" aria-label="Kembali ke Waktu Sholat/Daftar Surah">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            </button>
            
            <div class="flex-grow flex flex-col justify-center items-center sm:flex-row sm:justify-center sm:space-x-3">
                <h1 class="text-xl sm:text-2xl font-extrabold text-gray-900 dark:text-white mb-1 sm:mb-0">
                    aic | JWS
                </h1>
                <span id="header-surah-title" class="hidden text-base sm:text-lg font-semibold text-emerald-600 dark:text-emerald-400">
                    </span>
            </div>
            
            <div class="flex space-x-2">
                
                <button id="toggle-translation-button" 
                        class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150 hidden" 
                        aria-label="Toggle Terjemahan"
                        onclick="toggleTranslation()">
                    <svg id="translation-eye-open" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    <svg id="translation-eye-closed" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7 1.274-4.057 5.065 7 9.542 7 1.05 0 2.083.178 3.064.51M12 16a4 4 0 00-4-4m-2.828 2.828l1.414 1.414M17.657 6.343l-1.414 1.414m-1.414 4.242l1.414 1.414m-4.242-8.484l1.414 1.414"></path></svg>
                </button>
                
                <button id="darkModeToggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150" aria-label="Toggle Dark Mode">
                    <svg id="sunIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="moonIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
            
        </header>

        <div id="prayer-view" class="transition-opacity duration-300">
            <div class="prayer-card bg-gray-50 dark:bg-gray-700/50 p-6 rounded-2xl mb-6 text-center border border-gray-200 dark:border-gray-700 shadow-inner">
                <div id="current-date" class="text-lg text-gray-600 dark:text-gray-300 mb-2"></div>
                <div id="current-time" class="text-6xl font-extrabold text-emerald-600 dark:text-emerald-400 leading-tight"></div>
                
                <div id="next-prayer-display" class="mt-4 p-3 rounded-xl text-sm font-semibold shadow-md next-prayer-highlight">
                    Waktu sholat berikutnya akan ditampilkan di sini...
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-6" id="prayer-times-list">
                <div id="loading" class="col-span-2 text-center p-6 text-gray-500 dark:text-gray-400">Memuat aplikasi...</div>
            </div>

            <p class="text-center text-sm text-gray-500 dark:text-gray-400 pt-4 border-t border-gray-200 dark:border-gray-700">Lokasi: <span id="location-display">Makassar</span></p>
            
            <div class="mt-4 flex space-x-2">
                <input type="text" id="location-input" placeholder="Ganti Lokasi (e.g., Jakarta)"
                       class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-emerald-500 focus:border-emerald-500 transition duration-150">
                <button id="location-change-button"
                        class="py-2 px-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl shadow-lg transition duration-200">
                    Ubah
                </button>
            </div>
            
            <div class="flex justify-center mt-6"> 
                <button id="toggle-view-button" 
                        class="w-full py-3 px-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl shadow-lg transition duration-200">
                    Baca Qur'an
                </button>
            </div>
            </div>

        <div id="quran-view" class="hidden transition-opacity duration-300 flex flex-col flex-grow overflow-hidden">
            
            <div id="search-container" class="relative mb-4 flex-shrink-0">
                <input type="text" id="surah-search" placeholder="Cari Surah (e.g., Al-Baqarah)"
                       class="w-full p-3 pl-10 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-emerald-500 focus:border-emerald-500 transition duration-150"
                       oninput="searchSurah(this.value)">
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>

            <div id="surah-list" class="space-y-2 flex-grow overflow-y-auto pr-2">
                <div id="quran-loading" class="text-center p-6 text-gray-500 dark:text-gray-400">Memuat daftar surah...</div>
            </div>
            
            <div id="search-no-results" class="hidden text-center p-6 text-gray-500 dark:text-gray-400">
                Tidak ada hasil yang ditemukan.
            </div>

            <div id="ayah-details" class="hidden mt-0 flex flex-col flex-grow overflow-hidden">
                
                <div id="scrollable-ayah-container" class="flex-grow overflow-y-auto pr-2">
                    <div id="ayah-content" class="space-y-6"> 
                        </div>
                </div>
                <div id="ayah-pagination" class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 flex-shrink-0">
                    <button id="prev-ayah-button" onclick="changePage(-1)" disabled
                            class="py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-xl font-bold transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-300 dark:hover:bg-gray-600">
                        &larr; Sebelumnya
                    </button>
                    <span id="page-info" class="text-sm font-medium text-gray-600 dark:text-gray-400">Halaman 1/1</span>
                    <button id="next-ayah-button" onclick="changePage(1)" disabled
                            class="py-2 px-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                        Selanjutnya &rarr;
                    </button>
                </div>
            </div>
        </div>

        <div id="error-message" class="hidden text-center p-6 bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 border border-red-300 dark:border-red-600 rounded-lg mt-4">
            Terjadi kesalahan dalam inisialisasi atau pemanggilan API.
        </div>
    </div>
    
    <footer class="w-full max-w-md mx-auto mt-4 text-center text-xs text-gray-500 dark:text-gray-400 flex-shrink-0">
        &copy; 2024 Original Design by 
        <a href="https://wa.me/6282395223314" target="_blank" class="text-emerald-600 dark:text-emerald-400 hover:underline font-semibold">
            aL-Ihsan Computer
        </a>
    </footer>

    <script type="module">
        // Import modul Firebase yang diperlukan (boilerplate wajib)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Bagian Inisialisasi Firebase (Wajib Sesuai Lingkungan Canvas) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let auth;
        let db;
        let userId = null;
        
        // Dapatkan elemen tombol terjemahan sekali
        const translationToggleButton = document.getElementById('toggle-translation-button');

        // --- State Audio Global ---
        let globalAudioPlayer = new Audio();
        let currentPlayingButton = null; // Melacak tombol yang sedang memutar audio

        // --- SVG Ikon untuk Tombol Audio ---
        const playIconSvg = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>`;
        const pauseIconSvg = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 00-1 1v2a1 1 0 001 1h1a1 1 0 001-1V9a1 1 0 00-1-1H7zm5 0a1 1 0 00-1 1v2a1 1 0 001 1h1a1 1 0 001-1V9a1 1 0 00-1-1h-1z" clip-rule="evenodd"></path></svg>`;
        const loadingIconSvg = `<svg class="w-5 h-5 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
        // --- END State Audio ---


        /**
         * Menginisialisasi Firebase dan melakukan otentikasi.
         */
        async function initializeFirebaseAndAuth() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                        } else if (!initialAuthToken) {
                            try {
                                const anonymousUser = await signInAnonymously(auth);
                                userId = anonymousUser.user.uid;
                            } catch(e) {
                                console.error("Gagal masuk secara anonim:", e);
                            }
                        }
                        startApp(); 
                    });

                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    }
                } else {
                    console.error("Firebase config tidak ditemukan. Berjalan dalam mode statis.");
                    startApp();
                }

            } catch (error) {
                console.error("Kesalahan fatal saat inisialisasi Firebase atau autentikasi:", error);
                const loadingEl = document.getElementById('loading');
                if (loadingEl) {
                    loadingEl.textContent = 'Kesalahan Inisialisasi Firebase.';
                    loadingEl.classList.remove('hidden');
                }
                document.getElementById('error-message')?.classList.remove('hidden');
            }
        }
        
        // ====================================================================
        // === [PERUBAHAN UTAMA: JADWAL SHOLAT DINAMIS] ===
        // ====================================================================

        // --- Data Waktu Sholat Dinamis (dari API) ---
        let PRAYER_TIMES = []; // Akan diisi oleh API
        let LOKASI_KOTA = "Makassar"; // Lokasi default
        let prayerInterval; // Variabel untuk menyimpan interval timer

        /**
         * [PERBAIKAN] Mengambil jadwal sholat dari API myQuran.com (sumber Kemenag)
         * @param {HTMLElement} loadingEl - Elemen DOM untuk menampilkan status loading/error
         */
        async function fetchPrayerTimes(loadingEl) {
            try {
                const now = new Date();
                const tahun = now.getFullYear();
                const bulan = (now.getMonth() + 1).toString().padStart(2, '0');
                const tanggal = now.getDate().toString().padStart(2, '0');

                // 1. Cari ID Kota
                const cityResponse = await fetch(`https://api.myquran.com/v2/sholat/kota/cari/${LOKASI_KOTA}`);
                if (!cityResponse.ok) throw new Error(`Gagal mencari ID kota (status: ${cityResponse.status})`);
                
                const cityData = await cityResponse.json();
                if (!cityData.data || cityData.data.length === 0) {
                    throw new Error(`Kota "${LOKASI_KOTA}" tidak ditemukan`);
                }
                const idKota = cityData.data[0].id;
                
                LOKASI_KOTA = cityData.data[0].lokasi; // Update nama lokasi (e.g., "KOTA MAKASSAR")
                document.getElementById('location-display').textContent = LOKASI_KOTA;

                // 2. Ambil Jadwal Sholat
                const scheduleResponse = await fetch(`https://api.myquran.com/v2/sholat/jadwal/${idKota}/${tahun}/${bulan}/${tanggal}`);
                if (!scheduleResponse.ok) throw new Error(`Gagal mengambil jadwal (status: ${scheduleResponse.status})`);
                
                const scheduleData = await scheduleResponse.json();
                if (!scheduleData.data || !scheduleData.data.jadwal) {
                     throw new Error('Data jadwal tidak valid dari API');
                }
                
                const jadwal = scheduleData.data.jadwal;
                
                // 3. Format data
                PRAYER_TIMES = [
                    { name: "Imsak", time: jadwal.imsak },
                    { name: "Subuh", time: jadwal.subuh },
                    { name: "Dzuhur", time: jadwal.dzuhur },
                    { name: "Ashar", time: jadwal.ashar },
                    { name: "Maghrib", time: jadwal.maghrib },
                    { name: "Isya", time: jadwal.isya }
                ];
                
                return true; // Sukses

            } catch (error) {
                console.error("Gagal mengambil jadwal sholat:", error);
                
                // [PERBAIKAN] Gunakan 'loadingEl' yang di-pass sebagai argumen
                if (loadingEl) { 
                    loadingEl.textContent = `Gagal memuat jadwal: ${error.message}.`;
                    loadingEl.classList.remove('hidden'); // Pastikan terlihat
                }
                
                PRAYER_TIMES = []; // Pastikan data kosong jika gagal
                return false; // Gagal
            }
        }
        
        /**
         * [PERBAIKAN] Fungsi untuk memuat (atau memuat ulang) jadwal sholat berdasarkan LOKASI_KOTA
         */
        async function loadPrayerTimesForLocation() {
            const listContainer = document.getElementById('prayer-times-list');
            
            // 1. Reset UI dan Tampilkan Loading
            PRAYER_TIMES = []; // Kosongkan jadwal lama
            
            // [PERBAIKAN] Langsung set innerHTML container menjadi loading message
            // Ini akan menghapus jadwal lama DAN 'loadingEl' lama (jika ada), lalu membuat 'loadingEl' yang BARU.
            listContainer.innerHTML = `<div id="loading" class="col-span-2 text-center p-6 text-gray-500 dark:text-gray-400"></div>`;
            
            // Ambil elemen 'loading' yang BARU saja kita buat
            const loadingEl = document.getElementById('loading');
            loadingEl.textContent = `Memuat jadwal sholat untuk ${LOKASI_KOTA}...`;

            document.getElementById('location-display').textContent = LOKASI_KOTA;
            document.getElementById('next-prayer-display').innerHTML = `Menunggu data jadwal sholat...`;

            // 2. Panggil API dan kirimkan 'loadingEl' yang baru untuk penanganan error
            const success = await fetchPrayerTimes(loadingEl);
            
            if (success) {
                // loadingEl.classList.add('hidden'); // Tidak perlu, renderPrayerList akan menghapusnya
                updateUI(); // Lakukan render pertama kali dengan data baru
            }
            // Jika gagal, fetchPrayerTimes SUDAH mengisi 'loadingEl' dengan pesan error
        }
        
        /**
         * [BARU] Fungsi yang dipanggil saat tombol "Ubah" lokasi diklik
         */
        async function handleChangeLocation() {
            const inputEl = document.getElementById('location-input');
            const newLocation = inputEl.value.trim();
            
            // Cek jika input tidak kosong dan berbeda dari lokasi saat ini
            if (newLocation && newLocation.toLowerCase() !== LOKASI_KOTA.toLowerCase()) {
                LOKASI_KOTA = newLocation; // Update variabel global
                inputEl.value = ''; // Kosongkan input field
                
                stopAudioPlayback(); // Hentikan audio jika sedang diputar
                
                // [PERBAIKAN] Hentikan interval lama sebelum memuat data baru
                if (prayerInterval) clearInterval(prayerInterval);
                
                await loadPrayerTimesForLocation(); // Muat ulang jadwal
                
                // [PERBAIKAN] Mulai lagi interval SETELAH data baru dimuat
                prayerInterval = setInterval(updateUI, 1000);
            }
        }
        
        // ====================================================================
        // === [AKHIR PERUBAHAN UTAMA] ===
        // ====================================================================


        /**
         * Menghitung waktu sholat berikutnya dan sisa waktunya.
         * @param {Date} now Waktu saat ini.
         * @returns {object} Objek berisi { nextPrayer, timeRemainingMs }.
         */
        function getNextPrayerTime(now) {
            // Pengecekan jika PRAYER_TIMES masih kosong (saat loading/error)
            if (PRAYER_TIMES.length === 0) {
                return { nextPrayer: null, timeRemainingMs: 0 };
            }

            const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();
            let nextPrayer = null;
            let minTimeDiff = Infinity;

            for (const prayer of PRAYER_TIMES) {
                const [h, m] = prayer.time.split(':').map(Number);
                const prayerTimeInMinutes = h * 60 + m;
                
                let timeDiff = prayerTimeInMinutes - currentTimeInMinutes;
                if (timeDiff <= 0) {
                    timeDiff += 1440; 
                }

                if (timeDiff < minTimeDiff) {
                    minTimeDiff = timeDiff;
                    nextPrayer = prayer;
                }
            }

            if (!nextPrayer) {
                nextPrayer = PRAYER_TIMES[0]; 
            }
            
            const nextPrayerTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 
                                            ...nextPrayer.time.split(':').map(Number));
            
            if (nextPrayerTime < now) {
                nextPrayerTime.setDate(nextPrayerTime.getDate() + 1);
            }
            
            const timeRemainingMs = nextPrayerTime.getTime() - now.getTime();

            return { nextPrayer, timeRemainingMs };
        }
        
        /**
         * Memformat milidetik menjadi string HH:MM:SS.
         * @param {number} ms Milidetik.
         * @returns {string} Waktu terformat.
         */
        function formatTimeRemaining(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const seconds = totalSeconds % 60;
            const minutes = Math.floor(totalSeconds / 60) % 60;
            const hours = Math.floor(totalSeconds / 3600);

            const pad = num => num.toString().padStart(2, '0');
            return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        }

        /**
         * Merender daftar waktu sholat ke DOM, menyorot waktu berikutnya.
         * @param {string} nextPrayerName Nama waktu sholat berikutnya.
         */
        function renderPrayerList(nextPrayerName) {
            const listContainer = document.getElementById('prayer-times-list');
            if (!listContainer) return;
            
            if (PRAYER_TIMES.length === 0) return;

            // [PERBAIKAN] Cek 'loadingEl' berdasarkan ID. Jika ada, hapus.
            const loadingEl = document.getElementById('loading');
            if (loadingEl) {
                // Hapus loadingEl, atau reset container
                listContainer.innerHTML = '';
            }
            
            // Jika loadingEl tidak ada (karena sudah di-render),
            // kita tetap perlu 'listContainer.innerHTML = ''' jika HANYA highlight yang berubah.
            // Namun, kita cek dulu apakah elemennya sudah ada
            
            const existingPrayerItem = document.getElementById(`prayer-${PRAYER_TIMES[0].name}`);
            if (!existingPrayerItem) {
                 listContainer.innerHTML = ''; // Hanya hapus jika daftar belum di-render
            }
            
            PRAYER_TIMES.forEach(prayer => {
                const isNext = prayer.name === nextPrayerName;
                const nextClass = isNext 
                    ? 'is-next-prayer' 
                    : 'bg-white dark:bg-gray-700 border border-gray-100 dark:border-gray-700';

                // Cek apakah elemen sudah ada
                let itemEl = document.getElementById(`prayer-${prayer.name}`);
                if (!itemEl) {
                    // Buat elemen baru jika belum ada
                    const itemHtml = `
                        <div id="prayer-${prayer.name}" 
                             class="prayer-list-item p-2 rounded-xl shadow-md flex flex-col items-center justify-center text-center">
                            <span class="prayer-name text-sm font-medium text-gray-900 dark:text-gray-200">${prayer.name}</span>
                            <span class="prayer-time text-lg font-bold text-emerald-600 dark:text-emerald-400">${prayer.time}</span>
                        </div>
                    `;
                    listContainer.insertAdjacentHTML('beforeend', itemHtml);
                    itemEl = document.getElementById(`prayer-${prayer.name}`); // Ambil lagi setelah dibuat
                }
                
                // Update class (highlight)
                // Hapus class lama, tambahkan class baru
                itemEl.className = `prayer-list-item p-2 rounded-xl shadow-md flex flex-col items-center justify-center text-center ${nextClass}`;
            });
        }

        /**
         * Fungsi utama yang memperbarui UI jam, tanggal, dan waktu sholat.
         * Dijalankan setiap detik.
         */
        function updateUI() {
            const now = new Date();
            
            // 1. Perbarui Jam dan Tanggal
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            
            const currentTimeEl = document.getElementById('current-time');
            const currentDateEl = document.getElementById('current-date');
            
            if (currentTimeEl) currentTimeEl.textContent = now.toLocaleTimeString('id-ID', timeOptions);
            if (currentDateEl) currentDateEl.textContent = now.toLocaleDateString('id-ID', dateOptions);

            // 2. Tentukan Waktu Sholat Berikutnya
            const { nextPrayer, timeRemainingMs } = getNextPrayerTime(now);
            
            // Handle jika nextPrayer belum siap (sedang loading atau error)
            if (!nextPrayer) {
                return; 
            }

            const timeRemainingFormatted = formatTimeRemaining(timeRemainingMs);

            // 3. Perbarui Tampilan Waktu Sholat Berikutnya (Kartu Kuning)
            const nextPrayerDisplay = document.getElementById('next-prayer-display');
            if (nextPrayerDisplay) {
                nextPrayerDisplay.innerHTML = `
                    <span class="text-white">Waktu Berikutnya:</span> ${nextPrayer.name} (${nextPrayer.time})
                    <br>
                    <span class="text-sm font-light text-white">Tersisa: ${timeRemainingFormatted}</span>
                `;
            }

            // 4. Perbarui Daftar Sholat (Highlight)
            // [PERBAIKAN] Kita panggil renderPrayerList untuk mengurus highlight
            renderPrayerList(nextPrayer.name);
        }
        
        // --- Logika Qur'an ---

        const BASE_QURAN_API = 'https://api.quran.com/api/v4';
        let surahListCache = []; 
        let isTranslationVisible = false; 

        // --- Variabel State Pagination ---
        const VERSES_PER_PAGE = 10; 
        let allVerses = []; 
        let currentPage = 1;
        let totalPages = 1;
        let currentSurahId = null; 
        
        // --- Logika Pemutar Audio ---

        /**
         * Fungsi terpusat untuk memutar/menghentikan audio.
         * @param {string} audioUrl URL file audio
         * @param {HTMLElement} buttonElement Tombol yang diklik
         */
        function playAudio(audioUrl, buttonElement) {
            // Cek apakah audio yang sama sedang diputar
            if (globalAudioPlayer.src === audioUrl && !globalAudioPlayer.paused) {
                // Audio yang sama sedang diputar -> Jeda
                globalAudioPlayer.pause();
                buttonElement.innerHTML = playIconSvg; // Kembalikan ke ikon play
                currentPlayingButton = null;
            } else {
                // Audio berbeda ATAU audio dijeda -> Putar baru
                
                // Hentikan audio sebelumnya (jika ada) dan reset ikonnya
                if (currentPlayingButton) {
                    currentPlayingButton.innerHTML = playIconSvg;
                }
                
                // Hentikan pemutar global jika sedang memutar sesuatu
                globalAudioPlayer.pause();
                
                // Atur sumber baru dan tombol saat ini
                globalAudioPlayer.src = audioUrl;
                currentPlayingButton = buttonElement;
                
                // Tampilkan ikon loading
                buttonElement.innerHTML = loadingIconSvg;
                buttonElement.disabled = true; // Nonaktifkan tombol saat loading

                globalAudioPlayer.play().then(() => {
                    // Berhasil diputar, ganti ikon ke pause
                    if (currentPlayingButton === buttonElement) { // Pastikan masih tombol yang sama
                        buttonElement.innerHTML = pauseIconSvg;
                    }
                    buttonElement.disabled = false;
                }).catch(error => {
                    console.error("Gagal memutar audio:", error); 
                    buttonElement.innerHTML = playIconSvg; // Gagal, kembalikan ke play
                    currentPlayingButton = null;
                    buttonElement.disabled = false;
                });
            }
        }

        // Event listener untuk saat audio selesai
        globalAudioPlayer.onended = () => {
            if (currentPlayingButton) {
                currentPlayingButton.innerHTML = playIconSvg;
                currentPlayingButton.disabled = false;
                currentPlayingButton = null;
            }
        };

        // Event listener untuk saat audio dijeda (secara manual oleh pengguna)
        globalAudioPlayer.onpause = () => {
            if (currentPlayingButton && !globalAudioPlayer.ended) {
                currentPlayingButton.innerHTML = playIconSvg;
                currentPlayingButton.disabled = false;
                currentPlayingButton = null;
            }
        };

        // Fungsi untuk menghentikan audio secara paksa (saat navigasi)
        function stopAudioPlayback() {
            if (!globalAudioPlayer.paused) {
                globalAudioPlayer.pause();
            }
            if (currentPlayingButton) {
                currentPlayingButton.innerHTML = playIconSvg;
                currentPlayingButton.disabled = false;
                currentPlayingButton = null;
            }
        }


        /**
         * Mengambil daftar semua 114 surah dari API Quran.com
         */
        async function fetchSurahList() {
            const quranLoadingEl = document.getElementById('quran-loading');
            const surahListEl = document.getElementById('surah-list');
            if (!quranLoadingEl || !surahListEl) return;

            quranLoadingEl.classList.remove('hidden');
            surahListEl.innerHTML = '';
            
            try {
                const response = await fetch(`${BASE_QURAN_API}/chapters?language=id`);
                if (!response.ok) throw new Error('Gagal mengambil daftar surah');
                const data = await response.json();
                
                surahListCache = data.chapters;
                renderSurahList(surahListCache);

            } catch (error) {
                console.error("Kesalahan API Qur'an:", error);
                surahListEl.innerHTML = `<p class="text-center text-red-500">Gagal memuat daftar surah: ${error.message}</p>`;
                document.getElementById('error-message').textContent = "Terjadi kesalahan saat memuat daftar surah Al-Qur'an.";
                document.getElementById('error-message').classList.remove('hidden');
            } finally {
                quranLoadingEl.classList.add('hidden');
            }
        }

        /**
         * Menggambar daftar surah (dapat difilter).
         * @param {Array<object>} surahs Array objek surah.
         */
        function renderSurahList(surahs) {
            const surahListEl = document.getElementById('surah-list');
            const noResultsEl = document.getElementById('search-no-results');
            const headerSurahTitleEl = document.getElementById('header-surah-title');

            if (translationToggleButton) {
                translationToggleButton.classList.add('hidden');
            }
            
            if (headerSurahTitleEl) {
                headerSurahTitleEl.classList.add('hidden');
                headerSurahTitleEl.textContent = ''; 
            }

            if (!surahListEl || !noResultsEl) return;
            surahListEl.innerHTML = '';
            noResultsEl.classList.add('hidden');

            if (surahs.length === 0) {
                noResultsEl.classList.remove('hidden');
                return;
            }

            surahs.forEach(surah => {
                const button = document.createElement('button');
                // Menggunakan kelas asli dari file Anda
                button.className = 'surah-button w-full bg-gray-100 dark:bg-gray-700 dark:text-gray-200 shadow-sm hover:bg-emerald-50 dark:hover:bg-gray-600 transition duration-150';
                button.dataset.surahId = surah.id;
                
                const revelationType = surah.revelation_place === 'makkah' ? 'Makkiyah' : 'Madaniyah';
                
                const surahAudioUrl = `https://cdn.islamic.network/quran/audio-surah/128/ar.alafasy/${surah.id}.mp3`;

                button.innerHTML = `
                    <div class="flex flex-col items-start">
                        <span class="font-bold text-base text-emerald-700 dark:text-emerald-300">${surah.id}. ${surah.name_simple}</span>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${surah.translated_name.name} - ${revelationType}</p>
                        <p class="text-xs text-gray-400 dark:text-gray-500">${surah.verses_count} Ayat</p>
                    </div>
                    
                    <div class="flex items-center space-x-3">
                        
                        <span class="ayah-arabic text-xl text-emerald-600 dark:text-emerald-400">${surah.name_arabic}</span>
                        
                        <button type="button" 
                                class="surah-play-button p-2 rounded-full text-emerald-600 dark:text-emerald-400 hover:bg-emerald-100 dark:hover:bg-gray-600 transition" 
                                data-audio-url="${surahAudioUrl}" 
                                aria-label="Putar Surah ${surah.name_simple}">
                            ${playIconSvg}
                        </button>
                        
                    </div>
                `;
                
                // Event listener utama untuk membuka halaman detail surah
                button.addEventListener('click', () => {
                    stopAudioPlayback(); 
                    renderSurahDetails(surah.id, surah.name_simple, surah.name_arabic);
                });

                const playButton = button.querySelector('.surah-play-button');
                if (playButton) {
                    playButton.addEventListener('click', (e) => {
                        e.stopPropagation(); // Mencegah event click pada tombol utama (navigasi)
                        playAudio(surahAudioUrl, playButton);
                    });
                }
                
                surahListEl.appendChild(button);
            });
            
            surahListEl.scrollTop = 0; 
        }
        
        /**
         * Fungsi untuk memfilter daftar surah berdasarkan input pencarian.
         */
        window.searchSurah = (query) => {
            const normalizedQuery = query.toLowerCase().trim();
            if (normalizedQuery === "") {
                renderSurahList(surahListCache);
                return;
            }

            const filteredSurahs = surahListCache.filter(surah => 
                surah.name_simple.toLowerCase().includes(normalizedQuery) || 
                surah.translated_name.name.toLowerCase().includes(normalizedQuery) ||
                surah.id.toString() === normalizedQuery
            );
            
            renderSurahList(filteredSurahs);
        }


        /**
         * Mengambil dan menampilkan detail (ayat) surah tertentu.
         */
        async function renderSurahDetails(surahId, simpleName, arabicName) {
            const ayahDetailsEl = document.getElementById('ayah-details');
            const ayahContentEl = document.getElementById('ayah-content');
            const headerSurahTitleEl = document.getElementById('header-surah-title'); 
            const surahListEl = document.getElementById('surah-list');
            const searchContainerEl = document.getElementById('search-container'); 

            if (!ayahDetailsEl || !ayahContentEl || !surahListEl || !searchContainerEl || !headerSurahTitleEl) return;
            
            currentPage = 1; 
            allVerses = []; 
            currentSurahId = surahId; 
            updatePaginationButtons(); 
            
            if (translationToggleButton) {
                translationToggleButton.classList.remove('hidden');
            }
            updateTranslationButtonUI(); 
            
            ayahContentEl.innerHTML = `<p class="text-center p-6 text-gray-500 dark:text-gray-400">Memuat ayat-ayat Surah ${simpleName}... </p>`;
            surahListEl.classList.add('hidden'); 
            searchContainerEl.classList.add('hidden'); 
            document.getElementById('search-no-results')?.classList.add('hidden');
            ayahDetailsEl.classList.remove('hidden'); 

            headerSurahTitleEl.textContent = `${simpleName} (${arabicName})`;
            headerSurahTitleEl.classList.remove('hidden');


            try {
                const apiUrl = `${BASE_QURAN_API}/verses/by_chapter/${surahId}?fields=text_uthmani&translations=33&per_page=all`;
                
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`Gagal mengambil data ayat (status: ${response.status})`);
                const data = await response.json();
                
                if (!data.verses || data.verses.length === 0) {
                    ayahContentEl.innerHTML = `<p class="text-center text-red-500">Ayat tidak ditemukan untuk surah ini.</p>`;
                    return;
                }

                allVerses = data.verses;
                totalPages = Math.ceil(allVerses.length / VERSES_PER_PAGE);

                renderAyahPage(); 
                
                const scrollContainer = document.getElementById('scrollable-ayah-container');
                if (scrollContainer) {
                    scrollContainer.scrollTo({ top: 0, behavior: 'instant' }); 
                }

            } catch (error) {
                console.error("Kesalahan API Ayat:", error);
                ayahContentEl.innerHTML = `<p class="text-center text-red-500">Gagal memuat ayat-ayat: ${error.message}</p>`;
            }
        }
        
        /**
         * Menggambar ayat untuk halaman saat ini.
         */
        function renderAyahPage() { 
            const ayahContentEl = document.getElementById('ayah-content');
            if (!ayahContentEl) return;

            ayahContentEl.innerHTML = ''; 
            
            const startIndex = (currentPage - 1) * VERSES_PER_PAGE;
            const endIndex = startIndex + VERSES_PER_PAGE;
            const versesToShow = allVerses.slice(startIndex, endIndex);

            if (currentPage === 1 && currentSurahId !== 1 && currentSurahId !== 9) {
                 ayahContentEl.innerHTML += `<p class="ayah-arabic text-center mb-4 text-2xl font-light text-gray-900 dark:text-gray-100">بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ</p>`;
            }

            versesToShow.forEach(verse => {
                const arabicText = verse.text_uthmani;
                const translationText = verse.translations ? verse.translations[0].text : 'Terjemahan tidak tersedia.';
                
                const surahPad = currentSurahId.toString().padStart(3, '0');
                const ayahPad = verse.verse_number.toString().padStart(3, '0');
                const ayahAudioUrl = `https://everyayah.com/data/Alafasy_128kbps/${surahPad}${ayahPad}.mp3`;

                const ayahDiv = document.createElement('div');
                ayahDiv.className = 'p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl shadow-md border-b border-gray-200 dark:border-gray-700';
                
                const translationClass = isTranslationVisible ? 'translation-text' : 'translation-text hidden';

                ayahDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-3 pb-3 border-b border-gray-200 dark:border-gray-600">
                        <span class="text-base font-bold text-emerald-700 dark:text-emerald-300">Ayat ${verse.verse_number}</span>
                        
                        <button class="ayah-play-button p-1 rounded-full text-emerald-600 dark:text-emerald-400 hover:bg-emerald-100 dark:hover:bg-gray-600 transition" 
                                data-audio-url="${ayahAudioUrl}" 
                                aria-label="Putar Ayat ${verse.verse_number}">
                            ${playIconSvg}
                        </button>
                    </div>

                    <p class="ayah-arabic mb-4 font-light text-gray-900 dark:text-gray-100">${arabicText}</p>
                    
                    <p class="${translationClass} text-sm italic text-gray-600 dark:text-gray-300 border-t border-gray-300 dark:border-gray-600 pt-3">
                        ${translationText}
                    </p>
                `;
                
                const playButton = ayahDiv.querySelector('.ayah-play-button');
                if (playButton) {
                    playButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        playAudio(ayahAudioUrl, playButton);
                    });
                }
                
                ayahContentEl.appendChild(ayahDiv);
            });

            updatePaginationButtons();
        }

        /**
         * Mengubah halaman ayat (maju/mundur).
         */
        window.changePage = (delta) => {
            stopAudioPlayback();

            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                
                if (currentSurahId) {
                    renderAyahPage(); 
                }
                
                const scrollContainer = document.getElementById('scrollable-ayah-container');
                if (scrollContainer) {
                    scrollContainer.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }
        }
        
        /**
         * Memperbarui status disabled pada tombol navigasi dan informasi halaman.
         */
        function updatePaginationButtons() {
            const prevButton = document.getElementById('prev-ayah-button');
            const nextButton = document.getElementById('next-ayah-button');
            const pageInfo = document.getElementById('page-info');

            if (prevButton) prevButton.disabled = currentPage === 1;
            if (nextButton) nextButton.disabled = currentPage === totalPages || totalPages === 0;
            if (pageInfo) pageInfo.textContent = `Halaman ${currentPage}/${totalPages}`;
        }
        
        /**
         * Logika untuk mengalihkan visibilitas terjemahan.
         */
        window.toggleTranslation = () => {
            isTranslationVisible = !isTranslationVisible;
            
            if (currentSurahId) {
                const translations = document.querySelectorAll('.translation-text');
                
                translations.forEach(el => {
                    if (isTranslationVisible) {
                        el.classList.remove('hidden');
                    } else {
                        el.classList.add('hidden');
                    }
                });
            }
            
            updateTranslationButtonUI();
        }
        
        /**
         * Memperbarui teks dan ikon pada tombol toggle terjemahan di header.
         */
        function updateTranslationButtonUI() {
             const eyeOpen = document.getElementById('translation-eye-open');
             const eyeClosed = document.getElementById('translation-eye-closed');
             
             if (eyeOpen && eyeClosed) {
                 if (isTranslationVisible) {
                     eyeOpen.classList.remove('hidden');
                     eyeClosed.classList.add('hidden');
                 } else {
                     eyeOpen.classList.add('hidden');
                     eyeClosed.classList.remove('hidden');
                 }
             }
        }


        /**
         * Logika untuk kembali ke daftar surah dari tampilan detail ayat.
         */
        function backToSurahList() {
            stopAudioPlayback();
            
            const headerSurahTitleEl = document.getElementById('header-surah-title');
            
            document.getElementById('surah-list')?.classList.remove('hidden');
            document.getElementById('search-container')?.classList.remove('hidden'); 
            document.getElementById('ayah-details')?.classList.add('hidden');
            
            if (translationToggleButton) {
                translationToggleButton.classList.add('hidden');
            }

            if (headerSurahTitleEl) {
                headerSurahTitleEl.classList.add('hidden');
                headerSurahTitleEl.textContent = '';
            }
            
            currentPage = 1;
            allVerses = [];
            totalPages = 1;
            currentSurahId = null; 
        }

        /**
         * Mengalihkan tampilan antara Waktu Sholat dan Qur'an.
         */
        function toggleView() {
            stopAudioPlayback();

            const prayerView = document.getElementById('prayer-view');
            const quranView = document.getElementById('quran-view');
            const toggleButton = document.getElementById('toggle-view-button');
            const searchContainerEl = document.getElementById('search-container');
            const backToPrayerIcon = document.getElementById('back-to-prayer-icon');
            const headerSurahTitleEl = document.getElementById('header-surah-title');

            const isQuranVisible = quranView.classList.contains('hidden');

            if (isQuranVisible) {
                // Pindah ke tampilan Qur'an
                prayerView.classList.add('hidden');
                quranView.classList.remove('hidden'); 
                toggleButton.classList.add('hidden'); 
                backToPrayerIcon.classList.remove('invisible'); 
                
                if (translationToggleButton) {
                     translationToggleButton.classList.add('hidden');
                }
                
                if (headerSurahTitleEl) {
                    headerSurahTitleEl.classList.add('hidden');
                    headerSurahTitleEl.textContent = '';
                }

                if (surahListCache.length === 0) {
                    fetchSurahList();
                } else {
                    document.getElementById('surah-list')?.classList.remove('hidden');
                    document.getElementById('ayah-details')?.classList.add('hidden');
                    searchContainerEl.classList.remove('hidden'); 
                }
            } else {
                // Pindah ke tampilan Waktu Sholat
                quranView.classList.add('hidden');
                prayerView.classList.remove('hidden');
                toggleButton.classList.remove('hidden'); 
                backToPrayerIcon.classList.add('invisible'); 
                
                if (translationToggleButton) {
                     translationToggleButton.classList.add('hidden');
                }
                
                if (headerSurahTitleEl) {
                    headerSurahTitleEl.classList.add('hidden');
                    headerSurahTitleEl.textContent = '';
                }

                document.getElementById('surah-list')?.classList.remove('hidden');
                searchContainerEl.classList.remove('hidden');
                document.getElementById('ayah-details')?.classList.add('hidden');
            }
        }
        
        /**
         * Mengelola fungsi tombol kembali di header (panah kiri).
         */
        function handleHeaderBack() {
            stopAudioPlayback();

            const ayahDetailsEl = document.getElementById('ayah-details');
            const quranViewEl = document.getElementById('quran-view');

            if (!quranViewEl.classList.contains('hidden')) {
                if (!ayahDetailsEl.classList.contains('hidden')) {
                    backToSurahList(); // Dari detail ayat kembali ke daftar surah
                } else {
                    toggleView(); // Dari daftar surah kembali ke waktu sholat
                }
            } else {
                toggleView(); 
            }
        }

        /**
         * Memulai logika aplikasi setelah inisialisasi Firebase/Auth.
         */
        async function startApp() {
            
            // Hentikan interval lama jika ada (untuk keamanan)
            if (prayerInterval) clearInterval(prayerInterval);
            
            // Muat lokasi default
            await loadPrayerTimesForLocation(); 
            
            // Mulai timer jam SETELAH load pertama selesai
            prayerInterval = setInterval(updateUI, 1000); 

            // Setup Event Listeners
            document.getElementById('toggle-view-button')?.addEventListener('click', toggleView);
            document.getElementById('back-to-prayer-icon')?.addEventListener('click', handleHeaderBack);
            
            // Event listener untuk ganti lokasi
            document.getElementById('location-change-button')?.addEventListener('click', handleChangeLocation);
            document.getElementById('location-input')?.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    handleChangeLocation();
                }
            });
            
             if (surahListCache.length === 0) {
                // (fetchSurahList dipanggil saat tombol "Baca Qur'an" diklik)
             }
             
             updateTranslationButtonUI();
        }

        // --- Logika Dark Mode ---
        const darkModeToggle = document.getElementById('darkModeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');

        function setupDarkMode() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark');
                if (sunIcon) sunIcon.classList.remove('hidden');
                if (moonIcon) moonIcon.classList.add('hidden');
            } else {
                if (sunIcon) sunIcon.classList.add('hidden');
                if (moonIcon) moonIcon.classList.remove('hidden');
            }
            
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', () => {
                    document.body.classList.toggle('dark');
                    const isDark = document.body.classList.contains('dark');
                    localStorage.setItem('darkMode', isDark);
                    if (sunIcon) sunIcon.classList.toggle('hidden');
                    if (moonIcon) moonIcon.classList.toggle('hidden');
                });
            }
        }

        // Inisialisasi Firebase, Auth, dan Dark Mode saat jendela dimuat
        window.onload = () => {
             setupDarkMode(); 
             initializeFirebaseAndAuth(); 
             // startApp() akan dipanggil oleh initializeFirebaseAndAuth setelah selesai
        }

    </script>
</body>
</html>
