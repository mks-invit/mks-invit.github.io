<!DOCTYPE html>
<html lang="id" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silsilah Keluarga Puang Guru Nasing</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class', // Mengaktifkan dark mode via class 'dark'
            theme: {
                extend: {
                    colors: {
                        primary: '#3498db',
                        'primary-dark': '#2980b9',
                        'bg-light': '#f4f7f6',
                        'bg-dark': '#121212',
                        'card-dark': '#1e1e1e',
                    },
                    fontFamily: {
                        sans: ['Segoe UI', 'Tahoma', 'Geneva', 'Verdana', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom animation untuk loader & dropdown karena lebih ringkas di CSS biasa */
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-down { animation: slideDown 0.3s ease-out; }
        
        /* Garis putus-putus pohon silsilah */
        .tree-line { border-left: 2px dashed #d1d5db; }
        .dark .tree-line { border-left: 2px dashed #4b5563; }
    </style>
</head>
<body class="bg-bg-light text-slate-700 dark:bg-bg-dark dark:text-gray-200 font-sans transition-colors duration-300 p-5 min-h-screen">

<div class="max-w-4xl mx-auto pb-20">
    
    <header class="text-center mb-10">
        <div class="flex justify-center items-center gap-3 mb-1">
            <h4 class="text-xl font-bold text-slate-800 dark:text-gray-100 m-0">Silsilah Puang Guru Nasing</h4>
            
            <button id="theme-btn" class="w-8 h-8 rounded-full border border-gray-400 text-gray-500 dark:text-gray-300 dark:border-gray-500 hover:bg-primary hover:text-white hover:border-primary flex items-center justify-center transition-all duration-200" title="Ganti Mode">
                <i class="fas fa-moon"></i>
            </button>
        </div>
        <p class="text-sm text-gray-400">Aplikasi Silsilah Keluarga Interaktif</p>
    </header>

    <div id="loader" class="flex flex-col items-center mt-16">
        <div class="w-10 h-10 border-4 border-gray-200 border-t-primary rounded-full animate-spin mb-3"></div>
        <p class="text-sm text-gray-500 dark:text-gray-400">Menghubungkan ke Database...</p>
    </div>

    <div id="tree-root" class="hidden"></div>
</div>

<datalist id="all-members-list"></datalist>

<div id="modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden justify-center items-center p-4">
    <div class="bg-white dark:bg-card-dark w-full max-w-lg rounded-xl shadow-2xl p-6 max-h-[90vh] overflow-y-auto transition-colors duration-300">
        <h3 id="modal-title" class="text-xl font-bold text-primary-dark border-b border-gray-200 dark:border-gray-700 pb-3 mb-5">Form Data</h3>
        
        <input type="hidden" id="inp-mode">
        <input type="hidden" id="inp-id">
        <input type="hidden" id="inp-parent">

        <div class="mb-4">
            <label class="block text-sm font-semibold mb-1 dark:text-gray-300">Nama Lengkap</label>
            <input type="text" id="inp-name" class="w-full p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400" placeholder="Masukkan Nama" autocomplete="off">
        </div>

        <div class="mb-4">
            <label class="block text-sm font-semibold mb-1 dark:text-gray-300">Pasangan Orang Tua</label>
            <input type="text" id="inp-mother" list="all-members-list" class="w-full p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400" placeholder="Cari atau ketik nama..." autocomplete="off">
            <div class="text-xs text-gray-400 mt-1">Otomatis disarankan dari pasangan Ayah.</div>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-semibold mb-2 dark:text-gray-300">Status Pernikahan</label>
            
            <div class="flex items-center gap-3 bg-gray-50 dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700 mb-3">
                <input type="checkbox" id="chk-married" class="w-5 h-5 text-primary focus:ring-primary border-gray-300 rounded cursor-pointer" onchange="toggleSpouseSection()">
                <label for="chk-married" class="text-sm cursor-pointer dark:text-gray-300 select-none">Sudah Menikah</label>
            </div>
            
            <div id="spouse-section" class="hidden space-y-2">
                <div class="text-xs text-gray-400 mb-2">Masukkan nama pasangan (bisa lebih dari satu).</div>
                <div id="spouse-container" class="space-y-2"></div>
                <button type="button" class="w-full py-2 px-4 bg-blue-50 text-blue-600 border border-dashed border-blue-300 rounded-lg hover:bg-blue-100 font-semibold text-sm transition-colors mt-2 dark:bg-gray-700 dark:text-blue-400 dark:border-gray-600 dark:hover:bg-gray-600" onclick="addSpouseRow()">+ Tambah Pasangan</button>
            </div>
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700 mt-6">
            <button class="px-5 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold transition-colors dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600" onclick="closeModal()">Batal</button>
            <button class="px-5 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark font-semibold shadow-md hover:shadow-lg transition-all" onclick="submitData()">Simpan</button>
        </div>
    </div>
</div>

<script>
    // ==============================================================
    // KONFIGURASI SCRIPT (URL TETAP SAMA)
    const API_URL = "https://script.google.com/macros/s/AKfycbxaOo9p7QZHNNBNqt-s7_CPHh_J8672SRAVkSxUv0VljwovwN4zaYx9bkoL_VtB1dTB/exec";
    // ==============================================================

    let allData = [];

    // --- DARK MODE LOGIC ---
    const themeBtn = document.getElementById('theme-btn');
    const themeIcon = themeBtn.querySelector('i');
    const htmlEl = document.documentElement;

    // Cek local storage
    if (localStorage.getItem('theme') === 'dark') {
        htmlEl.classList.add('dark');
        themeIcon.classList.replace('fa-moon', 'fa-sun');
    } else {
        htmlEl.classList.remove('dark');
    }

    themeBtn.addEventListener('click', () => {
        if (htmlEl.classList.contains('dark')) {
            htmlEl.classList.remove('dark');
            localStorage.setItem('theme', 'light');
            themeIcon.classList.replace('fa-sun', 'fa-moon');
        } else {
            htmlEl.classList.add('dark');
            localStorage.setItem('theme', 'dark');
            themeIcon.classList.replace('fa-moon', 'fa-sun');
        }
    });
    // -----------------------

    window.onload = function() {
        fetchData();
    };

    async function fetchData() {
        showLoader(true);
        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            allData = data;
            updateAllMembersList();
            renderTree();
            showLoader(false);
        } catch (error) {
            alert("Gagal mengambil data: " + error);
            showLoader(false);
        }
    }

    async function postData(payload) {
        showLoader(true);
        closeModal();
        try {
            const response = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            allData = data; 
            updateAllMembersList();
            renderTree();
            showLoader(false);
        } catch (error) {
            alert("Gagal menyimpan: " + error);
            showLoader(false);
        }
    }

    function showLoader(show) {
        document.getElementById('loader').style.display = show ? 'flex' : 'none';
        document.getElementById('tree-root').style.display = show ? 'none' : 'block';
    }

    function updateAllMembersList() {
        const datalist = document.getElementById('all-members-list');
        datalist.innerHTML = ''; 
        const uniqueNames = new Set();

        allData.forEach(person => {
            if(person.name && person.name.trim()) uniqueNames.add(person.name.trim());
            if(person.spouse && person.spouse.trim()) {
                person.spouse.split(',').forEach(s => {
                    if(s.trim()) uniqueNames.add(s.trim());
                });
            }
        });
        
        Array.from(uniqueNames).sort().forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            datalist.appendChild(option);
        });
    }

    // --- TREE RENDERING WITH TAILWIND CLASSES ---
    function renderTree() {
        const container = document.getElementById('tree-root');
        container.innerHTML = '';
        const roots = allData.filter(d => !d.parentId || d.parentId === "" || d.id === 'root');
        const ul = document.createElement('ul');
        // Root ul padding reset
        ul.className = 'pl-0 border-none';
        roots.forEach(root => ul.appendChild(createNode(root, 0)));
        container.appendChild(ul);
    }

    function createNode(person, level) {
        const li = document.createElement('li');
        li.className = 'my-3';

        const children = allData.filter(d => 
            d.parentId == person.id || 
            (d.motherName && d.motherName.trim() === person.name)
        );

        const hasChildren = children.length > 0;

        // Logic Label Orang Tua
        let parentLabel = `<span class="block text-[0.7rem] uppercase tracking-wide text-primary mb-0.5">â˜… Leluhur Utama</span>`;
        if (person.parentId && person.parentId !== 'root') {
            const father = allData.find(d => d.id === person.parentId);
            const fatherName = father ? father.name : "???";
            let motherName = person.motherName && person.motherName.trim() !== "" 
                ? person.motherName 
                : (father && father.spouse ? father.spouse : "(pasangan)");
            
            parentLabel = `<span class="block text-[0.7rem] uppercase tracking-wide text-gray-400 dark:text-gray-500 mb-0.5">Anak dari: <strong class="text-slate-700 dark:text-gray-300">${fatherName}</strong> & <strong class="text-slate-700 dark:text-gray-300">${motherName}</strong></span>`;
        }

        // Logic Pasangan Badge
        let spouseHtml = '';
        if (person.spouse) {
            const spouses = person.spouse.split(',').map(s => s.trim()).filter(s => s);
            if(spouses.length > 0) {
                spouseHtml = `<div class="flex flex-wrap gap-1.5 mt-1">`;
                spouses.forEach(s => {
                    spouseHtml += `<span class="inline-flex items-center text-xs px-2 py-0.5 rounded-full bg-pink-50 text-pink-600 border border-pink-200 dark:bg-pink-900/20 dark:text-pink-300 dark:border-pink-800"><i class="fas fa-heart mr-1 text-[0.6rem]"></i> ${s}</span>`;
                });
                spouseHtml += `</div>`;
            }
        }

        // Tentukan warna border kiri berdasarkan level (Color mapping)
        // Level 0: dark, 1: blue, 2: teal, 3: orange, 4: purple
        const borderColors = [
            'border-l-slate-700 dark:border-l-gray-400 bg-gray-100 dark:bg-slate-800', 
            'border-l-[#2980b9]', 
            'border-l-[#16a085]', 
            'border-l-[#f39c12]', 
            'border-l-[#8e44ad]'
        ];
        // Gunakan modulus agar warna berulang jika level > 4
        let colorClass = level === 0 ? borderColors[0] : borderColors[(level % 4) || 1];
        if(level > 0 && level % 4 === 0) colorClass = borderColors[4];

        const div = document.createElement('div');
        // Tailwind classes untuk Node Card
        div.className = `relative flex items-start bg-white dark:bg-card-dark p-4 rounded-lg shadow-sm hover:shadow-md border-l-[5px] transition-all duration-200 group ${colorClass}`;
        
        if(level === 0) div.classList.add('shadow');

        const toggleIcon = hasChildren 
            ? '<i class="fas fa-chevron-right"></i>' 
            : '<i class="fas fa-circle text-[6px] opacity-30"></i>';

        div.innerHTML = `
            <button class="toggle-btn w-5 mt-1 mr-2 text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-transform duration-200 ${hasChildren ? 'cursor-pointer' : 'cursor-default'}" onclick="toggleChild(this)">${toggleIcon}</button>
            
            <div class="flex-grow cursor-pointer" onclick="toggleChild(this.previousElementSibling)">
                ${parentLabel}
                <span class="block text-lg font-bold mb-1 text-slate-800 dark:text-gray-100">${person.name}</span>
                ${spouseHtml}
            </div>

            <div class="flex gap-1.5 ml-2 opacity-10 group-hover:opacity-100 transition-opacity duration-300 self-center">
                <button class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 hover:bg-primary hover:text-white flex items-center justify-center transition-colors dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-primary" onclick="openModal('edit', '${person.id}')" title="Edit"><i class="fas fa-pen text-xs"></i></button>
                <button class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 hover:bg-primary hover:text-white flex items-center justify-center transition-colors dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-primary" onclick="openModal('add', '${person.id}')" title="Tambah Anak"><i class="fas fa-plus text-xs"></i></button>
                ${level > 0 ? `<button class="w-8 h-8 rounded-full bg-red-50 text-red-500 hover:bg-red-500 hover:text-white flex items-center justify-center transition-colors dark:bg-red-900/20 dark:hover:bg-red-600" onclick="deleteItem('${person.id}')" title="Hapus"><i class="fas fa-trash text-xs"></i></button>` : ''}
            </div>
        `;

        li.appendChild(div);

        if (hasChildren || true) {
            const childUl = document.createElement('ul');
            // Class tree-line didefinisikan di style head untuk border dashed
            childUl.className = 'children-container hidden pl-[22px] tree-line list-none'; 
            
            if (level === 0) {
                childUl.classList.remove('hidden');
                childUl.classList.add('block'); // Force open level 0
                div.querySelector('.toggle-btn').innerHTML = '<i class="fas fa-chevron-down"></i>';
            }
            children.forEach(child => childUl.appendChild(createNode(child, level + 1)));
            li.appendChild(childUl);
        }
        return li;
    }

    function toggleChild(btn) {
        const card = btn.parentElement;
        // Cari ul sibling berikutnya dari card
        const ul = card.nextElementSibling; 
        
        if (ul && ul.tagName === 'UL' && ul.children.length > 0) {
            const isHidden = ul.classList.contains('hidden');
            if (isHidden) {
                ul.classList.remove('hidden');
                ul.classList.add('block', 'animate-slide-down');
                btn.innerHTML = '<i class="fas fa-chevron-down"></i>';
                btn.classList.add('rotate-90'); // Opsional animasi rotate
            } else {
                ul.classList.add('hidden');
                ul.classList.remove('block', 'animate-slide-down');
                btn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                btn.classList.remove('rotate-90');
            }
        }
    }

    // --- FORM & INTERACTION LOGIC ---

    function toggleSpouseSection() {
        const isMarried = document.getElementById('chk-married').checked;
        const section = document.getElementById('spouse-section');
        const container = document.getElementById('spouse-container');

        if (isMarried) {
            section.classList.remove('hidden');
            if (container.children.length === 0) addSpouseRow();
        } else {
            section.classList.add('hidden');
        }
    }

    function addSpouseRow(value = "") {
        const container = document.getElementById('spouse-container');
        const div = document.createElement('div');
        div.className = 'flex gap-2';
        div.innerHTML = `
            <input type="text" class="inp-spouse-dynamic w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-primary outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white" list="all-members-list" value="${value}" placeholder="Cari atau ketik Nama Pasangan..." autocomplete="off">
            <button type="button" class="w-10 flex-shrink-0 bg-red-50 text-red-500 rounded-lg border border-red-100 hover:bg-red-100 flex items-center justify-center transition-colors dark:bg-red-900/20 dark:border-red-800 dark:hover:bg-red-900/40" onclick="this.parentElement.remove()" title="Hapus"><i class="fas fa-times"></i></button>
        `;
        container.appendChild(div);
    }

    function openModal(mode, id) {
        const modal = document.getElementById('modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        document.getElementById('inp-mode').value = mode;
        const spouseContainer = document.getElementById('spouse-container');
        spouseContainer.innerHTML = ''; 
        
        document.getElementById('inp-name').value = '';
        document.getElementById('inp-mother').value = '';
        document.getElementById('inp-parent').value = '';
        document.getElementById('chk-married').checked = false;

        if (mode === 'add') {
            document.getElementById('modal-title').innerText = "Tambah Keturunan";
            document.getElementById('inp-parent').value = id; 
            
            const father = allData.find(d => d.id == id);
            if (father && father.spouse) {
                const spouses = father.spouse.split(',').filter(s => s.trim());
                if (spouses.length === 1) {
                    document.getElementById('inp-mother').value = spouses[0].trim();
                }
            }
            toggleSpouseSection(); 

        } else {
            document.getElementById('modal-title').innerText = "Edit Data";
            const p = allData.find(d => d.id == id);
            
            document.getElementById('inp-id').value = id;
            document.getElementById('inp-name').value = p.name;
            document.getElementById('inp-mother').value = p.motherName || '';

            if (p.spouse && p.spouse.trim() !== "") {
                document.getElementById('chk-married').checked = true;
                p.spouse.split(',').forEach(s => addSpouseRow(s.trim()));
            }
            toggleSpouseSection();
        }
    }

    function closeModal() {
        const modal = document.getElementById('modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    function submitData() {
        const mode = document.getElementById('inp-mode').value;
        const isMarried = document.getElementById('chk-married').checked;
        
        let spouseString = "";
        if (isMarried) {
            const spouseInputs = document.querySelectorAll('.inp-spouse-dynamic');
            const spouseList = [];
            spouseInputs.forEach(inp => {
                if (inp.value.trim() !== "") spouseList.push(inp.value.trim());
            });
            spouseString = spouseList.join(', ');
        }
        
        const payload = {
            action: mode,
            name: document.getElementById('inp-name').value,
            spouse: spouseString,
            motherName: document.getElementById('inp-mother').value
        };

        if (!payload.name) { alert("Nama wajib diisi!"); return; }

        if (mode === 'add') {
            payload.parentId = document.getElementById('inp-parent').value;
        } else {
            payload.id = document.getElementById('inp-id').value;
        }

        postData(payload);
    }

    function deleteItem(id) {
        if(confirm("Hapus data ini? Keturunan di bawahnya juga akan terhapus.")) {
            postData({ action: 'delete', id: id });
        }
    }
</script>
</body>
</html>
