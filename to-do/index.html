<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-R-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIC - To Do List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10b981">
    
    <style>
        /* Menggunakan font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Dark Mode Styles */
        body.dark {
            background-color: #1f2937;
            color: #f3f4f6;
        }
        body.dark #app-container {
            background-color: #374151;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
        body.dark .border-gray-300 {
            border-color: #4b5563;
        }
        
        .task-list-item {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .task-list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }

        .completed-task .task-text {
            text-decoration: line-through;
            color: #9ca3af;
        }
        
        /* (Baru) Style untuk item yang sedang disinkronisasi */
        .pending-delete {
            opacity: 0.5;
            text-decoration: line-through;
            font-style: italic;
        }

        /* Scrollbar untuk daftar tugas (DIUBAH) */
        #taskList {
            /* max-height: 50vh; Dihapus untuk layout flex-1 */
            overflow-y: auto;
        }
        #taskList::-webkit-scrollbar {
            width: 8px;
        }
        #taskList::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
        body.dark #taskList::-webkit-scrollbar-thumb {
            background-color: #4b5563;
        }
        
        /* Style untuk tombol filter aktif */
        .filter-active {
            background-color: #10b981; /* emerald-500 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.5);
            transform: translateY(-1px);
        }

    </style>
</head>
<body class="h-screen overflow-hidden p-4 sm:p-8 flex items-center justify-center">

    <div id="offline-status" class="hidden fixed bottom-0 left-0 right-0 p-3 bg-yellow-400 dark:bg-yellow-600 text-center text-black dark:text-white font-semibold z-50 shadow-lg">
        You are offline. Syncing later.
    </div>

    <div id="app-container" class="max-w-4xl mx-auto bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-xl transition-colors duration-300 h-full w-full flex flex-col overflow-hidden">
        
        <header class="grid grid-cols-3 items-center mb-6 border-b border-gray-200 dark:border-gray-700 pb-4">
            <div></div>
            
            <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-900 dark:text-white text-center col-span-1">
                AIC - To Do List
            </h1>
            
            <button id="darkModeToggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150 col-span-1 justify-self-end" aria-label="Toggle Dark Mode">
                <svg id="sunIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="moonIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>
        
        <div class="mb-8 p-4 border border-gray-200 dark:border-gray-700 rounded-xl shadow-inner dark:shadow-none bg-gray-50 dark:bg-gray-700/50">
            <h2 class="text-xl font-semibold mb-3 dark:text-gray-200 text-center">Tambah Tugas Baru</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                
                <div class="md:col-span-2">
                    <input type="text" id="taskInput" placeholder="Teks Tugas (Misal: Selesaikan laporan bulanan)" 
                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-800 dark:text-white transition duration-150" required>
                </div>

                <div>
                    <input type="date" id="dueDateInput" title="Batas Waktu" 
                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-800 dark:text-white transition duration-150">
                </div>

                <div>
                    <input type="text" id="locationInput" placeholder="Lokasi (Opsional)" title="Lokasi Tugas" 
                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-800 dark:text-white transition duration-150">
                </div>

                <div class="md:col-span-4">
                    <button id="addTaskBtn" disabled
                            class="w-full p-3 bg-emerald-500 text-white font-bold rounded-lg hover:bg-emerald-600 disabled:bg-gray-400 dark:disabled:bg-gray-600 transition duration-150 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-emerald-500/50">
                        Tambah Tugas
                    </button>
                </div>
            </div>
        </div>

        <div class="mb-6 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
            
            <div class="flex flex-wrap justify-center sm:justify-start gap-2">
                <button id="filterAllBtn" class="filter-btn p-2 text-sm font-medium rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-150 filter-active">Semua</button>
                <button id="filterActiveBtn" class="filter-btn p-2 text-sm font-medium rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-150">Aktif</button>
                <button id="filterCompletedBtn" class="filter-btn p-2 text-sm font-medium rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-150">Selesai</button>
            </div>
            
            <input type="text" id="searchInput" placeholder="Cari Tugas/Lokasi..." 
                   class="w-full sm:w-auto md:w-64 p-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-800 dark:text-white transition duration-150">
        </div>


        <div id="taskList" class="space-y-3 pb-4 flex-1">
            <div id="emptyState" class="text-center p-10 bg-gray-100 dark:bg-gray-700 rounded-xl text-gray-500 dark:text-gray-400">
                <p class="text-lg font-medium">Tidak ada tugas ditemukan.</p>
                <p>Coba tambahkan tugas baru atau sesuaikan filter Anda.</p>
            </div>
        </div>

        <div id="authInfoDisplay" class="mt-4 p-2 bg-blue-100 dark:bg-blue-900/50 rounded-lg text-xs text-blue-700 dark:text-blue-300 transition-colors duration-300 text-center">
            <span id="loadingIndicator" class="animate-pulse">Memuat data...</span>
            <span id="currentUserId">Menggunakan Google Apps Script API.</span>
        </div>

        <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-md w-full">
                <h3 class="text-xl font-bold mb-4 dark:text-white text-center">Konfirmasi Hapus</h3>
                <p class="mb-6 text-gray-700 dark:text-gray-300 text-center">Anda yakin ingin menghapus tugas ini? Ini akan disinkronkan saat online.</p>
                <div class="flex justify-center space-x-3">
                    <button id="cancelDeleteBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">Batal</button>
                    <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">Hapus</button>
                </div>
            </div>
        </div>

        <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-md w-full">
                <h3 class="text-xl font-bold mb-4 dark:text-white text-center">Edit Tugas</h3>
                <div class="space-y-4">
                    <input type="text" id="editTaskText" placeholder="Teks Tugas" 
                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-white">
                    <input type="date" id="editDueDate" title="Batas Waktu" 
                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-white">
                    <input type="text" id="editLocation" placeholder="Lokasi (Opsional)" title="Lokasi Tugas" 
                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-white">
                </div>
                <div class="flex justify-center space-x-3 mt-6">
                    <button id="cancelEditBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">Batal</button>
                    <button id="saveEditBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">Simpan</button>
                </div>
            </div>
        </div>
        
    </div>

    <script>
        // --- KONFIGURASI API ---
        const MOCK_API_ENDPOINT = "https://script.google.com/macros/s/AKfycbxPu_354U8wzqYalUAKhvIaAGJqmZzM1bZYD9FQDsnuP0n4vmfFNQg6wxBuvzjEWffODw/exec";
        
        // --- (BARU) Kunci LocalStorage ---
        const TASKS_CACHE_KEY = 'tasksCache';
        const SYNC_QUEUE_KEY = 'syncQueue';
        const NOTIFIED_TASKS_KEY = 'notifiedTasks'; // (BARU) Untuk Notifikasi

        // --- Variabel Global & Cache ---
        let allTasksCache = [];
        let syncQueue = []; 
        let notifiedTaskIds = []; // (BARU) Untuk Notifikasi
        let isSyncing = false; 
        let currentFilterStatus = 'all'; 
        let currentSearchTerm = '';
        let taskIdToDelete = null;
        let taskIdToEdit = null;
        
        // --- Elemen DOM ---
        const taskListEl = document.getElementById('taskList');
        const emptyStateEl = document.getElementById('emptyState');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const taskInput = document.getElementById('taskInput');
        const dueDateInput = document.getElementById('dueDateInput');
        const locationInput = document.getElementById('locationInput');
        const searchInput = document.getElementById('searchInput');
        const loadingIndicatorEl = document.getElementById('loadingIndicator');
        const authInfoDisplayEl = document.getElementById('authInfoDisplay');
        const currentUserIdEl = document.getElementById('currentUserId');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
        const offlineStatusEl = document.getElementById('offline-status');

        // Modal Elements
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const editModal = document.getElementById('editModal');
        const saveEditBtn = document.getElementById('saveEditBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const editTaskText = document.getElementById('editTaskText');
        const editDueDate = document.getElementById('editDueDate');
        const editLocation = document.getElementById('editLocation');

        // Filter Buttons
        const filterStatusBtns = {
            all: document.getElementById('filterAllBtn'),
            active: document.getElementById('filterActiveBtn'),
            completed: document.getElementById('filterCompletedBtn')
        };

        // --- (BARU) Helper Fungsi Penyimpanan ---

        /**
         * Memuat data tugas dan antrian sinkronisasi dari localStorage.
         */
        function loadFromStorage() {
            try {
                allTasksCache = JSON.parse(localStorage.getItem(TASKS_CACHE_KEY) || '[]');
                syncQueue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]');
                // (BARU) Muat ID notifikasi
                notifiedTaskIds = JSON.parse(localStorage.getItem(NOTIFIED_TASKS_KEY) || '[]');
            } catch (e) {
                console.error("Gagal memuat cache", e);
                allTasksCache = [];
                syncQueue = [];
                notifiedTaskIds = [];
                localStorage.removeItem(TASKS_CACHE_KEY);
                localStorage.removeItem(SYNC_QUEUE_KEY);
                localStorage.removeItem(NOTIFIED_TASKS_KEY);
            }
        }

        /**
         * Menyimpan data tugas dan antrian sinkronisasi ke localStorage.
         */
        function saveToStorage() {
            try {
                localStorage.setItem(TASKS_CACHE_KEY, JSON.stringify(allTasksCache));
                localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(syncQueue));
                // (BARU) Simpan ID notifikasi
                localStorage.setItem(NOTIFIED_TASKS_KEY, JSON.stringify(notifiedTaskIds));
            } catch (e) {
                console.warn("Gagal menyimpan ke localStorage:", e);
            }
        }
        
        // ... (addToSyncQueue tidak berubah) ...
        function addToSyncQueue(item) {
            if (item.action === 'update' && item.id.startsWith('temp-')) {
                const addActionIndex = syncQueue.findIndex(q => q.action === 'add' && q.data.id === item.id);
                if (addActionIndex > -1) {
                    syncQueue[addActionIndex].data = { ...syncQueue[addActionIndex].data, ...item.updates };
                    saveToStorage();
                    return; 
                }
            }
            if (item.action === 'delete' && item.id.startsWith('temp-')) {
                syncQueue = syncQueue.filter(q => !(q.action === 'add' && q.data.id === item.id));
                saveToStorage();
                return; 
            }
            syncQueue.push(item);
            saveToStorage();
        }

        // --- (BARU) Fungsi Notifikasi ---

        /**
         * Meminta izin kepada pengguna untuk mengirim notifikasi.
         */
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log("Browser ini tidak mendukung notifikasi desktop.");
                return;
            }

            if (Notification.permission === 'granted') {
                return; // Izin sudah diberikan
            }

            if (Notification.permission !== 'denied') {
                try {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        console.log('Izin notifikasi diberikan.');
                    } else {
                        console.log('Izin notifikasi ditolak.');
                    }
                } catch (error) {
                    console.error('Error saat meminta izin notifikasi:', error);
                }
            }
        }

        /**
         * Memeriksa tugas dan mengirim notifikasi jika ada yang jatuh tempo hari ini.
         */
        function checkAndSendNotifications() {
            if (Notification.permission !== 'granted') {
                return; // Tidak ada izin
            }

            const todayTasks = allTasksCache.filter(task => 
                !task.completed && 
                task.dueDate && 
                isSameDay(task.dueDate, new Date())
            );

            todayTasks.forEach(task => {
                // Hanya kirim notifikasi sekali untuk setiap tugas
                if (!notifiedTaskIds.includes(task.id)) {
                    console.log(`Mengirim notifikasi untuk: ${task.text}`);
                    
                    const notification = new Notification('Tugas Jatuh Tempo Hari Ini!', {
                        body: task.text,
                        icon: 'icon-192x192.png' // Pastikan Anda punya ikon ini
                    });
                    
                    // Tandai bahwa notifikasi telah dikirim
                    notifiedTaskIds.push(task.id);
                }
            });
            
            // Bersihkan notifiedTaskIds dari tugas yang sudah tidak ada
            const allTaskIds = allTasksCache.map(t => t.id);
            notifiedTaskIds = notifiedTaskIds.filter(id => allTaskIds.includes(id));
            
            saveToStorage(); // Simpan daftar ID yang sudah dinotifikasi
        }

        // --- Helper Functions (Lainnya) ---

        // ... (setLoading, updateOnlineStatus, showSyncStatus, hideSyncStatus, apiCall tidak berubah) ...
        function setLoading(isLoading, message = 'Memuat...') {
            if (isLoading) {
                loadingIndicatorEl.textContent = message;
                addTaskBtn.disabled = true;
                taskListEl.classList.add('opacity-50');
            } else {
                loadingIndicatorEl.textContent = '';
                validateInputs(); // Re-enable button if inputs are valid
                taskListEl.classList.remove('opacity-50');
            }
        }
        function updateOnlineStatus(isOnline) {
            offlineStatusEl.classList.toggle('hidden', isOnline);
            validateInputs(); // Validasi ulang tombol tambah
            
            if (isOnline) {
                processSyncQueue();
            }
        }
        function showSyncStatus(message, isError = false) {
            currentUserIdEl.textContent = message;
            authInfoDisplayEl.classList.remove('bg-blue-100', 'bg-red-100', 'bg-yellow-100', 'dark:bg-blue-900/50', 'dark:bg-red-900/50', 'dark:bg-yellow-900/50');
            if (isError) {
                authInfoDisplayEl.classList.add('bg-red-100', 'dark:bg-red-900/50');
            } else {
                authInfoDisplayEl.classList.add('bg-yellow-100', 'dark:bg-yellow-900/50'); // Kuning untuk sinkronisasi
            }
        }
        function hideSyncStatus() {
            currentUserIdEl.textContent = 'Menggunakan Google Apps Script API.';
            authInfoDisplayEl.classList.remove('bg-red-100', 'bg-yellow-100', 'dark:bg-red-900/50', 'dark:bg-yellow-900/50');
            authInfoDisplayEl.classList.add('bg-blue-100', 'dark:bg-blue-900/50');
        }
        async function apiCall(payload) {
            if (!navigator.onLine) {
                throw new Error("Offline. Tidak dapat melakukan panggilan API.");
            }
            setLoading(true, 'Menghubungi server...'); 
            const maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(MOCK_API_ENDPOINT, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (response.ok && data.status === 'success') {
                        setLoading(false);
                        return data; 
                    } else {
                        const errorMessage = data.message || `Apps Script Error: Status ${response.status}`;
                        throw new Error(errorMessage);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        setLoading(false);
                        throw new Error(`Gagal berinteraksi dengan API setelah ${maxRetries} kali coba: ${error.message}`);
                    }
                    console.warn(`Fetch attempt ${i + 1} failed: ${error.message}. Retrying...`);
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // ... (formatDate dan isSameDay tidak berubah) ...
        function formatDate(dateObj) {
            if (!dateObj || dateObj.toString() === 'Invalid Date') return '';
            const d = new Date(dateObj);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function isSameDay(d1, d2) {
            const date1 = new Date(d1);
            const date2 = new Date(d2);
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }
        
        // ... (validateInputs tidak berubah) ...
        function validateInputs() {
            const isInputValid = taskInput.value.trim() !== "";
            addTaskBtn.disabled = !isInputValid;
        }

        // --- (BARU) Logika Sinkronisasi ---

        // ... (processSyncQueue tidak berubah) ...
        async function processSyncQueue() {
            if (isSyncing || !navigator.onLine || syncQueue.length === 0) {
                return;
            }
            isSyncing = true;
            showSyncStatus(`Sinkronisasi ${syncQueue.length} perubahan...`);
            const queueToProcess = [...syncQueue]; 
            syncQueue = []; 
            saveToStorage(); 
            let failedItems = [];
            for (const item of queueToProcess) {
                try {
                    if ((item.action === 'update' || item.action === 'delete') && item.id.startsWith('temp-')) {
                        continue; 
                    }
                    await apiCall(item);
                } catch (error) {
                    console.error("Gagal sinkronisasi item:", item, error);
                    failedItems.push(item); 
                }
            }
            syncQueue = [...failedItems, ...syncQueue]; 
            saveToStorage();
            isSyncing = false;
            if (failedItems.length > 0) {
                showSyncStatus(`Gagal sinkronisasi ${failedItems.length} item.`, true);
            } else {
                hideSyncStatus();
            }
            await fetchTasks();
        }


        // --- CRUD & API Interaksi (Diperbarui) ---

        /**
         * Mengambil semua tugas dari Google Sheets via Apps Script API.
         */
        async function fetchTasks() {
            if (isSyncing || (!navigator.onLine && syncQueue.length > 0)) {
                return;
            }
            setLoading(true, 'Menyegarkan data...');
            if (!navigator.onLine) {
                loadingIndicatorEl.textContent = 'Offline. Menampilkan data dari cache.';
                setLoading(false);
                return; 
            }
            const maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(MOCK_API_ENDPOINT + '?action=read');
                    const result = await response.json();

                    if (response.ok && result.status === 'success') {
                        allTasksCache = result.data.map(task => ({
                            id: task.id.toString(),
                            text: task.text,
                            dueDate: task.dueDate ? formatDate(task.dueDate) : '',
                            location: task.location || '',
                            completed: task.completed === true || task.completed === 'TRUE',
                            createdAt: task.createdAt
                        }));
                        
                        saveToStorage(); 
                        renderTasks(allTasksCache);
                        
                        // (BARU) Periksa notifikasi setelah data baru dimuat
                        checkAndSendNotifications(); 
                        
                        setLoading(false);
                        return; 
                    } else {
                        throw new Error(result.message || 'Gagal mengambil data tugas.');
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        setLoading(false);
                        console.error("Error fetching tasks:", error);
                        showSyncStatus(`Gagal memuat data: ${error.message}.`, true);
                        return; 
                    }
                    console.warn(`Fetch attempt ${i + 1} failed: ${error.message}. Retrying...`);
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // ... (addTask, toggleTask, removeTask, saveEditedTask tidak berubah) ...
        async function addTask() {
            const text = taskInput.value.trim();
            const dueDate = dueDateInput.value || '';
            const location = locationInput.value.trim() || '';
            if (text === "") return;
            const newTask = {
                id: `temp-${Date.now().toString()}`, 
                text: text,
                dueDate: dueDate,
                location: location,
                completed: false,
                createdAt: new Date().toISOString()
            };
            allTasksCache.unshift(newTask); 
            addToSyncQueue({
                action: "add",
                data: newTask
            });
            renderTasks(allTasksCache);
            taskInput.value = '';
            dueDateInput.value = '';
            locationInput.value = '';
            validateInputs();
            if (navigator.onLine) {
                processSyncQueue();
            }
        }
        async function toggleTask(id) {
            const task = allTasksCache.find(t => t.id === id);
            if (!task) return;
            const newCompletedStatus = !task.completed;
            task.completed = newCompletedStatus; 
            addToSyncQueue({
                action: "update",
                id: id,
                updates: {
                    completed: newCompletedStatus
                }
            });
            renderTasks(allTasksCache); 
            if (navigator.onLine) {
                processSyncQueue();
            }
        }
        async function removeTask(id) {
            allTasksCache = allTasksCache.filter(t => t.id !== id); 
            addToSyncQueue({
                action: "delete",
                id: id
            });
            renderTasks(allTasksCache);
            if (navigator.onLine) {
                processSyncQueue();
            }
        }
        async function saveEditedTask() {
            const id = taskIdToEdit;
            if (!id) return;
            const task = allTasksCache.find(t => t.id === id);
            if (!task) return;
            const newText = editTaskText.value.trim();
            const newDueDate = editDueDate.value || '';
            const newLocation = editLocation.value.trim() || '';
            if (newText === "") {
                console.error("Teks tugas tidak boleh kosong.");
                return;
            }
            const updates = {
                text: newText,
                dueDate: newDueDate,
                location: newLocation
            };
            Object.assign(task, updates);
            addToSyncQueue({
                action: "update",
                id: id,
                updates: updates
            });
            renderTasks(allTasksCache);
            closeEditModal();
            if (navigator.onLine) {
                processSyncQueue();
            }
        }
        
        // --- Filtering dan Rendering (Diperbarui) ---

        // ... (renderTasks tidak berubah) ...
        function renderTasks(tasks) {
            let filteredTasks = tasks.filter(task => {
                if (currentFilterStatus === 'active') return !task.completed;
                if (currentFilterStatus === 'completed') return task.completed;
                return true; 
            });
            const searchTerm = currentSearchTerm.toLowerCase();
            if (searchTerm) {
                filteredTasks = filteredTasks.filter(task => 
                    task.text.toLowerCase().includes(searchTerm) || 
                    task.location.toLowerCase().includes(searchTerm)
                );
            }
            filteredTasks.sort((a, b) => {
                if (a.completed !== b.completed) {
                    return a.completed ? 1 : -1;
                }
                const dateA = a.dueDate ? new Date(a.dueDate).getTime() : Infinity;
                const dateB = b.dueDate ? new Date(b.dueDate).getTime() : Infinity;
                return dateA - dateB;
            });
            taskListEl.innerHTML = '';
            if (filteredTasks.length === 0) {
                emptyStateEl.classList.remove('hidden');
            } else {
                emptyStateEl.classList.add('hidden');
                filteredTasks.forEach(task => {
                    const taskEl = createTaskElement(task);
                    taskListEl.appendChild(taskEl);
                });
            }
        }

        // ... (createTaskElement tidak berubah) ...
        function createTaskElement(task) {
            const item = document.createElement('div');
            item.className = `task-list-item flex items-center p-4 border border-gray-200 dark:border-gray-700 rounded-xl shadow-sm hover:shadow-md transition-all duration-200 ${task.completed ? 'completed-task bg-gray-100 dark:bg-gray-700/70' : 'bg-white dark:bg-gray-800'}`;
            item.setAttribute('data-id', task.id);
            const isDueToday = task.dueDate && isSameDay(task.dueDate, new Date());
            const pendingAction = syncQueue.find(item => item.id === task.id || (item.data && item.data.id === task.id));
            if (pendingAction && pendingAction.action === 'delete') {
                item.classList.add('pending-delete');
            }
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = task.completed;
            checkbox.className = 'w-5 h-5 text-emerald-600 bg-gray-100 border-gray-300 rounded focus:ring-emerald-500 dark:focus:ring-emerald-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600 mr-4 flex-shrink-0';
            checkbox.onclick = (e) => {
                e.stopPropagation();
                toggleTask(task.id);
            };
            const content = document.createElement('div');
            content.className = 'flex-grow min-w-0';
            const text = document.createElement('p');
            text.className = `task-text font-medium text-lg truncate ${task.completed ? 'text-gray-500' : 'dark:text-white'}`;
            text.textContent = task.text;
            content.appendChild(text);
            const meta = document.createElement('div');
            meta.className = 'flex flex-wrap items-center text-sm mt-1 text-gray-500 dark:text-gray-400';
            if (pendingAction) {
                const pendingEl = document.createElement('span');
                pendingEl.title = "Menunggu sinkronisasi";
                let actionText = 'Menunggu...';
                if (pendingAction.action === 'add') actionText = 'Menunggu ditambah';
                if (pendingAction.action === 'update') actionText = 'Menunggu diupdate';
                if (pendingAction.action === 'delete') actionText = 'Menunggu dihapus';
                pendingEl.innerHTML = `<svg class="w-4 h-4 mr-1 text-yellow-500 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2.586a10.001 10.001 0 00-15.356-2.586m0 0V3.582M20 20v-5h-.582m-15.356-2.586a10.001 10.001 0 0015.356 2.586m0 0v4.418"></path></svg>`;
                pendingEl.className = 'flex items-center text-xs mr-3';
                pendingEl.appendChild(document.createTextNode(actionText));
                meta.appendChild(pendingEl);
            }
            if (task.dueDate) {
                const dateText = document.createElement('span');
                dateText.className = `mr-3 flex items-center ${isDueToday && !task.completed ? 'text-red-500 font-semibold' : ''}`;
                dateText.innerHTML = `<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                      ${task.dueDate}${isDueToday ? ' (Hari Ini!)' : ''}`;
                meta.appendChild(dateText);
            }
            if (task.location) {
                const locationText = document.createElement('span');
                locationText.className = 'mr-3 flex items-center';
                locationText.innerHTML = `<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.243-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                          ${task.location}`;
                meta.appendChild(locationText);
            }
            content.appendChild(meta);
            const actions = document.createElement('div');
            actions.className = 'flex-shrink-0 ml-4 space-x-2 flex';
            const editBtn = document.createElement('button');
            editBtn.className = 'p-2 rounded-full text-blue-500 hover:bg-blue-100 dark:hover:bg-gray-700 transition duration-150';
            editBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7 1l-2 2L18 9l2-2 2.585 2.585zm1.414-2.586a2 2 0 012.828 0l2.586 2.586a2 2 0 010 2.828l-10.4 10.4L5 19l2.828-2.828 10.4-10.4z"></path></svg>`;
            editBtn.title = "Edit Tugas";
            editBtn.onclick = (e) => {
                e.stopPropagation();
                openEditModal(task.id);
            };
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'p-2 rounded-full text-red-500 hover:bg-red-100 dark:hover:bg-gray-700 transition duration-150';
            deleteBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
            deleteBtn.title = "Hapus Tugas";
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                openDeleteModal(task.id);
            };
            actions.appendChild(editBtn);
            actions.appendChild(deleteBtn);
            if (pendingAction && pendingAction.action === 'delete') {
                checkbox.disabled = true;
                editBtn.disabled = true;
                deleteBtn.disabled = true;
            }
            item.appendChild(checkbox);
            item.appendChild(content);
            item.appendChild(actions);
            return item;
        }

        // --- Event Handlers & Initialisation ---

        // ... (updateFilterStatusUI, openDeleteModal, closeDeleteModal, openEditModal, closeEditModal tidak berubah) ...
        function updateFilterStatusUI(newStatus) {
            currentFilterStatus = newStatus;
            Object.keys(filterStatusBtns).forEach(status => {
                filterStatusBtns[status].classList.remove('filter-active');
                if (status === newStatus) {
                    filterStatusBtns[status].classList.add('filter-active');
                }
            });
            renderTasks(allTasksCache);
        }
        function openDeleteModal(id) {
            taskIdToDelete = id;
            deleteModal.classList.remove('hidden');
        }
        function closeDeleteModal() {
            deleteModal.classList.add('hidden');
            taskIdToDelete = null;
        }
        function openEditModal(id) {
            const task = allTasksCache.find(t => t.id === id);
            if (!task) return;
            taskIdToEdit = id;
            editTaskText.value = task.text;
            editDueDate.value = task.dueDate;
            editLocation.value = task.location;
            editModal.classList.remove('hidden');
        }
        function closeEditModal() {
            editModal.classList.add('hidden');
            taskIdToEdit = null;
        }


        /**
         * Inisialisasi Aplikasi dan Auth (Diperbarui)
         */
        async function initializeApp() {
            try {
                // (DIUBAH) Daftarkan Service Worker
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('./sw.js') // Pastikan path-nya benar
                            .then(registration => console.log('Service Worker registered:', registration.scope))
                            .catch(error => console.log('Service Worker registration failed:', error));
                    });
                }
                
                // (BARU) Minta izin notifikasi
                await requestNotificationPermission();

                // Setup Online/Offline Listeners
                window.addEventListener('online', () => updateOnlineStatus(true));
                window.addEventListener('offline', () => updateOnlineStatus(false));
                
                // Setup Dark Mode
                const isDarkMode = localStorage.getItem('darkMode') === 'true';
                if (isDarkMode) {
                    document.body.classList.add('dark');
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                } else {
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                }
                darkModeToggle.addEventListener('click', () => {
                    document.body.classList.toggle('dark');
                    const isDark = document.body.classList.contains('dark');
                    localStorage.setItem('darkMode', isDark);
                    sunIcon.classList.toggle('hidden');
                    moonIcon.classList.toggle('hidden');
                });

                // Setup Modal Listeners
                confirmDeleteBtn.addEventListener('click', () => {
                    if (taskIdToDelete) {
                        removeTask(taskIdToDelete); 
                        closeDeleteModal();
                    }
                });
                cancelDeleteBtn.addEventListener('click', closeDeleteModal);
                saveEditBtn.addEventListener('click', saveEditedTask); 
                cancelEditBtn.addEventListener('click', closeEditModal);
                
                // Setup Filter Status Listeners
                filterStatusBtns.all.addEventListener('click', () => updateFilterStatusUI('all'));
                filterStatusBtns.active.addEventListener('click', () => updateFilterStatusUI('active'));
                filterStatusBtns.completed.addEventListener('click', () => updateFilterStatusUI('completed'));
                
                // Setup Search Event Listener
                searchInput.addEventListener('input', () => { currentSearchTerm = searchInput.value; renderTasks(allTasksCache); });

                // Setup Tambah Tugas Event Listener
                addTaskBtn.addEventListener('click', addTask);
                taskInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !addTaskBtn.disabled) addTask();
                });
                
                // Validasi input
                [taskInput, dueDateInput, locationInput].forEach(input => {
                    input.addEventListener('input', validateInputs);
                });
                
                // Logika Muat Data
                loadFromStorage();
                renderTasks(allTasksCache);
                
                // (BARU) Periksa notifikasi saat aplikasi dimuat
                checkAndSendNotifications();

                updateOnlineStatus(navigator.onLine); 

                if (navigator.onLine && syncQueue.length === 0) {
                    await fetchTasks();
                } else if (!navigator.onLine) {
                    setLoading(false);
                    loadingIndicatorEl.textContent = 'Offline. Menampilkan data cache.';
                }

            } catch (error) {
                console.error("Kesalahan inisialisasi aplikasi:", error);
                showSyncStatus(`Error inisialisasi: ${error.message}`, true);
                addTaskBtn.disabled = true;
                setLoading(false);
            }
        }
        
        window.onload = initializeApp;

    </script>
</body>
</html>
