<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Tugas (Task List)</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Menggunakan font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937; /* Default text color (Light Mode fallback) */
            transition: background-color 0.3s, color 0.3s;
        }

        /* Dark Mode Styles */
        body.dark {
            background-color: #1f2937;
            color: #f3f4f6;
        }
        body.dark #app-container {
            background-color: #374151;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
        body.dark .border-gray-300 {
            border-color: #4b5563;
        }
        body.dark .bg-white {
            background-color: #4b5563;
        }
        body.dark .text-gray-700 {
            color: #d1d5db;
        }
        body.dark .hover:bg-gray-100:hover {
            background-color: #6b7280;
        }
        body.dark .text-blue-600 {
            color: #93c5fd;
        }
        body.dark .text-green-600 {
            color: #6ee7b7;
        }
        body.dark input[type="text"], body.dark input[type="date"] {
            background-color: #374151;
            color: #f3f4f6;
            border-color: #4b5563;
        }
    </style>
</head>
<body class="transition-colors duration-300">
    <div id="app-container" class="max-w-xl mx-auto mt-8 p-6 bg-white rounded-xl shadow-2xl transition-all duration-300">
        <h1 class="text-3xl font-bold mb-4 text-center text-gray-800 dark:text-gray-100">Daftar Tugas Saya</h1>

        <!-- Info Autentikasi -->
        <div id="auth-info" class="mb-4 text-center">
            <div id="auth-info-display" class="p-2 bg-blue-100 dark:bg-blue-900/50 rounded-lg text-xs text-blue-700 dark:text-blue-300">
                Memuat autentikasi...
                <span id="current-user-id" class="font-mono text-xs break-all"></span>
            </div>
        </div>

        <!-- Bagian Input Tugas Baru -->
        <div class="space-y-4 mb-6 p-4 border border-gray-200 dark:border-gray-700 rounded-lg shadow-inner bg-gray-50 dark:bg-gray-700/50">
            <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-100">Tambah Tugas Baru</h2>
            <input type="text" id="task-input" placeholder="Apa yang perlu Anda lakukan?" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-100">
            
            <div class="flex space-x-3">
                <input type="date" id="due-date-input" class="w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-100">
                <input type="text" id="location-input" placeholder="Lokasi (mis: Kantor, Rumah)" class="w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-100">
            </div>

            <button id="add-task-btn" disabled class="w-full p-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                Tambah Tugas
            </button>
            <div id="input-validation-message" class="text-sm text-red-500 mt-2 hidden">
                Harap isi kolom tugas dan tanggal jatuh tempo.
            </div>
        </div>

        <!-- Bagian Filter & Pencarian -->
        <div class="mb-6 space-y-3">
            <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-100">Filter & Pencarian</h2>
            
            <!-- Filter Tanggal -->
            <div class="flex space-x-2">
                <button id="filter-date-all" class="filter-date-btn px-4 py-2 text-sm bg-blue-500 text-white rounded-full transition duration-150 shadow-md hover:bg-blue-600" data-filter="all">Semua Tanggal</button>
                <button id="filter-date-today" class="filter-date-btn px-4 py-2 text-sm bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-full transition duration-150 hover:bg-gray-300 dark:hover:bg-gray-500" data-filter="today">Hari Ini</button>
                <button id="filter-date-week" class="filter-date-btn px-4 py-2 text-sm bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-full transition duration-150 hover:bg-gray-300 dark:hover:bg-gray-500" data-filter="week">Minggu Ini</button>
            </div>

            <!-- Pencarian -->
            <input type="text" id="search-input" placeholder="Cari tugas..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-100">
        </div>
        
        <!-- Daftar Tugas -->
        <div id="task-list" class="space-y-3">
            <!-- Tugas akan dimuat di sini -->
        </div>

        <!-- Status Loading -->
        <div id="loading-spinner" class="text-center mt-6 hidden">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8 mx-auto" style="border-top-color: #3b82f6;"></div>
            <p class="text-gray-500 mt-2">Memuat Tugas...</p>
        </div>

        <!-- Tombol Dark Mode -->
        <div class="mt-6 text-center">
            <button id="theme-toggle" class="p-2 text-gray-600 dark:text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 transition duration-150 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <span class="ml-1">Ganti Tema</span>
            </button>
        </div>
    </div>

    <script type="module">
        // Import Firebase dari CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variabel Global
        let db;
        let auth;
        let appId;
        let currentUserId;
        let allTasksCache = []; // Cache untuk semua tugas
        let currentFilterDate = 'all'; // 'all', 'today', 'week'
        let currentSearchTerm = '';
        let unsubscribeTasks = null; // Untuk menyimpan fungsi unsubscribe onSnapshot

        // Elemen DOM
        const taskListEl = document.getElementById('task-list');
        const taskInput = document.getElementById('task-input');
        const dueDateInput = document.getElementById('due-date-input');
        const locationInput = document.getElementById('location-input');
        const addTaskBtn = document.getElementById('add-task-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const authInfoDisplayEl = document.getElementById('auth-info-display');
        const currentUserIdEl = document.getElementById('current-user-id');
        const validationMessageEl = document.getElementById('input-validation-message');
        const searchInput = document.getElementById('search-input');
        
        const filterDateAllBtn = document.getElementById('filter-date-all');
        const filterDateTodayBtn = document.getElementById('filter-date-today');
        const filterDateWeekBtn = document.getElementById('filter-date-week');

        // ====================================================================
        // UTILITIES & TEMA
        // ====================================================================

        function setLoading(isLoading) {
            loadingSpinner.classList.toggle('hidden', !isLoading);
        }

        function initializeTheme() {
            const isDarkMode = localStorage.getItem('theme') === 'dark' || 
                                (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
            document.body.classList.toggle('dark', isDarkMode);
        }

        function toggleTheme() {
            const isDarkMode = document.body.classList.toggle('dark');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        }

        function getTodayDateString() {
            return new Date().toISOString().split('T')[0];
        }

        function getDateFromTimestamp(timestamp) {
            if (!timestamp) return null;
            // Firestore timestamps often come as objects with seconds/nanoseconds
            if (timestamp.seconds) {
                return new Date(timestamp.seconds * 1000).toISOString().split('T')[0];
            }
            return new Date(timestamp).toISOString().split('T')[0]; // Fallback for standard JS Date/String
        }

        function getStartOfWeek(date = new Date()) {
            const day = date.getDay(); // 0 for Sunday, 6 for Saturday
            const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Adjust for Monday start
            const startOfWeek = new Date(date.setDate(diff));
            startOfWeek.setHours(0, 0, 0, 0);
            return startOfWeek;
        }

        // ====================================================================
        // FIREBASE & AUTHENTICATION
        // ====================================================================

        async function initializeAppAndAuth() {
            try {
                // 1. Get Canvas Global Variables
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (!firebaseConfig.apiKey) {
                    throw new Error("Firebase config is missing or invalid.");
                }

                // 2. Initialize Firebase Services
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                // 3. Handle Authentication
                // Use Promise to wait for the initial auth state check to complete
                await new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe(); // Stop listening after the first state change
                        if (!user) {
                            // User not logged in (first load)
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                                    console.error("Error signing in with custom token:", e);
                                    return signInAnonymously(auth); // Fallback
                                });
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                        
                        // Set global references and user ID after successful auth
                        window.db = db;
                        window.auth = auth;
                        window.appId = appId;
                        currentUserId = auth.currentUser?.uid || 'anonymous';
                        
                        authInfoDisplayEl.className = 'p-2 bg-green-100 dark:bg-green-900/50 rounded-lg text-xs text-green-700 dark:text-green-300';
                        currentUserIdEl.textContent = currentUserId;

                        console.log("Firebase initialized. User ID:", currentUserId);

                        resolve();
                    }, (error) => {
                        console.error("Auth state change error:", error);
                        reject(error);
                    });
                });

                // 4. Lanjutkan inisialisasi aplikasi setelah autentikasi
                await setupAppListeners();

            } catch (error) {
                console.error("Kesalahan inisialisasi aplikasi:", error);
                authInfoDisplayEl.className = 'p-2 bg-red-100 dark:bg-red-900/50 rounded-lg text-xs text-red-700 dark:text-red-300';
                currentUserIdEl.textContent = `Error: ${error.message}`;
                addTaskBtn.disabled = true;
                setLoading(false);
            }
        }

        function getTaskCollectionRef() {
            if (!db || !currentUserId) {
                console.error("Firestore DB or User ID not initialized.");
                return null;
            }
            // Private data path: /artifacts/{appId}/users/{userId}/tasks
            return collection(db, `artifacts/${appId}/users/${currentUserId}/tasks`);
        }

        // ====================================================================
        // DATA ACCESS (CRUD)
        // ====================================================================

        async function fetchTasks() {
            setLoading(true);
            const tasksRef = getTaskCollectionRef();
            if (!tasksRef) {
                setLoading(false);
                return;
            }

            // Unsubscribe dari listener sebelumnya jika ada
            if (unsubscribeTasks) {
                unsubscribeTasks();
            }
            
            // Query Firestore - tidak menggunakan orderBy untuk menghindari error indexing
            const q = query(tasksRef);
            
            // Real-time listener
            unsubscribeTasks = onSnapshot(q, (snapshot) => {
                const tasks = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                // Sort data in memory by due date (descending completion, then ascending date)
                tasks.sort((a, b) => {
                    if (a.completed !== b.completed) {
                        return a.completed ? 1 : -1; // Completed items last
                    }
                    const dateA = getDateFromTimestamp(a.dueDate);
                    const dateB = getDateFromTimestamp(b.dueDate);
                    if (dateA < dateB) return -1;
                    if (dateA > dateB) return 1;
                    return 0;
                });
                
                allTasksCache = tasks;
                renderTasks(tasks);
                setLoading(false);
            }, (error) => {
                console.error("Error fetching tasks:", error);
                taskListEl.innerHTML = `<li class="text-red-500 text-center p-4">Gagal memuat tugas: ${error.message}.</li>`;
                setLoading(false);
            });
        }

        async function addTask() {
            const taskText = taskInput.value.trim();
            const dueDate = dueDateInput.value;
            const location = locationInput.value.trim();

            if (!taskText || !dueDate) {
                validationMessageEl.classList.remove('hidden');
                return;
            }
            validationMessageEl.classList.add('hidden');

            const newTask = {
                text: taskText,
                dueDate: new Date(dueDate),
                location: location || 'Umum',
                completed: false,
                createdAt: new Date(),
                // Tambahkan userId untuk kemudahan debugging (meskipun sudah ada di path koleksi)
                userId: currentUserId 
            };

            try {
                const tasksRef = getTaskCollectionRef();
                if (!tasksRef) return;
                
                await addDoc(tasksRef, newTask);
                
                // Reset input
                taskInput.value = '';
                dueDateInput.value = '';
                locationInput.value = '';
                addTaskBtn.disabled = true; // Nonaktifkan tombol setelah reset
            } catch (e) {
                console.error("Error adding document: ", e);
                showNotification(`Gagal menambahkan tugas: ${e.message}`, 'error');
            }
        }

        async function updateTask(taskId, updates) {
            try {
                const tasksRef = getTaskCollectionRef();
                if (!tasksRef) return;
                
                const taskDocRef = doc(tasksRef, taskId);
                await updateDoc(taskDocRef, updates);
            } catch (e) {
                console.error("Error updating document: ", e);
                showNotification(`Gagal memperbarui tugas: ${e.message}`, 'error');
            }
        }

        async function deleteTask(taskId) {
            try {
                const tasksRef = getTaskCollectionRef();
                if (!tasksRef) return;

                const taskDocRef = doc(tasksRef, taskId);
                await deleteDoc(taskDocRef);
            } catch (e) {
                console.error("Error deleting document: ", e);
                showNotification(`Gagal menghapus tugas: ${e.message}`, 'error');
            }
        }
        
        // ====================================================================
        // RENDER & FILTER UI
        // ====================================================================

        function showNotification(message, type = 'info') {
            const alertDiv = document.createElement('div');
            const baseClass = 'fixed bottom-5 left-1/2 transform -translate-x-1/2 p-4 rounded-lg shadow-xl z-50 text-white transition-opacity duration-300';
            const typeClass = type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            alertDiv.className = `${baseClass} ${typeClass}`;
            alertDiv.textContent = message;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.opacity = '0';
                setTimeout(() => alertDiv.remove(), 300);
            }, 3000);
        }

        function filterTasks(tasks) {
            let filtered = tasks;

            // 1. Filter Tanggal
            const todayStr = getTodayDateString();
            const startOfWeek = getStartOfWeek();
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6); // End of Sunday

            filtered = filtered.filter(task => {
                if (currentFilterDate === 'all') return true;
                
                const taskDateStr = getDateFromTimestamp(task.dueDate);
                if (!taskDateStr) return false;

                if (currentFilterDate === 'today') {
                    return taskDateStr === todayStr;
                }

                if (currentFilterDate === 'week') {
                    const taskDate = new Date(taskDateStr);
                    // Check if taskDate is between startOfWeek (inclusive) and endOfWeek (inclusive)
                    return taskDate >= startOfWeek && taskDate <= endOfWeek;
                }

                return true;
            });

            // 2. Filter Pencarian
            if (currentSearchTerm) {
                const searchLower = currentSearchTerm.toLowerCase();
                filtered = filtered.filter(task => 
                    task.text.toLowerCase().includes(searchLower) ||
                    task.location.toLowerCase().includes(searchLower) ||
                    getDateFromTimestamp(task.dueDate).includes(searchLower)
                );
            }

            return filtered;
        }

        function renderTasks(tasks) {
            taskListEl.innerHTML = '';
            
            const filteredTasks = filterTasks(tasks);

            if (filteredTasks.length === 0) {
                taskListEl.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 p-4">Tidak ada tugas yang ditemukan.</p>`;
                return;
            }

            filteredTasks.forEach(task => {
                const taskItem = document.createElement('div');
                const isCompleted = task.completed;
                const dueDateStr = getDateFromTimestamp(task.dueDate);

                // Styling berdasarkan status
                const completionClass = isCompleted ? 'opacity-60 line-through bg-green-50 dark:bg-green-900/30' : 'bg-white dark:bg-gray-800 hover:shadow-lg';
                
                // Styling untuk tanggal yang sudah lewat/hari ini
                const isOverdue = dueDateStr < getTodayDateString() && !isCompleted;
                const dateClass = isOverdue ? 'text-red-500 font-bold' : (dueDateStr === getTodayDateString() ? 'text-blue-500 font-bold' : 'text-gray-500 dark:text-gray-400');


                taskItem.className = `flex items-center p-4 border border-gray-200 dark:border-gray-700 rounded-xl shadow-md transition duration-200 ${completionClass}`;
                taskItem.dataset.taskId = task.id;

                taskItem.innerHTML = `
                    <input type="checkbox" ${isCompleted ? 'checked' : ''} class="task-checkbox h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:checked:bg-blue-500">
                    
                    <div class="flex-grow ml-4">
                        <p class="text-lg font-medium text-gray-800 dark:text-gray-100 break-words">${task.text}</p>
                        <div class="flex space-x-4 text-sm mt-1">
                            <span class="${dateClass}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                ${dueDateStr}
                            </span>
                            <span class="text-gray-500 dark:text-gray-400">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                ${task.location}
                            </span>
                        </div>
                    </div>
                    
                    <button class="delete-btn p-2 text-red-500 hover:text-red-700 dark:hover:text-red-300 rounded-full transition duration-150 ml-4 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;

                // Event listener for checkbox
                taskItem.querySelector('.task-checkbox').addEventListener('change', (e) => {
                    updateTask(task.id, { completed: e.target.checked });
                });

                // Event listener for delete button
                taskItem.querySelector('.delete-btn').addEventListener('click', () => {
                    deleteTask(task.id);
                });

                taskListEl.appendChild(taskItem);
            });
        }

        function updateFilterUI() {
            document.querySelectorAll('.filter-date-btn').forEach(btn => {
                if (btn.dataset.filter === currentFilterDate) {
                    btn.className = 'filter-date-btn px-4 py-2 text-sm bg-blue-500 text-white rounded-full transition duration-150 shadow-md hover:bg-blue-600';
                } else {
                    btn.className = 'filter-date-btn px-4 py-2 text-sm bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-full transition duration-150 hover:bg-gray-300 dark:hover:bg-gray-500';
                }
            });
            // Memanggil renderTasks untuk menerapkan filter baru pada cache data
            renderTasks(allTasksCache);
        }

        function validateInputs() {
            const taskText = taskInput.value.trim();
            const dueDate = dueDateInput.value;
            
            const isValid = taskText && dueDate;
            addTaskBtn.disabled = !isValid;
            validationMessageEl.classList.toggle('hidden', isValid);
        }

        // ====================================================================
        // INITIALIZATION & EVENT LISTENERS
        // ====================================================================

        async function setupAppListeners() {
            // 1. Theme Toggle
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

            // 2. Setup Filter Date Event Listeners
            filterDateAllBtn.addEventListener('click', () => { currentFilterDate = 'all'; updateFilterUI(); });
            filterDateTodayBtn.addEventListener('click', () => { currentFilterDate = 'today'; updateFilterUI(); });
            filterDateWeekBtn.addEventListener('click', () => { currentFilterDate = 'week'; updateFilterUI(); });

            // 3. Setup Search Event Listener
            searchInput.addEventListener('input', () => { 
                // Delay pencarian sedikit untuk performa yang lebih baik
                setTimeout(() => {
                    currentSearchTerm = searchInput.value; 
                    renderTasks(allTasksCache);
                }, 300);
            });

            // 4. Setup Tambah Tugas Event Listener
            addTaskBtn.addEventListener('click', addTask);
            taskInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !addTaskBtn.disabled) addTask();
            });
            
            // 5. Validasi input
            [taskInput, dueDateInput, locationInput].forEach(input => {
                input.addEventListener('input', validateInputs);
            });

            // 6. Ambil data awal dan set listener Firestore
            await fetchTasks();
        }
        
        // Atur tanggal jatuh tempo default ke hari ini
        dueDateInput.value = getTodayDateString();

        window.onload = () => {
            initializeTheme();
            initializeAppAndAuth();
        };

    </script>
</body>
</html>
