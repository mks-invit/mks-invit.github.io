<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIC - To Do List</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Menggunakan font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Dark Mode Styles */
        body.dark {
            background-color: #1f2937;
            color: #f3f4f6;
        }
        body.dark #app-container {
            background-color: #374151;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
        body.dark .border-gray-300 {
            border-color: #4b5563;
        }
        
        .task-list-item {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .task-list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }

        .completed-task .task-text {
            text-decoration: line-through;
            color: #9ca3af;
        }

        /* Scrollbar untuk daftar tugas */
        #taskList {
            max-height: 50vh; /* Setengah tinggi viewport */
            overflow-y: auto;
        }
        #taskList::-webkit-scrollbar {
            width: 8px;
        }
        #taskList::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
        body.dark #taskList::-webkit-scrollbar-thumb {
            background-color: #4b5563;
        }
        
        /* Style untuk tombol filter aktif */
        .filter-active {
            background-color: #10b981; /* emerald-500 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.5);
            transform: translateY(-1px);
        }

    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <div id="app-container" class="max-w-4xl mx-auto bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-xl transition-colors duration-300">
        
        <!-- Header dan Mode Gelap -->
        <header class="flex justify-between items-center mb-6 border-b border-gray-200 dark:border-gray-700 pb-4">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 dark:text-white">
                AIC - To Do List
            </h1>
            <button id="darkModeToggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-150" aria-label="Toggle Dark Mode">
                <svg id="sunIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="moonIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>

        <!-- Status Autentikasi/Loading -->
        <div id="authInfoDisplay" class="mb-4 p-2 bg-blue-100 dark:bg-blue-900/50 rounded-lg text-xs text-blue-700 dark:text-blue-300 transition-colors duration-300">
            <span id="loadingIndicator" class="animate-pulse">Memuat data dari Google Sheets...</span>
            <span id="currentUserId">Menggunakan Google Apps Script API.</span>
        </div>

        <!-- Form Input Tugas -->
        <div class="mb-8 p-4 border border-gray-200 dark:border-gray-700 rounded-xl shadow-inner dark:shadow-none bg-gray-50 dark:bg-gray-700/50">
            <h2 class="text-xl font-semibold mb-3 dark:text-gray-200">Tambah Tugas Baru</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                
                <div class="md:col-span-2">
                    <input type="text" id="taskInput" placeholder="Teks Tugas (Misal: Selesaikan laporan bulanan)" 
                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-800 dark:text-white transition duration-150" required>
                </div>

                <div>
                    <input type="date" id="dueDateInput" title="Batas Waktu" 
                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-800 dark:text-white transition duration-150">
                </div>

                <div>
                    <input type="text" id="locationInput" placeholder="Lokasi (Opsional)" title="Lokasi Tugas" 
                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-800 dark:text-white transition duration-150">
                </div>

                <div class="md:col-span-4">
                    <button id="addTaskBtn" disabled
                            class="w-full p-3 bg-emerald-500 text-white font-bold rounded-lg hover:bg-emerald-600 disabled:bg-gray-400 dark:disabled:bg-gray-600 transition duration-150 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-emerald-500/50">
                        Tambah Tugas
                    </button>
                </div>
            </div>
        </div>

        <!-- Bagian Filter dan Pencarian -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-3 dark:text-gray-200">Filter Tugas</h2>

            <!-- Filter Status -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button id="filterAllBtn" class="filter-btn p-2 text-sm font-medium rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-150 filter-active">Semua</button>
                <button id="filterActiveBtn" class="filter-btn p-2 text-sm font-medium rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-150">Aktif</button>
                <button id="filterCompletedBtn" class="filter-btn p-2 text-sm font-medium rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-150">Selesai</button>
            </div>
            
            <!-- Filter Tanggal dan Pencarian -->
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3">
                <button id="filterDateAllBtn" class="filter-date-btn p-2 text-sm font-medium rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-150 filter-active">Semua Waktu</button>
                <button id="filterDateTodayBtn" class="filter-date-btn p-2 text-sm font-medium rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-150">Hari Ini</button>
                <button id="filterDateWeekBtn" class="filter-date-btn p-2 text-sm font-medium rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-150">Minggu Ini</button>
                <input type="text" id="searchInput" placeholder="Cari Tugas/Lokasi..." 
                       class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-800 dark:text-white transition duration-150">
            </div>
        </div>

        <!-- Daftar Tugas -->
        <div id="taskList" class="space-y-3 pb-4">
            <!-- Tugas akan dirender di sini -->
            <div id="emptyState" class="text-center p-10 bg-gray-100 dark:bg-gray-700 rounded-xl text-gray-500 dark:text-gray-400">
                <p class="text-lg font-medium">Tidak ada tugas ditemukan.</p>
                <p>Coba tambahkan tugas baru atau sesuaikan filter Anda.</p>
            </div>
        </div>

        <!-- Modal Konfirmasi Hapus -->
        <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-md w-full">
                <h3 class="text-xl font-bold mb-4 dark:text-white">Konfirmasi Hapus</h3>
                <p class="mb-6 text-gray-700 dark:text-gray-300">Anda yakin ingin menghapus tugas ini secara permanen?</p>
                <div class="flex justify-end space-x-3">
                    <button id="cancelDeleteBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">Batal</button>
                    <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">Hapus</button>
                </div>
            </div>
        </div>

        <!-- Modal Edit Tugas -->
        <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-md w-full">
                <h3 class="text-xl font-bold mb-4 dark:text-white">Edit Tugas</h3>
                <div class="space-y-4">
                    <input type="text" id="editTaskText" placeholder="Teks Tugas" 
                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-white">
                    <input type="date" id="editDueDate" title="Batas Waktu" 
                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-white">
                    <input type="text" id="editLocation" placeholder="Lokasi (Opsional)" title="Lokasi Tugas" 
                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-white">
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button id="cancelEditBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">Batal</button>
                    <button id="saveEditBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">Simpan</button>
                </div>
            </div>
        </div>
        
    </div>

    <script>
        // --- KONFIGURASI API ---
        const MOCK_API_ENDPOINT = "https://script.google.com/macros/s/AKfycbxPu_354U8wzqYalUAKhvIaAGJqmZzM1bZYD9FQDsnuP0n4vmfFNQg6wxBuvzjEWffODw/exec";
        // --- AKHIR KONFIGURASI API ---

        // --- Variabel Global & Cache ---
        let allTasksCache = [];
        let currentFilterStatus = 'all'; // 'all', 'active', 'completed'
        let currentFilterDate = 'all'; // 'all', 'today', 'week'
        let currentSearchTerm = '';
        let taskIdToDelete = null;
        let taskIdToEdit = null;
        
        // --- Elemen DOM ---
        const taskListEl = document.getElementById('taskList');
        const emptyStateEl = document.getElementById('emptyState');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const taskInput = document.getElementById('taskInput');
        const dueDateInput = document.getElementById('dueDateInput');
        const locationInput = document.getElementById('locationInput');
        const searchInput = document.getElementById('searchInput');
        const loadingIndicatorEl = document.getElementById('loadingIndicator');
        const authInfoDisplayEl = document.getElementById('authInfoDisplay');
        const currentUserIdEl = document.getElementById('currentUserId');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');

        // Modal Elements
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const editModal = document.getElementById('editModal');
        const saveEditBtn = document.getElementById('saveEditBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const editTaskText = document.getElementById('editTaskText');
        const editDueDate = document.getElementById('editDueDate');
        const editLocation = document.getElementById('editLocation');

        // Filter Buttons
        const filterStatusBtns = {
            all: document.getElementById('filterAllBtn'),
            active: document.getElementById('filterActiveBtn'),
            completed: document.getElementById('filterCompletedBtn')
        };
        const filterDateBtns = {
            all: document.getElementById('filterDateAllBtn'),
            today: document.getElementById('filterDateTodayBtn'),
            week: document.getElementById('filterDateWeekBtn')
        };

        // --- Helper Functions ---

        /**
         * Mengatur status loading aplikasi
         * @param {boolean} isLoading 
         */
        function setLoading(isLoading) {
            if (isLoading) {
                loadingIndicatorEl.textContent = 'Memuat...';
                addTaskBtn.disabled = true;
                taskListEl.classList.add('opacity-50');
            } else {
                loadingIndicatorEl.textContent = '';
                validateInputs(); // Re-enable button if inputs are valid
                taskListEl.classList.remove('opacity-50');
            }
        }

        /**
         * Panggilan API dengan mekanisme retry. Digunakan untuk POST.
         * @param {object} payload Data yang akan dikirim (termasuk 'action', 'id', 'data', dll.).
         * @returns {Promise<object>} Respon JSON dari Apps Script.
         */
        async function apiCall(payload) {
            setLoading(true);
            const maxRetries = 3;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(MOCK_API_ENDPOINT, {
                        method: 'POST',
                        // Menghapus header 'Content-Type: application/json' untuk mempermudah CORS dengan GAS
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();

                    if (response.ok && data.status === 'success') {
                        setLoading(false);
                        return data;
                    } else {
                        // Ini adalah error yang berasal dari Apps Script
                        const errorMessage = data.message || `Apps Script Error: Status ${response.status}`;
                        throw new Error(errorMessage);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        setLoading(false);
                        // Lempar error jika ini adalah percobaan terakhir
                        throw new Error(`Gagal berinteraksi dengan API setelah ${maxRetries} kali coba: ${error.message}`);
                    }
                    // Logging dan Backoff
                    console.warn(`Fetch attempt ${i + 1} failed: ${error.message}. Retrying...`);
                    const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Mengubah format tanggal menjadi YYYY-MM-DD.
         * @param {Date} dateObj 
         * @returns {string} Tanggal dalam format string YYYY-MM-DD.
         */
        function formatDate(dateObj) {
            if (!dateObj || dateObj.toString() === 'Invalid Date') return '';
            const d = new Date(dateObj);
            // Tambahkan padding nol jika angka < 10
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        /**
         * Membandingkan tanggal (hanya bagian hari, bulan, tahun).
         * @param {Date|string} d1 
         * @param {Date|string} d2 
         * @returns {boolean} True jika tanggal sama.
         */
        function isSameDay(d1, d2) {
            const date1 = new Date(d1);
            const date2 = new Date(d2);
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }

        /**
         * Menghitung tanggal seminggu dari sekarang.
         * @returns {Date}
         */
        function getOneWeekFromNow() {
            const now = new Date();
            const oneWeek = new Date(now);
            oneWeek.setDate(now.getDate() + 7);
            return oneWeek;
        }

        /**
         * Memastikan input teks tugas tidak kosong.
         */
        function validateInputs() {
            addTaskBtn.disabled = taskInput.value.trim() === "";
        }

        // --- CRUD & API Interaksi ---

        /**
         * Mengambil semua tugas dari Google Sheets via Apps Script API.
         */
        async function fetchTasks() {
            setLoading(true);
            const maxRetries = 3;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    // Gunakan GET dengan parameter action=read
                    const response = await fetch(MOCK_API_ENDPOINT + '?action=read');
                    const result = await response.json();

                    if (response.ok && result.status === 'success') {
                        // Mapping dan normalisasi data dari Sheets
                        allTasksCache = result.data.map(task => ({
                            id: task.id.toString(),
                            text: task.text,
                            dueDate: task.dueDate ? formatDate(task.dueDate) : '',
                            location: task.location || '',
                            completed: task.completed === true || task.completed === 'TRUE', // Menangani konversi tipe
                            createdAt: task.createdAt // Biarkan seperti adanya
                        }));
                        renderTasks(allTasksCache);
                        setLoading(false);
                        return; // Berhasil, keluar dari loop
                    } else {
                        throw new Error(result.message || 'Gagal mengambil data tugas.');
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        setLoading(false);
                        console.error("Error fetching tasks:", error);
                        authInfoDisplayEl.textContent = `Gagal memuat data: ${error.message}`;
                        return; // Gagal, keluar dari loop
                    }
                    console.warn(`Fetch attempt ${i + 1} failed: ${error.message}. Retrying...`);
                    const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Menambah tugas baru ke Google Sheets.
         */
        async function addTask() {
            const text = taskInput.value.trim();
            const dueDate = dueDateInput.value || '';
            const location = locationInput.value.trim() || '';

            if (text === "") return;

            const newTask = {
                id: Date.now().toString(), // ID unik menggunakan timestamp
                text: text,
                dueDate: dueDate,
                location: location,
                completed: false,
                createdAt: new Date().toISOString()
            };

            try {
                // Panggil API untuk menambahkan tugas
                await apiCall({
                    action: "add",
                    data: newTask
                });
                
                // Refresh data setelah berhasil
                await fetchTasks();

                // Bersihkan input
                taskInput.value = '';
                dueDateInput.value = '';
                locationInput.value = '';
                validateInputs();

            } catch (error) {
                // Kesalahan ditangani di apiCall
            }
        }

        /**
         * Mengubah status 'completed' tugas di Sheets.
         * @param {string} id ID tugas.
         */
        async function toggleTask(id) {
            const task = allTasksCache.find(t => t.id === id);
            if (!task) return;

            const newCompletedStatus = !task.completed;

            try {
                // Panggil API untuk update status
                await apiCall({
                    action: "update",
                    id: id,
                    updates: {
                        completed: newCompletedStatus // Kirim nilai boolean
                    }
                });

                // Update cache lokal
                task.completed = newCompletedStatus;
                
                // Re-render daftar tugas
                renderTasks(allTasksCache);

            } catch (error) {
                // Kesalahan ditangani di apiCall
            }
        }

        /**
         * Menghapus tugas dari Sheets.
         * @param {string} id ID tugas.
         */
        async function removeTask(id) {
            try {
                // Panggil API untuk menghapus tugas
                await apiCall({
                    action: "delete",
                    id: id
                });
                
                // Refresh data setelah berhasil
                await fetchTasks();

            } catch (error) {
                // Kesalahan ditangani di apiCall
            }
        }
        
        /**
         * Menyimpan perubahan tugas (dari modal edit) ke Sheets.
         */
        async function saveEditedTask() {
            const id = taskIdToEdit;
            if (!id) return;
            
            const newText = editTaskText.value.trim();
            const newDueDate = editDueDate.value || '';
            const newLocation = editLocation.value.trim() || '';

            if (newText === "") {
                alert("Teks tugas tidak boleh kosong.");
                return;
            }

            try {
                // Panggil API untuk update detail tugas
                await apiCall({
                    action: "update",
                    id: id,
                    updates: {
                        text: newText,
                        dueDate: newDueDate,
                        location: newLocation
                    }
                });

                // Refresh data setelah berhasil
                await fetchTasks();

                // Tutup modal
                editModal.classList.add('hidden');
                taskIdToEdit = null;

            } catch (error) {
                // Kesalahan ditangani di apiCall
            }
        }
        
        // --- Filtering dan Rendering ---

        /**
         * Menerapkan filter dan merender daftar tugas.
         * @param {Array<object>} tasks 
         */
        function renderTasks(tasks) {
            // 1. Filter berdasarkan status
            let filteredTasks = tasks.filter(task => {
                if (currentFilterStatus === 'active') return !task.completed;
                if (currentFilterStatus === 'completed') return task.completed;
                return true; // 'all'
            });

            // 2. Filter berdasarkan tanggal
            const now = new Date();
            const oneWeekFromNow = getOneWeekFromNow();
            
            filteredTasks = filteredTasks.filter(task => {
                if (currentFilterDate === 'today') {
                    if (!task.dueDate) return false;
                    return isSameDay(task.dueDate, now);
                }
                if (currentFilterDate === 'week') {
                    if (!task.dueDate) return false;
                    const dueDate = new Date(task.dueDate);
                    // Filter antara hari ini (inklusif) dan seminggu dari sekarang (eksklusif)
                    return dueDate >= new Date(formatDate(now)) && dueDate < oneWeekFromNow;
                }
                return true; // 'all'
            });


            // 3. Filter berdasarkan pencarian
            const searchTerm = currentSearchTerm.toLowerCase();
            if (searchTerm) {
                filteredTasks = filteredTasks.filter(task => 
                    task.text.toLowerCase().includes(searchTerm) || 
                    task.location.toLowerCase().includes(searchTerm)
                );
            }

            // 4. Urutkan: Tugas aktif yang jatuh tempo lebih dulu di atas
            filteredTasks.sort((a, b) => {
                // Tugas yang belum selesai selalu di atas yang sudah selesai
                if (a.completed !== b.completed) {
                    return a.completed ? 1 : -1;
                }

                // Setelah itu, urutkan berdasarkan tanggal jatuh tempo (paling cepat duluan)
                const dateA = a.dueDate ? new Date(a.dueDate).getTime() : Infinity;
                const dateB = b.dueDate ? new Date(b.dueDate).getTime() : Infinity;
                return dateA - dateB;
            });

            // 5. Render
            taskListEl.innerHTML = '';
            
            if (filteredTasks.length === 0) {
                emptyStateEl.classList.remove('hidden');
            } else {
                emptyStateEl.classList.add('hidden');
                
                filteredTasks.forEach(task => {
                    const taskEl = createTaskElement(task);
                    taskListEl.appendChild(taskEl);
                });
            }
        }

        /**
         * Membuat elemen DOM untuk satu tugas.
         * @param {object} task Objek tugas.
         * @returns {HTMLElement} Elemen list item.
         */
        function createTaskElement(task) {
            const item = document.createElement('div');
            item.className = `task-list-item flex items-center p-4 border border-gray-200 dark:border-gray-700 rounded-xl shadow-sm hover:shadow-md transition-all duration-200 ${task.completed ? 'completed-task bg-gray-100 dark:bg-gray-700/70' : 'bg-white dark:bg-gray-800'}`;
            item.setAttribute('data-id', task.id);

            const isDueToday = task.dueDate && isSameDay(task.dueDate, new Date());
            
            // Checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = task.completed;
            checkbox.className = 'w-5 h-5 text-emerald-600 bg-gray-100 border-gray-300 rounded focus:ring-emerald-500 dark:focus:ring-emerald-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600 mr-4 flex-shrink-0';
            checkbox.onclick = (e) => {
                e.stopPropagation();
                toggleTask(task.id);
            };

            // Task Content
            const content = document.createElement('div');
            content.className = 'flex-grow min-w-0';

            const text = document.createElement('p');
            text.className = `task-text font-medium text-lg truncate ${task.completed ? 'text-gray-500' : 'dark:text-white'}`;
            text.textContent = task.text;
            content.appendChild(text);

            const meta = document.createElement('div');
            meta.className = 'flex flex-wrap items-center text-sm mt-1 text-gray-500 dark:text-gray-400';

            // Due Date
            if (task.dueDate) {
                const dateText = document.createElement('span');
                dateText.className = `mr-3 flex items-center ${isDueToday && !task.completed ? 'text-red-500 font-semibold' : ''}`;
                dateText.innerHTML = `<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                      ${task.dueDate}${isDueToday ? ' (Hari Ini!)' : ''}`;
                meta.appendChild(dateText);
            }

            // Location
            if (task.location) {
                const locationText = document.createElement('span');
                locationText.className = 'mr-3 flex items-center';
                locationText.innerHTML = `<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.243-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                          ${task.location}`;
                meta.appendChild(locationText);
            }
            
            content.appendChild(meta);
            
            // Action Buttons Container
            const actions = document.createElement('div');
            actions.className = 'flex-shrink-0 ml-4 space-x-2 flex';

            // Edit Button
            const editBtn = document.createElement('button');
            editBtn.className = 'p-2 rounded-full text-blue-500 hover:bg-blue-100 dark:hover:bg-gray-700 transition duration-150';
            editBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7 1l-2 2L18 9l2-2 2.585 2.585zm1.414-2.586a2 2 0 012.828 0l2.586 2.586a2 2 0 010 2.828l-10.4 10.4L5 19l2.828-2.828 10.4-10.4z"></path></svg>`;
            editBtn.title = "Edit Tugas";
            editBtn.onclick = (e) => {
                e.stopPropagation();
                openEditModal(task.id);
            };

            // Delete Button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'p-2 rounded-full text-red-500 hover:bg-red-100 dark:hover:bg-gray-700 transition duration-150';
            deleteBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
            deleteBtn.title = "Hapus Tugas";
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                openDeleteModal(task.id);
            };

            actions.appendChild(editBtn);
            actions.appendChild(deleteBtn);

            item.appendChild(checkbox);
            item.appendChild(content);
            item.appendChild(actions);

            return item;
        }

        // --- Event Handlers & Initialisation ---

        /**
         * Mengubah tampilan tombol filter status.
         * @param {string} newStatus 'all', 'active', atau 'completed'
         */
        function updateFilterStatusUI(newStatus) {
            currentFilterStatus = newStatus;
            Object.keys(filterStatusBtns).forEach(status => {
                filterStatusBtns[status].classList.remove('filter-active');
                if (status === newStatus) {
                    filterStatusBtns[status].classList.add('filter-active');
                }
            });
            renderTasks(allTasksCache);
        }

        /**
         * Mengubah tampilan tombol filter tanggal.
         * @param {string} newDateFilter 'all', 'today', atau 'week'
         */
        function updateFilterDateUI(newDateFilter) {
            currentFilterDate = newDateFilter;
            Object.keys(filterDateBtns).forEach(dateFilter => {
                filterDateBtns[dateFilter].classList.remove('filter-active');
                if (dateFilter === newDateFilter) {
                    filterDateBtns[dateFilter].classList.add('filter-active');
                }
            });
            renderTasks(allTasksCache);
        }

        // --- Modal Logic ---
        
        function openDeleteModal(id) {
            taskIdToDelete = id;
            deleteModal.classList.remove('hidden');
        }

        function closeDeleteModal() {
            deleteModal.classList.add('hidden');
            taskIdToDelete = null;
        }

        function openEditModal(id) {
            const task = allTasksCache.find(t => t.id === id);
            if (!task) return;
            
            taskIdToEdit = id;
            editTaskText.value = task.text;
            editDueDate.value = task.dueDate;
            editLocation.value = task.location;

            editModal.classList.remove('hidden');
        }

        function closeEditModal() {
            editModal.classList.add('hidden');
            taskIdToEdit = null;
        }


        /**
         * Inisialisasi Aplikasi dan Auth
         */
        async function initializeApp() {
            try {
                // 1. Setup Dark Mode
                const isDarkMode = localStorage.getItem('darkMode') === 'true';
                if (isDarkMode) {
                    document.body.classList.add('dark');
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                } else {
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                }
                
                darkModeToggle.addEventListener('click', () => {
                    document.body.classList.toggle('dark');
                    const isDark = document.body.classList.contains('dark');
                    localStorage.setItem('darkMode', isDark);
                    sunIcon.classList.toggle('hidden');
                    moonIcon.classList.toggle('hidden');
                });

                // 2. Setup Modal Listeners
                confirmDeleteBtn.addEventListener('click', () => {
                    if (taskIdToDelete) {
                        removeTask(taskIdToDelete);
                        closeDeleteModal();
                    }
                });
                cancelDeleteBtn.addEventListener('click', closeDeleteModal);
                saveEditBtn.addEventListener('click', saveEditedTask);
                cancelEditBtn.addEventListener('click', closeEditModal);
                
                // 3. Setup Filter Status Listeners
                filterStatusBtns.all.addEventListener('click', () => updateFilterStatusUI('all'));
                filterStatusBtns.active.addEventListener('click', () => updateFilterStatusUI('active'));
                filterStatusBtns.completed.addEventListener('click', () => updateFilterStatusUI('completed'));

                // 4. Setup Filter Date Listeners
                filterDateBtns.all.addEventListener('click', () => updateFilterDateUI('all'));
                filterDateBtns.today.addEventListener('click', () => updateFilterDateUI('today'));
                filterDateBtns.week.addEventListener('click', () => updateFilterDateUI('week'));

                // 5. Setup Search Event Listener
                searchInput.addEventListener('input', () => { currentSearchTerm = searchInput.value; renderTasks(allTasksCache); });

                // 6. Setup Tambah Tugas Event Listener
                addTaskBtn.addEventListener('click', addTask);
                taskInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !addTaskBtn.disabled) addTask();
                });
                
                // 7. Validasi input
                [taskInput, dueDateInput, locationInput].forEach(input => {
                    input.addEventListener('input', validateInputs);
                });

                // 8. Ambil data awal
                await fetchTasks();

            } catch (error) {
                console.error("Kesalahan inisialisasi aplikasi:", error);
                authInfoDisplayEl.className = 'p-2 bg-red-100 dark:bg-red-900/50 rounded-lg text-xs text-red-700 dark:text-red-300';
                currentUserIdEl.textContent = `Error inisialisasi: ${error.message}`;
                addTaskBtn.disabled = true;
                setLoading(false);
            }
        }
        
        window.onload = initializeApp;

    </script>
</body>
</html>
